<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Marshall&#39;s Blog">
<meta property="og:url" content="https://marshallgong.top/index.html">
<meta property="og:site_name" content="Marshall&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Marshall Gong">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://marshallgong.top/"/>





  <title>Marshall's Blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Marshall's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/2021/09/25/rt-dev1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/09/25/rt-dev1/" itemprop="url">rt-dev1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-25T10:45:45+08:00">
                2021-09-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/09/25/rt-dev1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/09/25/rt-dev1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          密码：123456
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/09/25/rt-dev1/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/2021/09/25/rt-dev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/09/25/rt-dev/" itemprop="url">rt-dev</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-25T10:45:45+08:00">
                2021-09-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/09/25/rt-dev/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/09/25/rt-dev/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MWAN3"><a href="#MWAN3" class="headerlink" title="MWAN3"></a>MWAN3</h1><ul>
<li><p>route</p>
<p>对于table 1的走brwan,对于table 2的走wwan0</p>
</li>
</ul>
<blockquote>
<p>root@LBR20:/# ip route list table all<br>default via 192.168.1.1 dev brwan  table 1<br>default via 100.112.102.96 dev wwan0  table 2<br>default via 192.168.1.1 dev brwan<br>default via 100.112.102.96 dev wwan0  metric 20<br>10.0.0.0/24 dev br0  proto kernel  scope link  src 10.0.0.1<br>10.0.1.0/24 dev tun0  proto kernel  scope link  src 10.0.1.1<br>100.112.102.64/26 dev wwan0  proto kernel  scope link  src 100.112.102.95<br>192.168.1.0/24 dev brwan  proto kernel  scope link  src 192.168.1.3<br>broadcast 10.0.0.0 dev br0  table local  proto kernel  scope link  src 10.0.0.1<br>local 10.0.0.1 dev br0  table local  proto kernel  scope host  src 10.0.0.1<br>broadcast 10.0.0.255 dev br0  table local  proto kernel  scope link  src 10.0.0.1<br>broadcast 10.0.1.0 dev tun0  table local  proto kernel  scope link  src 10.0.1.1<br>local 10.0.1.1 dev tun0  table local  proto kernel  scope host  src 10.0.1.1<br>broadcast 10.0.1.255 dev tun0  table local  proto kernel  scope link  src 10.0.1.1<br>broadcast 100.112.102.64 dev wwan0  table local  proto kernel  scope link  src 100.112.102.95<br>local 100.112.102.95 dev wwan0  table local  proto kernel  scope host  src 100.112.102.95<br>broadcast 100.112.102.127 dev wwan0  table local  proto kernel  scope link  src 100.112.102.95<br>broadcast 127.0.0.0 dev lo  table local  proto kernel  scope link  src 127.0.0.1<br>local 127.0.0.0/8 dev lo  table local  proto kernel  scope host  src 127.0.0.1<br>local 127.0.0.1 dev lo  table local  proto kernel  scope host  src 127.0.0.1<br>broadcast 127.255.255.255 dev lo  table local  proto kernel  scope link  src 127.0.0.1<br>broadcast 192.168.1.0 dev brwan  table local  proto kernel  scope link  src 192.168.1.3<br>local 192.168.1.3 dev brwan  table local  proto kernel  scope host  src 192.168.1.3<br>broadcast 192.168.1.255 dev brwan  table local  proto kernel  scope link  src 192.168.1.3<br>fe80::/64 dev eth1  proto kernel  metric 256<br>fe80::/64 dev br0  proto kernel  metric 256<br>fe80::/64 dev ath0  proto kernel  metric 256<br>fe80::/64 dev tap0  proto kernel  metric 256<br>fe80::/64 dev ath2  proto kernel  metric 256<br>fe80::/64 dev ath11  proto kernel  metric 256<br>fe80::/64 dev ath01  proto kernel  metric 256<br>fe80::/64 dev ath1  proto kernel  metric 256<br>fe80::/64 dev eth0  proto kernel  metric 256<br>fe80::/64 dev brwan  proto kernel  metric 256<br>fe80::/64 dev wwan0  proto kernel  metric 256<br>unreachable default dev lo  table unspec  proto kernel  metric 4294967295  error -101<br>local ::1 dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80:: dev lo  table local  proto none  metric 0<br>local fe80::2c14:a8ff:fe61:570c dev lo  table local  proto none  metric 0<br>local fe80::9088:25ff:fe0a:98a1 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d14 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d14 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d15 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d15 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d16 dev lo  table local  proto none  metric 0<br>local fe80::bea5:11ff:fe9c:4d17 dev lo  table local  proto none  metric 0<br>local fe80::c0a5:11ff:fe9c:4d14 dev lo  table local  proto none  metric 0<br>local fe80::c0a5:11ff:fe9c:4d16 dev lo  table local  proto none  metric 0<br>local fe80::c4a5:11ff:fe9c:4d14 dev lo  table local  proto none  metric 0<br>ff00::/8 dev eth1  table local  metric 256<br>ff00::/8 dev br0  table local  metric 256<br>ff00::/8 dev ath0  table local  metric 256<br>ff00::/8 dev tap0  table local  metric 256<br>ff00::/8 dev ath2  table local  metric 256<br>ff00::/8 dev ath11  table local  metric 256<br>ff00::/8 dev ath01  table local  metric 256<br>ff00::/8 dev ath1  table local  metric 256<br>ff00::/8 dev eth0  table local  metric 256<br>ff00::/8 dev brwan  table local  metric 256<br>ff00::/8 dev wwan0  table local  metric 256<br>unreachable default dev lo  table unspec  proto kernel  metric 4294967295  error -101</p>
</blockquote>
<p>上面的规则由下面命令生成</p>
<blockquote>
<p>usr/sbin/ip -4 route flush table 1<br>                        [ ifup == ifup ]<br>                            /usr/sbin/ip -4 route add table 1 default via 192.168.1.1 dev brwan</p>
<ul>
<li>/usr/sbin/ip -4 route flush table 2<pre><code>+ [ ifup == ifup ]
        + /usr/sbin/ip -4 route add table 2 default via 100.112.102.96 dev wwan0
</code></pre>
</li>
</ul>
</blockquote>
<ul>
<li><p>rule</p>
<p>route指定了走哪个表，而rule则什么属于table1,什么属于table2。</p>
<blockquote>
<p>root@LBR20:/# ip rule list<br>0:      from all lookup local<br>1001:   from all iif brwan lookup main<br>1002:   from all iif wwan0 lookup main<br>2001:   from all fwmark 0x100/0xff00 lookup 1<br>2002:   from all fwmark 0x200/0xff00 lookup 2<br>2253:   from all fwmark 0xfd00/0xff00 blackhole<br>2254:   from all fwmark 0xfe00/0xff00 unreachable<br>32766:  from all lookup main<br>32767:  from all lookup default</p>
</blockquote>
<p>可以看到fwmark 0x100走lookup 1, fwmark 0x200 lookup 2,这两个表如下</p>
<blockquote>
<p>root@LBR20:/# ip route list table 1<br>default via 192.168.1.1 dev brwan<br>root@LBR20:/# ip route list table 2<br>default via 100.115.169.108 dev wwan0</p>
</blockquote>
<p>命令如下</p>
<blockquote>
<ul>
<li>/usr/sbin/ip -4 rule list<pre><code>awk $1 == &quot;1001:&quot;
                        [ -n  ]
                          /usr/sbin/ip -4 rule list
                          awk $1 == &quot;2001:&quot;
                        [ -n  ]
                          [ ifup == ifup ]
                          /usr/sbin/ip -4 rule add pref 1001 iif brwan lookup main
                        [ ifup == ifup ]
                          /usr/sbin/ip -4 rule add pref 2001 fwmark 256/0xff00 lookup 1    
</code></pre>
</li>
<li>/usr/sbin/ip -4 rule list<pre><code>+ awk $1 == &quot;1002:&quot;
        + [ -n  ]
        + /usr/sbin/ip -4 rule list
        + awk $1 == &quot;2002:&quot;
        + [ -n  ]
        + [ ifup == ifup ]
        + /usr/sbin/ip -4 rule add pref 1002 iif wwan0 lookup main
        + [ ifup == ifup ]
        + /usr/sbin/ip -4 rule add pref 2002 fwmark 512/0xff00 lookup 2
</code></pre>
</li>
</ul>
</blockquote>
<p>perf是优先级，数值越大优先级越低</p>
<p>那么现在就是fwmark 256(0x100) 512(0x200)的设定了</p>
<blockquote>
<ul>
<li>probability=-m statistic –mode random –probability 0.200<pre><code>+ &lt;mark&gt;/usr/sbin/iptables -t mangle -w -I mwan3_policy_balanced -m mark --mark 0x0/0xff00 -m statistic --mode random --probability 0.200 -m comment --comment wan2 20 100 -j MARK --set-xmark 512/0xff00&lt;/mark&gt;
                + /usr/sbin/iptables -t mangle -w -I mwan3_policy_balanced -p udp -m multiport --sports 0:65535 -m multiport --dports 53,80,443 -m comment --comment web_udp_rule -j MARK --set-xmark 0xff00/0xff00
                + /usr/sbin/iptables -t mangle -w -I mwan3_policy_balanced -p tcp -m multiport --sports 0:65535 -m multiport --dports 53,80,443,8443 -m comment --comment web_tcp_rule -j MARK --set-xmark 0xff00/0xff00
                + /usr/sbin/iptables -t mangle -w -F mwan3_output_policy_balanced
</code></pre>
</li>
</ul>
</blockquote>
<p>对于–set 512/0xff00的概率是%20，对于目的端口为53，80，443，8443的则打0xff的mark，那么其它的都会打256 mark,因此实现20%走wwan0, 80%走brwan。</p>
</li>
</ul>
<h1 id="data-usage"><a href="#data-usage" class="headerlink" title="data-usage"></a>data-usage</h1><p>data usage</p>
<ul>
<li><p>binary to hex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">bin2hex</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *bin, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>   *out;</span><br><span class="line">	<span class="keyword">size_t</span>  i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bin == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	out = <span class="built_in">malloc</span>(len*<span class="number">2</span>+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">		out[i*<span class="number">2</span>]   = <span class="string">&quot;0123456789ABCDEF&quot;</span>[bin[i] &gt;&gt; <span class="number">4</span>];</span><br><span class="line">		out[i*<span class="number">2</span>+<span class="number">1</span>] = <span class="string">&quot;0123456789ABCDEF&quot;</span>[bin[i] &amp; <span class="number">0x0F</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	out[len*<span class="number">2</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分配一个该字符串 两倍长度的数组</p>
<p>“012345678ABCDEF”[index], 这相当于一个常量数组，可以通过index来访问这个字符串中的某个字符。</p>
<p>unsigned char 为8bits, 将其分为两部分，每个部分为0-15，右移4则取高4位，&amp;0x0F则取低四位。</p>
</li>
<li><p>Hex to binary</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hexchr2bin</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> hex, <span class="keyword">char</span> *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (out == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hex &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; hex &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">		*out = hex - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (hex &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; hex &lt;= <span class="string">&#x27;F&#x27;</span>) &#123;</span><br><span class="line">		*out = hex - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (hex &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; hex &lt;= <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">		*out = hex - <span class="string">&#x27;a&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">hexs2bin</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *hex, <span class="keyword">unsigned</span> <span class="keyword">char</span> **out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> len;</span><br><span class="line">	<span class="keyword">char</span>   b1;</span><br><span class="line">	<span class="keyword">char</span>   b2;</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hex == <span class="literal">NULL</span> || *hex == <span class="string">&#x27;\0&#x27;</span> || out == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	len = <span class="built_in">strlen</span>(hex);</span><br><span class="line">	<span class="keyword">if</span> (len % <span class="number">2</span> != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	len /= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	*out = <span class="built_in">malloc</span>(len);</span><br><span class="line">	<span class="built_in">memset</span>(*out, <span class="string">&#x27;A&#x27;</span>, len);</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!hexchr2bin(hex[i*<span class="number">2</span>], &amp;b1) || !hexchr2bin(hex[i*<span class="number">2</span>+<span class="number">1</span>], &amp;b2)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		(*out)[i] = (b1 &lt;&lt; <span class="number">4</span>) | b2;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先将一个0-F的16进制转换为10进制的值，然后再将两个4bits合并成一个8bits的值。</p>
</li>
<li><p>b64 encode</p>
<ul>
<li>Binary to base64</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> b64chars[] = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"><span class="comment">/* 以3位单位补齐源字符串长度后，除以3乘以4 */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">b64_encoded_size</span><span class="params">(<span class="keyword">size_t</span> inlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = inlen;</span><br><span class="line">	<span class="keyword">if</span> (inlen % <span class="number">3</span> != <span class="number">0</span>)</span><br><span class="line">		ret += <span class="number">3</span> - (inlen % <span class="number">3</span>);</span><br><span class="line">	ret /= <span class="number">3</span>;</span><br><span class="line">	ret *= <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">b64_encode</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>   *out;</span><br><span class="line">	<span class="keyword">size_t</span>  elen;</span><br><span class="line">	<span class="keyword">size_t</span>  i;</span><br><span class="line">	<span class="keyword">size_t</span>  j;</span><br><span class="line">	<span class="keyword">size_t</span>  v;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (in == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	elen = b64_encoded_size(len);</span><br><span class="line">	out  = <span class="built_in">malloc</span>(elen+<span class="number">1</span>);</span><br><span class="line">	out[elen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>, j=<span class="number">0</span>; i&lt;len; i+=<span class="number">3</span>, j+=<span class="number">4</span>) &#123;</span><br><span class="line">		v = in[i];</span><br><span class="line">		v = i+<span class="number">1</span> &lt; len ? v &lt;&lt; <span class="number">8</span> | in[i+<span class="number">1</span>] : v &lt;&lt; <span class="number">8</span>;</span><br><span class="line">		v = i+<span class="number">2</span> &lt; len ? v &lt;&lt; <span class="number">8</span> | in[i+<span class="number">2</span>] : v &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">		out[j]   = b64chars[(v &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">		out[j+<span class="number">1</span>] = b64chars[(v &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">		<span class="keyword">if</span> (i+<span class="number">1</span> &lt; len) &#123;</span><br><span class="line">			out[j+<span class="number">2</span>] = b64chars[(v &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			out[j+<span class="number">2</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (i+<span class="number">2</span> &lt; len) &#123;</span><br><span class="line">			out[j+<span class="number">3</span>] = b64chars[v &amp; <span class="number">0x3F</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			out[j+<span class="number">3</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> out; ab</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从Base64编码的原理可以看到，Base64实际上就是把原来数据中的每3个字节一组进行Base64编码转换，编码之后变成4个Base64字符。但是如果原文数据长度不是3的整数倍的时候该怎么办呢？Base64算法规定，如果待加密数据不是3的整数倍，就在原文数据后面补0，直到长度凑够3的整数倍为止，然后再进行Base64编码转换。待编码转换完成之后，在结果末尾补充相同个数的”=”。<br>例如，将字符串”ABCD”进行Base64编码流程如下。</p>
<pre><code>使用ASCII编码方式将&quot;ABC&quot;转换成二进制 01000001 | 01000010 | 01000011 | 01000100
将步骤1的二进制数据进行分组，由于数据长度是4个字节，不是3的整数倍，无法直接进行分组，所以分组之前要在数据末尾进行补0，凑够23的整数倍，这里需要补充两个0字节，补充0之后，待编码数据变为01000001 | 01000010 | 01000011 | 01000100 | 00000000 | 00000000
将步骤2中的数据按每组6bit进行分组，010000 | 010100 | 001001 | 000011 | 010001 | 000000 | 000000 | 000000
将步骤3的每组6bit分组数据进行高位补0，变成8bit二进制数据分组。 00010000 | 00010100 | 00001001 | 00000011 | 00010001 | 00000000 |00000000 | 00000000
将步骤4中的8bit数据分组转换成十进制。16 | 20 | 9 | 3 | 17 | 0 | 0(填充) | 0(填充)
以步骤5中的十进制数据为索引，去Base64编码映射表中寻找对应的字符。16映射的字符是Q，20映射的字符是U，9映射的字符是J，3映射的字符是D，17映射的字符是R，0映射的字符是A，这里需要注意，上述数据最后两个字节也是0，但是，这里不能直接映射字符A，因为这两个0字节是都是填充数据，Base64规定，对于这种情况使用=来代替填充位的0字节。所以，映射的结果是&quot;QUJDRA==&quot;。
</code></pre>
<p>所以，字符串”ABC”经过Base64编码后的字符串是”QUJDRA==”。</p>
<p>其实这里有个规律，当原文的数据长度除以3余数为0时，编码之后后面没有”=”；当余数为1时，后面有两个”=”，当余数是2时，后面有一个”=”，”=”的个数也就是补充的字节数。</p>
<p>作者：AC0907<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/14537ba3517a">https://www.jianshu.com/p/14537ba3517a</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</li>
<li><p>b64 decode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">b64_generate_decode_table</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>    inv[<span class="number">80</span>];</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(inv, <span class="number">-1</span>, <span class="keyword">sizeof</span>(inv));</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(b64chars)<span class="number">-1</span>; i++) &#123;</span><br><span class="line">		inv[b64chars[i]<span class="number">-43</span>] = i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">b64_generate_decode_table</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>    inv[<span class="number">80</span>];</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(inv, <span class="number">-1</span>, <span class="keyword">sizeof</span>(inv));</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(b64chars)<span class="number">-1</span>; i++) &#123;</span><br><span class="line">		inv[b64chars[i]<span class="number">-43</span>] = i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">b64_isvalidchar</span><span class="params">(<span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (c == <span class="string">&#x27;+&#x27;</span> || c == <span class="string">&#x27;/&#x27;</span> || c == <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">b64_decode</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *in, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out, <span class="keyword">size_t</span> outlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> len;</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line">	<span class="keyword">size_t</span> j;</span><br><span class="line">	<span class="keyword">int</span>    v;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (in == <span class="literal">NULL</span> || out == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	len = <span class="built_in">strlen</span>(in);</span><br><span class="line">	<span class="keyword">if</span> (outlen &lt; b64_decoded_size(in) || len % <span class="number">4</span> != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!b64_isvalidchar(in[i])) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>, j=<span class="number">0</span>; i&lt;len; i+=<span class="number">4</span>, j+=<span class="number">3</span>) &#123;</span><br><span class="line">		v = b64invs[in[i]<span class="number">-43</span>];</span><br><span class="line">		v = (v &lt;&lt; <span class="number">6</span>) | b64invs[in[i+<span class="number">1</span>]<span class="number">-43</span>];</span><br><span class="line">		v = in[i+<span class="number">2</span>]==<span class="string">&#x27;=&#x27;</span> ? v &lt;&lt; <span class="number">6</span> : (v &lt;&lt; <span class="number">6</span>) | b64invs[in[i+<span class="number">2</span>]<span class="number">-43</span>];</span><br><span class="line">		v = in[i+<span class="number">3</span>]==<span class="string">&#x27;=&#x27;</span> ? v &lt;&lt; <span class="number">6</span> : (v &lt;&lt; <span class="number">6</span>) | b64invs[in[i+<span class="number">3</span>]<span class="number">-43</span>];</span><br><span class="line"></span><br><span class="line">		out[j] = (v &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">		<span class="keyword">if</span> (in[i+<span class="number">2</span>] != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">			out[j+<span class="number">1</span>] = (v &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">		<span class="keyword">if</span> (in[i+<span class="number">3</span>] != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">			out[j+<span class="number">2</span>] = v &amp; <span class="number">0xFF</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>url encode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">to_hex</span><span class="params">(<span class="keyword">char</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> hex[]=<span class="string">&quot;0123456789ABCDEF&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> hex[code &amp; <span class="number">15</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">url_encode</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *pstr =str, *buf = <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(str)*<span class="number">3</span> + <span class="number">1</span>), *pbuf = buf;</span><br><span class="line">    <span class="keyword">while</span>(*pstr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isalnum</span>(*pstr) || *pstr == <span class="string">&#x27;-&#x27;</span> || *pstr == <span class="string">&#x27;_&#x27;</span> || *pstr == <span class="string">&#x27;.&#x27;</span>|| *pstr == <span class="string">&#x27;~&#x27;</span>)</span><br><span class="line">            *pbuf++ = *pstr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(*pstr == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            *pbuf++ = <span class="string">&#x27;+&#x27;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            *pbuf++ = <span class="string">&#x27;%&#x27;</span>, *pbuf++ = to_hex(*pstr &gt;&gt; <span class="number">4</span>), *pbuf++ = to_hex(*pstr &amp; <span class="number">15</span>);</span><br><span class="line">        pstr++;</span><br><span class="line">    &#125;</span><br><span class="line">    *pbuf = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> buf;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>url只支持ASCII中的字母和数字和’-‘, ‘_’, ‘.’, ‘~’四个特殊字符。对于空格符用‘+’替代，而对于其它字符用%为分隔符，将该字符的前四bit和后四bit值用‘0123456789ABCDEF’字符代替。</p>
</li>
<li><p>生成url的过程</p>
<p>随机字符串+IMEI</p>
<p>哈希加密（OpenSSL SHA1）</p>
<p>hexs2bin</p>
<p>b64 encode</p>
<p>url encode</p>
<p>curl send request service, IP, url</p>
<p>xml parse</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* xmlDoc *doc = xmlReadFile(<span class="string">&quot;/tmp/data_usage.xml&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  root_element = xmlDocGetRootElement(doc)</span><br><span class="line"></span><br><span class="line">  print_xml(root_element, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (node)</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">      </span><br><span class="line">	找到Datausage, usedData, allocedData, Unit, dataAmount </span><br><span class="line">  &#125;</span><br><span class="line">node-&gt;node-&gt;next;</span><br><span class="line">node-&gt;children;</span><br><span class="line">is_leaf(node)</span><br><span class="line">xmlNodeGetContent(node)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>led_blink</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">led_blink(<span class="string">&quot;0&quot;</span>, pid, time_red)</span><br><span class="line"><span class="number">85</span><span class="number">-100</span> amber state=<span class="number">1</span></span><br><span class="line">&gt;<span class="number">100</span> red state=<span class="number">2</span></span><br><span class="line">根据LED此时状态来决定要不要执行led_blink;</span><br><span class="line"></span><br><span class="line">led_blink执行时</span><br><span class="line">kill(PID, SIGKILL);</span><br><span class="line">wait(&amp;status);</span><br><span class="line">如果此时state=<span class="number">2</span>，且&lt;<span class="number">85</span>，直接<span class="keyword">return</span></span><br><span class="line">否则fork()</span><br><span class="line">pid==<span class="number">0</span></span><br><span class="line">    execl(<span class="string">&quot;/usr/sbin/led_datausage&quot;</span>, <span class="string">&quot;led_datausage&quot;</span>, state, led_time, <span class="literal">NULL</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="upnp"><a href="#upnp" class="headerlink" title="upnp"></a>upnp</h1><p><strong>一、</strong>SSDP协议简介</p>
<p><strong>SSDP</strong>（简单服务发现协议）是应用层协议，是构成<strong>UPnP</strong>（通用即插即用）技术的核心协议之一。它为网络客户端（network client）提供了一种发现网络服务（network services）的机制，采用基于通知和发现路由的多播方式实现。</p>
<p>常见的协议请求消息有两种类型，第一种是服务通知，设备和服务使用此类通知声明自动存在；第二种是查询请求，协议客户端用此请求查询某种类型的设备和服务。请求消息中包含设备的特定信息或者某项服务的信息，例如设备类型、标识和指向设备描述文档的URL地址。</p>
<p><strong>二、****SSDP实现</strong></p>
<p>简单服务发现协议是在<strong>HTTPU</strong>和<strong>HTTPMU</strong>的基础上实现的协议。</p>
<p>按照协议的规定，当一个控制点（客户端）接入网络的时候，它可以向一个特定的多播地址的SSDP端口使用M-SEARCH方法发送“ssdp:discover”消息。当设备监听到这个保留的多播地址上由控制点发送的消息的时候，设备会分析控制点请求的服务，如果自身提供了控制点请求的服务，设备将通过单播的方式直接响应控制点的请求。</p>
<p>类似的，当一个设备接入网络的时候，它应当向一个特定的多播地址的SSDP端口使用NOTIFY方法发送“ssdp:alive”消息。控制点根据自己的策略，处理监听到的消息。考虑到设备可能在没有通知的情况下停止服务或者从网络上卸载，“ssdp:alive”消息必须在HTTP协议头CACHE-CONTROL里面指定超时值，设备必须在约定的超时值到达以前重发“ssdp:alive”消息。如果控制点在指定的超时值内没有再次收到设备发送的“ssdp:alive”消息，控制点将认为设备已经失效。</p>
<p>当一个设备计划从网络上卸载的时候，它也应当向一个特定的多播地址的SSDP端口使用NOTIFY方法发送“ssdp:byebye”消息。但是，即使没有发送“ssdp:byebye”消息，控制点也会根据“ssdp:alive”消息指定的超时值，将超时并且没有再次收到的“ssdp:alive”消息对应的设备认为是失效的设备。</p>
<p>在IPv4环境，当需要使用多播方式传送相关消息的时候，SSDP一般使用多播地址<em><strong>239.255.255.250</strong></em>和UDP端口号<em><strong>1900</strong></em>。</p>
<p>根据互联网地址指派机构的指派，SSDP在IPv6环境下使用多播地址FF0X::C，这里的X根据scope的不同可以有不同的取值。</p>
<p><strong>三、****SSDP请求类型</strong></p>
<p>两种类型的SSDP请求消息会通过SSDP多播地址发送：</p>
<p>\1. <strong>发现请求</strong>（Discovery request 或查询请求）。SSDP客户端向此地址发送HTTP UDP 发现请求，查询某种类型的服务。SSDP服务在此地址上监听服务发现请求。当服务监听到的HTTP UDP 发现请求和它自己提供的服务匹配时，它以单播方式发送HTTP UDP 响应。</p>
<p>\2. <strong>存在通知</strong>（notification）。SSDP服务向此多播地址发送HTTP UDP 通知消息来宣布自己的存在。</p>
<p>发现结果（discovery results）和存在通知消息（presence announcements）提供的信息包括：</p>
<p>服务的类型URI</p>
<p>服务名称USN：唯一标识一种服务实例。</p>
<p>位置信息：发现结果和存在通知可包含一个或多个位置URI，客户端利用位置信息可以找到它需要的服务。</p>
<p>期限信息：客户端在自己的cache中保存此服务多长时间。如果期限过了，关于此服务的信息会被从cache中拿掉。当客户端接收到的发现结果或存在通知包含的USN和cache中的某条匹配，则更新。</p>
<p><strong>四、****SSDP协议消息</strong></p>
<p><strong>1、****设备查询消息</strong></p>
<p>当一个控制点加入到网络中时，设备发现过程允许控制点寻找网络上感兴趣的设备。发现消息包括设备的一些特定信息或者某项服务的信息，例如它的类型、标识符、和指向XML设备描述文档的指针。从设备获得响应从本质上说，内容与多址传送的设备广播相同，只是采用单址传送方式。设备查询通过HTTP协议扩展M-SEARCH方法实现的。典型的设备查询请求消息格式：</p>
<blockquote>
<p>M-SEARCH * HTTP/1.1<br>Host: 239.255.255.250:1900<br>ST: urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>Man: “ssdp:discover”<br>MX: 3</p>
</blockquote>
<p>HOST：设置为协议保留多播地址和端口，必须是：239.255.255.250:1900（IPv4）或FF0x::C(IPv6)</p>
<p>MAN：设置协议查询的类型，必须是：ssdp:discover</p>
<p>MX：设置设备响应最长等待时间，设备响应在0和这个值之间随机选择响应延迟的值。这样可以为控制点响应平衡网络负载。</p>
<p>ST：设置服务查询的目标，它必须是下面的类型：</p>
<p><strong>ssdp:all</strong> 搜索所有设备和服务<br><strong>upnp:rootdevice</strong> 仅搜索网络中的根设备<br><strong>uuid:device-UUID</strong> 查询UUID标识的设备<br><strong>urn:schemas-upnp-org:device:device-Type:version</strong> 查询device-Type字段指定的设备类型，设备类型和版本由UPNP组织定义。<br><strong>urn:schemas-upnp-org:service:service-Type:version</strong> 查询service-Type字段指定的服务类型，服务类型和版本由UPNP组织定义。</p>
<p>在设备接收到查询请求并且查询类型（ST字段值）与此设备匹配时，设备必须向多播地址239.255.255.250:1900回应响应消息。典型：</p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Cache-Control: max-age=1800<br>ST: urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>USN: uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>EXT:<br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>Location: <a target="_blank" rel="noopener" href="http://192.168.1.1:5555/rootDesc.xml">http://192.168.1.1:5555/rootDesc.xml</a></p>
</blockquote>
<p>各HTTP协议头的含义简介：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CACHE-CONTROL</td>
<td>max-age指定通知消息存活时间，如果超过此时间间隔，控制点可以认为设备不存在</td>
</tr>
<tr>
<td>DATE</td>
<td>指定响应生成的时间</td>
</tr>
<tr>
<td>EXT</td>
<td>向控制点确认MAN头域</td>
</tr>
<tr>
<td>LOCATION</td>
<td>包含根设备描述得URL地址</td>
</tr>
<tr>
<td>SERVER</td>
<td>包含操作系统名，版本</td>
</tr>
<tr>
<td>ST</td>
<td>内容和意义与查询请求的相应字段相同</td>
</tr>
<tr>
<td>USN</td>
<td>表示不同服务的同一服务名，它提供了一种标识出相同类型服务的能力</td>
</tr>
</tbody></table>
<p><strong>2、****设备通知消息</strong></p>
<p>在设备加入网络，UPnP发现协议允许设备向控制点广告它的服务。它使用向一个标准地址和端口多址传送发现消息来实现。控制点在此端口上侦听是否有新服务加入系统。为了通知所有设备，一个设备为每个其上的嵌入设备和服务发送一系列相应的发现消息。每个消息也包含它表征设备或服务的特定信息。</p>
<p><strong>2.1、ssdp:alive消息</strong></p>
<p>在设备加入系统时，它采用多播传送方式发送发现消息，包括告知设备包含的根设备信息，所有嵌入设备以及它包含的服务。每个发现消息包含四个主要对象：</p>
<ol>
<li><p>在NT头中包含的潜在搜索目标。</p>
</li>
<li><p>在USN头中包含的复合发现标识</p>
</li>
<li><p>在LOCATION头中关于设备信息的URL地址</p>
</li>
<li><p>在CACHE-CONTROL头中表示的广告消息的合法存在时间。</p>
</li>
</ol>
<blockquote>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>Cache-Control:max-age=1800<br>Location:<a target="_blank" rel="noopener" href="http://192.168.1.1:5555/rootDesc.xml">http://192.168.1.1:5555/rootDesc.xml</a><br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>NT:upnp:rootdevice<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::upnp:rootdevice<br>NTS:ssdp:alive</p>
</blockquote>
<table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>HOST</td>
<td>设置为协议保留多播地址和端口，必须是239.255.255.250:1900（IPv4）</td>
</tr>
<tr>
<td>CACHE-CONTROL</td>
<td>max-age指定通知消息存活时间，如果超过此时间间隔，控制点可以认为设备不存在</td>
</tr>
<tr>
<td>LOCATION</td>
<td>包含根设备描述的URL地址</td>
</tr>
<tr>
<td>NT</td>
<td>在此消息中，NT头必须服务的服务类型</td>
</tr>
<tr>
<td>NTS</td>
<td>表示通知消息的子类型，必须为ssdp:alive</td>
</tr>
<tr>
<td>USN</td>
<td>表示不同服务的同一服务名，它提供了一种表示出相同类型服务的能力</td>
</tr>
</tbody></table>
<p>在设备和它的服务将要从网络中卸载时，设备应该对于每个未超期的ssdp:alive消息多播方式传送ssdp:byebye消息。但如果设备突然从网络卸载，它可能来不及发出这个通知消息。因此，发现消息必须在CACHE-CONTROL包含超时值，如果不重新发出广告消息，发现消息最后超时并从控制点的缓存中除去。典型的设备卸载消息格式如下：</p>
<blockquote>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>NT:upnp:rootdevice<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::upnp:rootdevice<br>NTS:ssdp:byebye</p>
</blockquote>
<p>ssdp主要用到upnp连接的开头和结尾：</p>
<ol>
<li>upnpd启动时：广播ssdp:alive包。</li>
<li>upnpc启动时：广播ssdp:discover包。</li>
<li>upnpd关闭时：广播ssdp:byebye。</li>
</ol>
<p>对于upnpc关闭时，并没有用到ssdp包，而只是UNSUBSCRIBE之前已经订阅的service或device。</p>
<h1 id="upnpd与upnpc通信的主要过程"><a href="#upnpd与upnpc通信的主要过程" class="headerlink" title="upnpd与upnpc通信的主要过程"></a>upnpd与upnpc通信的主要过程</h1><p><img src="/2021/09/25/rt-dev/upnp_flow.png"></p>
<p>如上图所示，基本的流程说明如下：</p>
<p>–&gt; server:upnpd启动时会广播ssdp:alive这里包含location：/rootDesc.xml还包含所支持的设备和服务。附录中可以看到更多的其它service或device。</p>
<blockquote>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>Cache-Control:max-age=1800<br>Location:<a target="_blank" rel="noopener" href="http://192.168.1.1:5555/rootDesc.xml">http://192.168.1.1:5555/rootDesc.xml</a><br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>NT:upnp:rootdevice<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::upnp:rootdevice<br>NTS:ssdp:alive</p>
</blockquote>
<p>&lt;– client: upnpc启动时也会广播ssdp:discover</p>
<blockquote>
<p>M-SEARCH * HTTP/1.1<br>Host: 239.255.255.250:1900<br>ST: urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>Man: “ssdp:discover”<br>MX: 3</p>
</blockquote>
<p>–&gt; server: upnpd会监控到client所发的广播包，然后会响应Location</p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Cache-Control: max-age=1800<br>ST: urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>USN: uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>EXT:<br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>Location: <a target="_blank" rel="noopener" href="http://192.168.1.1:5555/rootDesc.xml">http://192.168.1.1:5555/rootDesc.xml</a></p>
</blockquote>
<p>无论是通过upnpd的广播还是upnpc discover来从upnpd获取响应包，都是为了获取对应service或device的Location。</p>
<p>以下的流程的原始包都可以从附录中看到。</p>
<p>&lt;–client GET /rootDesc.xml, rootDesc.xml中包含upnpd中所支持的所以service或device</p>
<p>–&gt;server response GET /rootDesc.xml</p>
<p>&lt;–client GET /Layer3F.xml </p>
<p>–&gt;server response GET /Layer3F.xml</p>
<p>&lt;–client SUBSCRIBE /evt/L3Forwarding</p>
<p>–&gt;server response /evt/L3Forwarding and return SID</p>
<p>&lt;–NOTIFY /upnp/eventing/woyodiiype</p>
<p>–&gt;response NOTIFY</p>
<p>以上是订阅一个Layer3F的完整过程，可以从rootDesc.xml中可以获取到这个服务SCPD, control, event的URL。依次获取这个service的SCPD xml文件，订阅，最后通知。</p>
<p><img src="/2021/09/25/rt-dev/rootDesc" alt="image-20210527165506998"></p>
<p>那么接下来upnpc也会获取其它service的xml文件，对于它所支持的就会进行订阅和通知，而不支持的的service不会进行下一步动作。例如，bitcomet会获取NvGfn3.xml，但它并不支持这个功能所以并不会进行订阅和通知。</p>
<p>接下来是control操作：</p>
<p>&lt;– client POST /ctl/IPConn #GETConnectionTypeInfo</p>
<p>–&gt; server response</p>
<blockquote>
<p>POST /ctl/IPConn HTTP/1.1<br>Cache-Control: no-cache<br>Connection: Close<br>Pragma: no-cache<br>Content-Type: text/xml; charset=”utf-8”<br>User-Agent: Microsoft-Windows/10.0 UPnP/1.0<br>SOAPAction: “urn:schemas-upnp-org:service:WANIPConnection:1#GetConnectionTypeInfo”<br>Content-Length: 304<br>Host: 192.168.1.1:5555</p>
<?xml version="1.0"?>
<p>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> SOAP-ENV:encodingStyle=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;">http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</a><a href="SOAP-ENV:Body">SOAP-ENV:Body</a>&lt;m:GetConnectionTypeInfo xmlns:m=”urn:schemas-upnp-org:service:WANIPConnection:1”/&gt;<br>HTTP/1.1 200 OK<br>Content-Type: text/xml; charset=”utf-8”<br>Connection: close<br>Content-Length: 414<br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>Ext:</p>
<?xml version="1.0"?>
<p>&lt;s:Envelope xmlns:s=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> s:encodingStyle=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;">http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</a>&lt;s:Body&gt;&lt;u:GetConnectionTypeInfoResponse xmlns:u=”urn:schemas-upnp-org:service:WANIPConnection:1”&gt;<NewConnectionType>IP_Routed</NewConnectionType><NewPossibleConnectionTypes>IP_Routed</NewPossibleConnectionTypes></p>
</blockquote>
<p>这个POST 后跟随一个动作可以是GET也可是SET。这个和SOAP一样，通过获取这个动作来在后台运行相应的函数，再回应结果给client。</p>
<p>如果upnpc断开连接，那么在断开前它会向server端发送UNSUBSCRIBE动作来取消之前订阅的服务或设备。</p>
<p>&lt;– client UNSUBSCRIBE /evt/XXXX</p>
<p>–&gt; server response</p>
<blockquote>
<p>UNSUBSCRIBE /evt/CommonIfCfg HTTP/1.1<br>Cache-Control: no-cache<br>Connection: Close<br>Pragma: no-cache<br>User-Agent: Microsoft-Windows/10.0 UPnP/1.0<br>SID: uuid:44f5824f-c57d-418c-a131-f22b00000002<br>Host: 192.168.1.1:5555</p>
<p>HTTP/1.1 200 OK<br>Server: XR500 UPnP/1.0 miniupnpd/1.0<br>Connection: close<br>Content-type: text/html</p>
</blockquote>
<p>如果upnpd关闭，那么在退出前它也会广播ssdp:byebye来说明对应的服务退出。</p>
<blockquote>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>NT:upnp:rootdevice<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::upnp:rootdevice<br>NTS:ssdp:byebye</p>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>NT:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a<br>NTS:ssdp:byebye</p>
<p>…</p>
<p>NOTIFY * HTTP/1.1<br>HOST:239.255.255.250:1900<br>NT:urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>USN:uuid:4d696e69-444c-164e-9d42-8c3bad10a33a::urn:schemas-upnp-org:device:InternetGatewayDevice:1<br>NTS:ssdp:byebye</p>
<p>…</p>
</blockquote>
<h1 id="Control的过程"><a href="#Control的过程" class="headerlink" title="Control的过程"></a>Control的过程</h1><blockquote>
<p>POST /ctl/IPConn HTTP/1.1</p>
<p>Cache-Control: no-cache</p>
<p>Connection: Close</p>
<p>Pragma: no-cache</p>
<p>Content-Type: text/xml; charset=”utf-8”</p>
<p>User-Agent: Microsoft-Windows/10.0 UPnP/1.0</p>
<p>SOAPAction: “urn:schemas-upnp-org:service:WANIPConnection:1#AddPortMapping”</p>
<p>Content-Length: 1125</p>
<p>Host: 192.168.1.1:5555</p>
<?xml version="1.0"?>

<p>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> SOAP-ENV:encodingStyle=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;">http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</a><a href="SOAP-ENV:Body">SOAP-ENV:Body</a>&lt;m:AddPortMapping xmlns:m=”urn:schemas-upnp-org:service:WANIPConnection:1”&gt;<NewRemoteHost xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="string"></NewRemoteHost><NewExternalPort xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="ui2">23042</NewExternalPort><NewProtocol xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="string">TCP</NewProtocol><NewInternalPort xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="ui2">23042</NewInternalPort><NewInternalClient xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="string">192.168.1.2</NewInternalClient><NewEnabled xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="boolean">1</NewEnabled><NewPortMappingDescription xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="string">BitComet TCP</NewPortMappingDescription><NewLeaseDuration xmlns:dt="urn:schemas-microsoft-com:datatypes" dt:dt="ui4">0</NewLeaseDuration></p>
<p>HTTP/1.1 200 OK</p>
<p>Content-Type: text/xml; charset=”utf-8”</p>
<p>Connection: close</p>
<p>Content-Length: 260</p>
<p>Server: XR500 UPnP/1.0 miniupnpd/1.0</p>
<p>Ext:</p>
<?xml version="1.0"?>

<p>&lt;s:Envelope xmlns:s=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> s:encodingStyle=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;">http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</a>&lt;s:Body&gt;&lt;u:AddPortMappingResponse xmlns:u=”urn:schemas-upnp-org:service:WANIPConnection:1”/&gt;</p>
</blockquote>
<p>上面的内容与soap通信其实是一样的。那它的关键信息如下：</p>
<ul>
<li>#AddPortMapping<ul>
<li>NewRemoteHost</li>
<li>NewExternalPort: 23042</li>
<li>NewProtocol: TCP</li>
<li>NewInternalPort: 23042</li>
<li>NewInternalClient: 192.168.1.2</li>
<li>NewEnable: 1</li>
<li>NewPortMappingDescription</li>
<li>NewLeaseDuration</li>
</ul>
</li>
</ul>
<p>在miniupnpd中过程基本如下：</p>
<p>upnphttphead-&gt;socket -&gt; ProcessHTTPRequest -&gt; DispatchHTTPRequest -&gt; ProcessHTTPPost -&gt; ExecuteSoapAction -&gt; AddPortMapping</p>
<p>而在AddPortMapping这个函数中首先获取从client中传入的8个信息，然后再检查这8个信息</p>
<p>然后再把这些信息写到/tmp/netwall-rules中。</p>
<p>再将这些规则写到netwall-rules文件中后，接着调用如下：</p>
<p>portmap_add -&gt; update_to_file -&gt; system(“/usr/sbin/net-wall start”)</p>
<p>这样net-wall中会把netwall-rules中的规则写到内核中去。</p>
<h1 id="添加一个service的过程"><a href="#添加一个service的过程" class="headerlink" title="添加一个service的过程"></a>添加一个service的过程</h1><ol>
<li><p>首先要在upnpd的根页面上要有该服务</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">upnp_device</span> <span class="title">IGD_Devices</span>[<span class="title">NUM_DEVICES</span>] =</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        ARRAYSIZE(wanconnectiondevice_servicelist)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">upnp_service</span> <span class="title">wanconnectiondevice_servicelist</span>[] =</span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;urn:schemas-upnp-org:service:GeForceNow:1&quot;</span>,</span><br><span class="line">        NVGFN_EVENTURL,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        genNvGFNNotify,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">genNvGFNNotify(<span class="keyword">int</span> *len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> buildNotifyBody(len, scpdNVGFN.serviceStateTable, GetNvGFNVars);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ProcessHTTPSubscribe</span></span><br><span class="line"><span class="function">    FindServiceByEventURL</span></span><br><span class="line"><span class="function">    	from IGD_Devices get serviceList</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">ProcessHTTPGet</span></span><br><span class="line"><span class="function">    <span class="title">sendXMLdesc</span><span class="params">(h, genRootDesc)</span></span>;</span><br><span class="line">		rootDesc &#123;</span><br><span class="line">            <span class="string">&quot;servicelist&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/serviceType&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/serviceId&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/controlURL&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/eventSubURL&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">	...</span><br><span class="line">    sendXMLdesc(h, genNVGFN);</span><br><span class="line">		genServiceDesc(len, &amp;scpdNVGFN);</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">serviceDesc</span> <span class="title">scpdNVGFN</span> =</span>&#123;</span><br><span class="line">                NVGFNActions, NVGFNVars</span><br><span class="line">            &#125;;</span><br><span class="line"><span class="comment">/* NVGFNActions是Get或Set函数结构体， NVGFNVars是一些参数及类型 */</span></span><br><span class="line"></span><br><span class="line">ProcessHTTPPost</span><br><span class="line">    从SoapMethods这个结构体数组中匹配相应的Get或Set函数执行</span><br><span class="line">    相应包格式由第三方提供，我们负责里面的数据</span><br></pre></td></tr></table></figure></li>
<li><p>添加这个service的xml文件</p>
</li>
<li><p>添加service支持action的控制函数</p>
</li>
</ol>
<h1 id="HTTP简介"><a href="#HTTP简介" class="headerlink" title="HTTP简介"></a>HTTP简介</h1><p>HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。</p>
<p>HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p>
<p>HTTP是一个属于应用层的面向对象的协议，由于其简捷、快速的方式，适用于分布式超媒体信息系统。它于1990年提出，经过几年的使用与发展，得到不断地完善和扩展。目前在WWW中使用的是HTTP/1.0的第六版，HTTP/1.1的规范化工作正在进行之中，而且HTTP-NG(Next Generation of HTTP)的建议已经提出。</p>
<p>HTTP协议工作于客户端-服务端架构为上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2964446-5a35e17f298a48e1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2" alt="img"></p>
<p>http请求-响应模型.jpg</p>
<h1 id="主要特点"><a href="#主要特点" class="headerlink" title="主要特点"></a>主要特点</h1><p>1、简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。每种方法规定了客户与服务器联系的类型不同。由于HTTP协议简单，使得HTTP服务器的程序规模小，因而通信速度很快。</p>
<p>2、灵活：HTTP允许传输任意类型的数据对象。正在传输的类型由Content-Type加以标记。</p>
<p>3.无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。</p>
<p>4.无状态：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。<br>5、支持B/S及C/S模式。</p>
<h1 id="HTTP之URL"><a href="#HTTP之URL" class="headerlink" title="HTTP之URL"></a>HTTP之URL</h1><p>HTTP使用统一资源标识符（Uniform Resource Identifiers, URI）来传输数据和建立连接。URL是一种特殊类型的URI，包含了用于查找某个资源的足够的信息</p>
<p>URL,全称是UniformResourceLocator, 中文叫统一资源定位符,是互联网上用来标识某一处资源的地址。以下面这个URL为例，介绍下普通URL的各部分组成：</p>
<h4 id="http-www-aspxfans-com-8080-news-index-asp-boardID-5-amp-ID-24618-amp-page-1-name"><a href="#http-www-aspxfans-com-8080-news-index-asp-boardID-5-amp-ID-24618-amp-page-1-name" class="headerlink" title="http://www.aspxfans.com:8080/news/index.asp?boardID=5&amp;ID=24618&amp;page=1#name"></a><a target="_blank" rel="noopener" href="http://www.aspxfans.com:8080/news/index.asp?boardID=5&amp;ID=24618&amp;page=1#name">http://www.aspxfans.com:8080/news/index.asp?boardID=5&amp;ID=24618&amp;page=1#name</a></h4><p>从上面的URL可以看出，一个完整的URL包括以下几部分：<br>1.协议部分：该URL的协议部分为“http：”，这代表网页使用的是HTTP协议。在Internet中可以使用多种协议，如HTTP，FTP等等本例中使用的是HTTP协议。在”HTTP”后面的“//”为分隔符</p>
<p>2.域名部分：该URL的域名部分为“<a target="_blank" rel="noopener" href="http://www.aspxfans.com”.一个url中,也可以使用ip地址作为域名使用/">www.aspxfans.com”。一个URL中，也可以使用IP地址作为域名使用</a></p>
<p>3.端口部分：跟在域名后面的是端口，域名和端口之间使用“:”作为分隔符。端口不是一个URL必须的部分，如果省略端口部分，将采用默认端口</p>
<p>4.虚拟目录部分：从域名后的第一个“/”开始到最后一个“/”为止，是虚拟目录部分。虚拟目录也不是一个URL必须的部分。本例中的虚拟目录是“/news/”</p>
<p>5.文件名部分：从域名后的最后一个“/”开始到“？”为止，是文件名部分，如果没有“?”,则是从域名后的最后一个“/”开始到“#”为止，是文件部分，如果没有“？”和“#”，那么从域名后的最后一个“/”开始到结束，都是文件名部分。本例中的文件名是“index.asp”。文件名部分也不是一个URL必须的部分，如果省略该部分，则使用默认的文件名</p>
<p>6.锚部分：从“#”开始到最后，都是锚部分。本例中的锚部分是“name”。锚部分也不是一个URL必须的部分</p>
<p>7.参数部分：从“？”开始到“#”为止之间的部分为参数部分，又称搜索部分、查询部分。本例中的参数部分为“boardID=5&amp;ID=24618&amp;page=1”。参数可以允许有多个参数，参数与参数之间用“&amp;”作为分隔符。</p>
<p>（原文：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ergouge/article/details/8185219">http://blog.csdn.net/ergouge/article/details/8185219</a> ）</p>
<h1 id="URI和URL的区别"><a href="#URI和URL的区别" class="headerlink" title="URI和URL的区别"></a>URI和URL的区别</h1><h5 id="URI，是uniform-resource-identifier，统一资源标识符，用来唯一的标识一个资源。"><a href="#URI，是uniform-resource-identifier，统一资源标识符，用来唯一的标识一个资源。" class="headerlink" title="URI，是uniform resource identifier，统一资源标识符，用来唯一的标识一个资源。"></a>URI，是uniform resource identifier，统一资源标识符，用来唯一的标识一个资源。</h5><p>Web上可用的每种资源如HTML文档、图像、视频片段、程序等都是一个来URI来定位的<br>URI一般由三部组成：<br>①访问资源的命名机制<br>②存放资源的主机名<br>③资源自身的名称，由路径表示，着重强调于资源。</p>
<h5 id="URL是uniform-resource-locator，统一资源定位器，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。"><a href="#URL是uniform-resource-locator，统一资源定位器，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。" class="headerlink" title="URL是uniform resource locator，统一资源定位器，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。"></a>URL是uniform resource locator，统一资源定位器，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。</h5><p>URL是Internet上用来描述信息资源的字符串，主要用在各种WWW客户程序和服务器程序上，特别是著名的Mosaic。<br>采用URL可以用一种统一的格式来描述各种信息资源，包括文件、服务器的地址和目录等。URL一般由三部组成：<br>①协议(或称为服务方式)<br>②存有该资源的主机IP地址(有时也包括端口号)<br>③主机资源的具体地址。如目录和文件名等</p>
<h5 id="URN，uniform-resource-name，统一资源命名，是通过名字来标识资源，比如mailto-x6a-97-x76-97-x2d-x6e-101-x74-x40-106-x61-x76-x61-46-x73-x75-x6e-46-99-111-x6d-。"><a href="#URN，uniform-resource-name，统一资源命名，是通过名字来标识资源，比如mailto-x6a-97-x76-97-x2d-x6e-101-x74-x40-106-x61-x76-x61-46-x73-x75-x6e-46-99-111-x6d-。" class="headerlink" title="URN，uniform resource name，统一资源命名，是通过名字来标识资源，比如mailto:&#x6a;&#97;&#x76;&#97;&#x2d;&#x6e;&#101;&#x74;&#x40;&#106;&#x61;&#x76;&#x61;&#46;&#x73;&#x75;&#x6e;&#46;&#99;&#111;&#x6d;。"></a>URN，uniform resource name，统一资源命名，是通过名字来标识资源，比如mailto:<a href="mailto:&#x6a;&#97;&#x76;&#97;&#x2d;&#x6e;&#101;&#x74;&#x40;&#106;&#x61;&#x76;&#x61;&#46;&#x73;&#x75;&#x6e;&#46;&#99;&#111;&#x6d;">&#x6a;&#97;&#x76;&#97;&#x2d;&#x6e;&#101;&#x74;&#x40;&#106;&#x61;&#x76;&#x61;&#46;&#x73;&#x75;&#x6e;&#46;&#99;&#111;&#x6d;</a>。</h5><p>URI是以一种抽象的，高层次概念定义统一资源标识，而URL和URN则是具体的资源标识的方式。URL和URN都是一种URI。笼统地说，每个 URL 都是 URI，但不一定每个 URI 都是 URL。这是因为 URI 还包括一个子类，即统一资源名称 (URN)，它命名资源但不指定如何定位资源。上面的 mailto、news 和 isbn URI 都是 URN 的示例。</p>
<p>在Java的URI中，一个URI实例可以代表绝对的，也可以是相对的，只要它符合URI的语法规则。而URL类则不仅符合语义，还包含了定位该资源的信息，因此它不能是相对的。<br>在Java类库中，URI类不包含任何访问资源的方法，它唯一的作用就是解析。<br>相反的是，URL类可以打开一个到达资源的流。</p>
<h1 id="HTTP之请求消息Request"><a href="#HTTP之请求消息Request" class="headerlink" title="HTTP之请求消息Request"></a>HTTP之请求消息Request</h1><p>客户端发送一个HTTP请求到服务器的请求消息包括以下格式：</p>
<h5 id="请求行（request-line）、请求头部（header）、空行和请求数据四个部分组成。"><a href="#请求行（request-line）、请求头部（header）、空行和请求数据四个部分组成。" class="headerlink" title="请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。"></a>请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。</h5><p><img src="https://upload-images.jianshu.io/upload_images/2964446-fdfb1a8fce8de946.png?imageMogr2/auto-orient/strip%7CimageView2/2" alt="img"></p>
<p>Http请求消息结构.png</p>
<ul>
<li>请求行以一个方法符号开头，以空格分开，后面跟着请求的URI和协议的版本。</li>
</ul>
<h5 id="Get请求例子，使用Charles抓取的request："><a href="#Get请求例子，使用Charles抓取的request：" class="headerlink" title="Get请求例子，使用Charles抓取的request："></a>Get请求例子，使用Charles抓取的request：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /562f25980001b1b106000338.jpg HTTP/1.1</span><br><span class="line">Host    img.mukewang.com</span><br><span class="line">User-Agent    Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106 Safari/537.36</span><br><span class="line">Accept    image/webp,image/*,*/*;q=0.8</span><br><span class="line">Referer    http://www.imooc.com/</span><br><span class="line">Accept-Encoding    gzip, deflate, sdch</span><br><span class="line">Accept-Language    zh-CN,zh;q=0.8</span><br></pre></td></tr></table></figure>

<h5 id="第一部分：请求行，用来说明请求类型-要访问的资源以及所使用的HTTP版本"><a href="#第一部分：请求行，用来说明请求类型-要访问的资源以及所使用的HTTP版本" class="headerlink" title="第一部分：请求行，用来说明请求类型,要访问的资源以及所使用的HTTP版本."></a>第一部分：请求行，用来说明请求类型,要访问的资源以及所使用的HTTP版本.</h5><p>请求行有三个字段，方法字段、URL字段和HTTP版本字段。</p>
<p>方法字段包括GET , POST, HEAD PUT DELETE</p>
<p>GET说明请求类型为GET,[/562f25980001b1b106000338.jpg]为要访问的资源，该行的最后一部分说明使用的是HTTP1.1版本。</p>
<h5 id="第二部分：请求头部，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息"><a href="#第二部分：请求头部，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息" class="headerlink" title="第二部分：请求头部，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息"></a>第二部分：请求头部，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息</h5><p>从第二行起为请求头部，HOST将指出请求的目的地.User-Agent,服务器端和客户端脚本都能访问它,它是浏览器类型检测逻辑的重要基础.该信息由你的浏览器来定义,并且在每个请求中自动发送等等</p>
<h5 id="第三部分：空行，请求头部后面的空行是必须的"><a href="#第三部分：空行，请求头部后面的空行是必须的" class="headerlink" title="第三部分：空行，请求头部后面的空行是必须的"></a>第三部分：空行，请求头部后面的空行是必须的</h5><p>即使第四部分的请求数据为空，也必须有空行。</p>
<h5 id="第四部分：请求数据也叫主体，可以添加任意的其他数据。"><a href="#第四部分：请求数据也叫主体，可以添加任意的其他数据。" class="headerlink" title="第四部分：请求数据也叫主体，可以添加任意的其他数据。"></a>第四部分：请求数据也叫主体，可以添加任意的其他数据。</h5><p>这个例子的请求数据为空。</p>
<h5 id="POST请求例子，使用Charles抓取的request："><a href="#POST请求例子，使用Charles抓取的request：" class="headerlink" title="POST请求例子，使用Charles抓取的request："></a>POST请求例子，使用Charles抓取的request：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP1.1</span><br><span class="line">Host:www.wrox.com</span><br><span class="line">User-Agent:Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)</span><br><span class="line">Content-Type:application/x-www-form-urlencoded</span><br><span class="line">Content-Length:40</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"></span><br><span class="line">name=Professional%20Ajax&amp;publisher=Wiley</span><br></pre></td></tr></table></figure>

<p>第一部分：请求行，第一行明了是post请求，以及http1.1版本。<br>第二部分：请求头部，第二行至第六行。<br>第三部分：空行，第七行的空行。<br>第四部分：请求数据，第八行。</p>
<h1 id="HTTP之响应消息Response"><a href="#HTTP之响应消息Response" class="headerlink" title="HTTP之响应消息Response"></a>HTTP之响应消息Response</h1><p>一般情况下，服务器接收并处理客户端发过来的请求后会返回一个HTTP的响应消息。</p>
<h5 id="HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。"><a href="#HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。" class="headerlink" title="HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。"></a>HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。</h5><p><img src="https://upload-images.jianshu.io/upload_images/2964446-1c4cab46f270d8ee.jpg?imageMogr2/auto-orient/strip%7CimageView2/2" alt="img"></p>
<p>http响应消息格式.jpg</p>
<p><strong>例子</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Fri, 22 May 2009 06:07:21 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">            &lt;!--body goes here--&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="第一部分：状态行，由HTTP协议版本号，-状态码，-状态消息-三部分组成。"><a href="#第一部分：状态行，由HTTP协议版本号，-状态码，-状态消息-三部分组成。" class="headerlink" title="第一部分：状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。"></a>第一部分：状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。</h5><p>第一行为状态行，（HTTP/1.1）表明HTTP版本为1.1版本，状态码为200，状态消息为（ok）</p>
<h5 id="第二部分：消息报头，用来说明客户端要使用的一些附加信息"><a href="#第二部分：消息报头，用来说明客户端要使用的一些附加信息" class="headerlink" title="第二部分：消息报头，用来说明客户端要使用的一些附加信息"></a>第二部分：消息报头，用来说明客户端要使用的一些附加信息</h5><p>第二行和第三行为消息报头，<br>Date:生成响应的日期和时间；Content-Type:指定了MIME类型的HTML(text/html),编码类型是UTF-8</p>
<h5 id="第三部分：空行，消息报头后面的空行是必须的"><a href="#第三部分：空行，消息报头后面的空行是必须的" class="headerlink" title="第三部分：空行，消息报头后面的空行是必须的"></a>第三部分：空行，消息报头后面的空行是必须的</h5><h5 id="第四部分：响应正文，服务器返回给客户端的文本信息。"><a href="#第四部分：响应正文，服务器返回给客户端的文本信息。" class="headerlink" title="第四部分：响应正文，服务器返回给客户端的文本信息。"></a>第四部分：响应正文，服务器返回给客户端的文本信息。</h5><p>空行后面的html部分为响应正文。</p>
<h1 id="HTTP之状态码"><a href="#HTTP之状态码" class="headerlink" title="HTTP之状态码"></a>HTTP之状态码</h1><p>状态代码有三位数字组成，第一个数字定义了响应的类别，共分五种类别:</p>
<h6 id="1xx：指示信息–表示请求已接收，继续处理"><a href="#1xx：指示信息–表示请求已接收，继续处理" class="headerlink" title="1xx：指示信息–表示请求已接收，继续处理"></a>1xx：指示信息–表示请求已接收，继续处理</h6><h6 id="2xx：成功–表示请求已被成功接收、理解、接受"><a href="#2xx：成功–表示请求已被成功接收、理解、接受" class="headerlink" title="2xx：成功–表示请求已被成功接收、理解、接受"></a>2xx：成功–表示请求已被成功接收、理解、接受</h6><h6 id="3xx：重定向–要完成请求必须进行更进一步的操作"><a href="#3xx：重定向–要完成请求必须进行更进一步的操作" class="headerlink" title="3xx：重定向–要完成请求必须进行更进一步的操作"></a>3xx：重定向–要完成请求必须进行更进一步的操作</h6><h6 id="4xx：客户端错误–请求有语法错误或请求无法实现"><a href="#4xx：客户端错误–请求有语法错误或请求无法实现" class="headerlink" title="4xx：客户端错误–请求有语法错误或请求无法实现"></a>4xx：客户端错误–请求有语法错误或请求无法实现</h6><h6 id="5xx：服务器端错误–服务器未能实现合法的请求"><a href="#5xx：服务器端错误–服务器未能实现合法的请求" class="headerlink" title="5xx：服务器端错误–服务器未能实现合法的请求"></a>5xx：服务器端错误–服务器未能实现合法的请求</h6><p>常见状态码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">200 OK                        //客户端请求成功</span><br><span class="line">400 Bad Request               //客户端请求有语法错误，不能被服务器所理解</span><br><span class="line">401 Unauthorized              //请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用 </span><br><span class="line">403 Forbidden                 //服务器收到请求，但是拒绝提供服务</span><br><span class="line">404 Not Found                 //请求资源不存在，eg：输入了错误的URL</span><br><span class="line">500 Internal Server Error     //服务器发生不可预期的错误</span><br><span class="line">503 Server Unavailable        //服务器当前不能处理客户端的请求，一段时间后可能恢复正常</span><br></pre></td></tr></table></figure>

<p>更多状态码<a target="_blank" rel="noopener" href="http://www.runoob.com/http/http-status-codes.html">http://www.runoob.com/http/http-status-codes.html</a></p>
<h1 id="HTTP请求方法"><a href="#HTTP请求方法" class="headerlink" title="HTTP请求方法"></a>HTTP请求方法</h1><p>根据HTTP标准，HTTP请求可以使用多种请求方法。<br>HTTP1.0定义了三种请求方法： GET, POST 和 HEAD方法。<br>HTTP1.1新增了五种请求方法：OPTIONS, PUT, DELETE, TRACE 和 CONNECT 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET     请求指定的页面信息，并返回实体主体。</span><br><span class="line">HEAD     类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头</span><br><span class="line">POST     向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。</span><br><span class="line">PUT     从客户端向服务器传送的数据取代指定的文档的内容。</span><br><span class="line">DELETE      请求服务器删除指定的页面。</span><br><span class="line">CONNECT     HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。</span><br><span class="line">OPTIONS     允许客户端查看服务器的性能。</span><br><span class="line">TRACE     回显服务器收到的请求，主要用于测试或诊断。</span><br></pre></td></tr></table></figure>

<h1 id="HTTP工作原理"><a href="#HTTP工作原理" class="headerlink" title="HTTP工作原理"></a>HTTP工作原理</h1><p>HTTP协议定义Web客户端如何从Web服务器请求Web页面，以及服务器如何把Web页面传送给客户端。HTTP协议采用了请求/响应模型。客户端向服务器发送一个请求报文，请求报文包含请求的方法、URL、协议版本、请求头部和请求数据。服务器以一个状态行作为响应，响应的内容包括协议的版本、成功或者错误代码、服务器信息、响应头部和响应数据。</p>
<p>以下是 HTTP 请求/响应的步骤：</p>
<h6 id="1、客户端连接到Web服务器"><a href="#1、客户端连接到Web服务器" class="headerlink" title="1、客户端连接到Web服务器"></a>1、客户端连接到Web服务器</h6><p>一个HTTP客户端，通常是浏览器，与Web服务器的HTTP端口（默认为80）建立一个TCP套接字连接。例如，<a target="_blank" rel="noopener" href="http://www.oakcms.cn./">http://www.oakcms.cn。</a></p>
<h6 id="2、发送HTTP请求"><a href="#2、发送HTTP请求" class="headerlink" title="2、发送HTTP请求"></a>2、发送HTTP请求</h6><p>通过TCP套接字，客户端向Web服务器发送一个文本的请求报文，一个请求报文由请求行、请求头部、空行和请求数据4部分组成。</p>
<h6 id="3、服务器接受请求并返回HTTP响应"><a href="#3、服务器接受请求并返回HTTP响应" class="headerlink" title="3、服务器接受请求并返回HTTP响应"></a>3、服务器接受请求并返回HTTP响应</h6><p>Web服务器解析请求，定位请求资源。服务器将资源复本写到TCP套接字，由客户端读取。一个响应由状态行、响应头部、空行和响应数据4部分组成。</p>
<h6 id="4、释放连接TCP连接"><a href="#4、释放连接TCP连接" class="headerlink" title="4、释放连接TCP连接"></a>4、释放连接<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP连接</a></h6><p>若connection 模式为close，则服务器主动关闭<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP连接</a>，客户端被动关闭连接，释放<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP连接</a>;若connection 模式为keepalive，则该连接会保持一段时间，在该时间内可以继续接收请求;</p>
<h6 id="5、客户端浏览器解析HTML内容"><a href="#5、客户端浏览器解析HTML内容" class="headerlink" title="5、客户端浏览器解析HTML内容"></a>5、客户端浏览器解析HTML内容</h6><p>客户端浏览器首先解析状态行，查看表明请求是否成功的状态代码。然后解析每一个响应头，响应头告知以下为若干字节的HTML文档和文档的字符集。客户端浏览器读取响应数据HTML，根据HTML的语法对其进行格式化，并在浏览器窗口中显示。</p>
<p>例如：在浏览器地址栏键入URL，按下回车之后会经历以下流程：</p>
<p>1、浏览器向 DNS 服务器请求解析该 URL 中的域名所对应的 IP 地址;</p>
<p>2、解析出 IP 地址后，根据该 IP 地址和默认端口 80，和服务器建立<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP连接</a>;</p>
<p>3、浏览器发出读取文件(URL 中域名后面部分对应的文件)的HTTP 请求，该请求报文作为 <a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP 三次握手</a>的第三个报文的数据发送给服务器;</p>
<p>4、服务器对浏览器请求作出响应，并把对应的 html 文本发送给浏览器;</p>
<p>5、释放 <a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP连接</a>;</p>
<p>6、浏览器将该 html 文本并显示内容; 　　</p>
<h1 id="GET和POST请求的区别"><a href="#GET和POST请求的区别" class="headerlink" title="GET和POST请求的区别"></a>GET和POST请求的区别</h1><h6 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /books/?sex=man&amp;name=Professional HTTP/1.1</span><br><span class="line">Host: www.wrox.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)</span><br><span class="line">Gecko/20050225 Firefox/1.0.1</span><br><span class="line">Connection: Keep-Alive</span><br></pre></td></tr></table></figure>

<p>注意最后一行是空行</p>
<h6 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: www.wrox.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)</span><br><span class="line">Gecko/20050225 Firefox/1.0.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 40</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"></span><br><span class="line">name=Professional%20Ajax&amp;publisher=Wiley</span><br></pre></td></tr></table></figure>

<p>1、GET提交，请求的数据会附在URL之后（就是把数据放置在HTTP协议头中），以?分割URL和传输数据，多个参数用&amp;连接；例 如：login.action?name=hyddd&amp;password=idontknow&amp;verify=%E4%BD%A0 %E5%A5%BD。如果数据是英文字母/数字，原样发送，如果是空格，转换为+，如果是中文/其他字符，则直接把字符串用BASE64加密，得出如： %E4%BD%A0%E5%A5%BD，其中％XX中的XX为该符号以16进制表示的ASCII。</p>
<p>POST提交：把提交的数据放置在是HTTP包的包体中。上文示例中红色字体标明的就是实际的传输数据</p>
<h6 id="因此，GET提交的数据会在地址栏中显示出来，而POST提交，地址栏不会改变"><a href="#因此，GET提交的数据会在地址栏中显示出来，而POST提交，地址栏不会改变" class="headerlink" title="因此，GET提交的数据会在地址栏中显示出来，而POST提交，地址栏不会改变"></a>因此，GET提交的数据会在地址栏中显示出来，而POST提交，地址栏不会改变</h6><p>2、传输数据的大小：首先声明：HTTP协议没有对传输的数据大小进行限制，HTTP协议规范也没有对URL长度进行限制。</p>
<p>而在实际开发中存在的限制主要有：</p>
<p><strong>GET</strong>:特定浏览器和服务器对URL长度有限制，例如 IE对URL长度的限制是2083字节(2K+35)。对于其他浏览器，如Netscape、FireFox等，理论上没有长度限制，其限制取决于操作系 统的支持。</p>
<p>因此对于GET提交时，传输数据就会受到URL长度的 限制。</p>
<p><strong>POST</strong>:由于不是通过URL传值，理论上数据不受 限。但实际各个WEB服务器会规定对post提交数据大小进行限制，Apache、IIS6都有各自的配置。</p>
<p>3、安全性</p>
<p>POST的安全性要比GET的安全性高。比如：通过GET提交数据，用户名和密码将明文出现在URL上，因为(1)登录页面有可能被浏览器缓存；(2)其他人查看浏览器的历史纪录，那么别人就可以拿到你的账号和密码了，除此之外，使用GET提交数据还可能会造成Cross-site request forgery攻击</p>
<p>4、Http get,post,soap协议都是在http上运行的</p>
<p>（1）get：请求参数是作为一个key/value对的序列（查询字符串）附加到URL上的<br>查询字符串的长度受到web浏览器和web服务器的限制（如IE最多支持2048个字符），不适合传输大型数据集同时，它很不安全</p>
<p>（2）post：请求参数是在http标题的一个不同部分（名为entity body）传输的，这一部分用来传输表单信息，因此必须将Content-type设置为:application/x-www-form- urlencoded。post设计用来支持web窗体上的用户字段，其参数也是作为key/value对传输。<br>但是：它不支持复杂数据类型，因为post没有定义传输数据结构的语义和规则。</p>
<p>（3）soap：是http post的一个专用版本，遵循一种特殊的xml消息格式<br>Content-type设置为: text/xml 任何数据都可以xml化。</p>
<p>Http协议定义了很多与服务器交互的方法，最基本的有4种，分别是GET,POST,PUT,DELETE. 一个URL地址用于描述一个网络上的资源，而HTTP中的GET, POST, PUT, DELETE就对应着对这个资源的查，改，增，删4个操作。 我们最常见的就是GET和POST了。GET一般用于获取/查询资源信息，而POST一般用于更新资源信息.</p>
<p>我们看看GET和POST的区别</p>
<ol>
<li><ol>
<li>GET提交的数据会放在URL之后，以?分割URL和传输数据，参数之间以&amp;相连，如EditPosts.aspx?name=test1&amp;id=123456. POST方法是把提交的数据放在HTTP包的Body中.</li>
<li>GET提交的数据大小有限制（因为浏览器对URL的长度有限制），而POST方法提交的数据没有限制.</li>
<li>GET方式需要使用Request.QueryString来取得变量的值，而POST方式通过Request.Form来获取变量的值。</li>
<li>GET方式提交数据，会带来安全问题，比如一个登录页面，通过GET方式提交数据时，用户名和密码将出现在URL上，如果页面可以被缓存或者其他人可以访问这台机器，就可以从历史记录获得该用户的账号和密码</li>
</ol>
</li>
</ol>
<h1 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h1><p>Client -&gt; discover (null ciaddr/broadcast; xid, params request)</p>
<p>Server -&gt; offer (broadcast; siaddr, xid yiaddr, options)</p>
<p>Client -&gt;request(broadcast; siaddr, ciaddr, xid, options)</p>
<p>Server-&gt;ACK(boadcast; xid, yiaddr, options)</p>
<p>检查冲突，如果冲突从LAN 192.168.1.1 -&gt;10.0.01-&gt;172.16.0.1</p>
<p>客户机首先广播一个DHCPDISCOVER消息。对于接受请求的每台服务器，无论是直接接受还是通过中继代理，它们都会响应一个DHCPOFFER消息，并在“你的”IP地址字段中包含提供的IP地址。其他配置选项（例如DNS服务器的IP地址，子网掩码）也经常包含在内。DHCPOFFER消息中包含租用时间T，它提供了在不更新租约的情况下地址可被租用的时间上限。这个消息还包含更新时间（T1）,它是客户机从获得租约到尝试要求服务器更新租约的时间。以及重新绑定时间（T2）,它是客户机城市要求DHCP服务器更新其地址的时间。在默认情况下，T1=(T/2), T2=(7T/8)</p>
<p>当接收一台或多台服务器的DHCPOFFER消息之后，客户机确定自己想接受那个DHCPOFFER，并广播一个包括服务器标识符选项的DHCPREQUEST消息，但只有DHCPREQUEST消息中标识的服务器同意将该地址进行绑定；其他服务器清除与该请求相关的状态。在完成绑定后，选中的服务器响应一个DHCPACK消息，通知客户机现在可以使用该地址了。如果服务器无法分配包含在DHCPREQUEST消息中的地址，该服务器会响应一个DHCPNAK消息。</p>
<p>当客户机接受DHCPACK消息和其他相关的配置消息时，它可探测网络以确保获得的地址未被使用（例如，向该地址发送一个ARP请求以执行ACD).如果客户机确定地址已被使用，客户机就不使用，并向服务器发送一个DHCPDECLINE消息。放弃IP发送DHCPRELEASE消息。</p>
<p>更新其租约的情况下，发送DHCPREQUEST。客户机有地址了，它不需要更新该地址，但需要其他配置信息。则发送DHCPINFORM。服务器同意则回DHCPACK。</p>
<p>1、client 在局域网内广播 DHCPDISCOVER 报文，让局域网内所有的 DHCP server 都收到这 个请求报文。在 DHCPDISCOVER 中，client 可以在“option”字段中加入“request paramter  list”选项，表明自己想要获得的各种参数。</p>
<p> 2、由于 DHCPDISCOVER 报文是广播，那么所有的 DHCP SERVER 都能够收到，所有的 DHCP SERVER 都会响应一个 DHCPOFFER 报文，其中“yiaddr”字段就是 server 提供给 client 使用的 IP 地址，而且 server 会把自己的 IP 地址放在“option”字段中以便 client 区分不同的 DHCP server，发出此报文后，DHCP server 就会写入这个 ip 到 leases table 中，但是其租 约时间为临时的 60s。</p>
<p> 3、client 能够收到所有的 DHCPOFFER 报文，但只能处理其中的一个，一般的原则是 client 接收、处理最先收到的 DHCPOFFER 报文。之后 client 发出一个广播的 DHCPREQUEST 报 文，在“option”字段中会加入 server 的 IP 地址和用户想要的 IP 地址。</p>
<p> 4、DHCP server 收到 DHCPREQUEST 报文后，判断“option”字段中的 server 的 IP 地址是否 与自己的地址相同，不相同，则不做任何处理，临时租约到期就会释放之前的 ip；当 option 中 DHCP server 的 IP 地址与自己的 IP 地址相同时，DHCP server 就会响应一个 DHCPACK 报文。 </p>
<p>5、client 收到 DHCPACK 报文后（经过上面的处理后，有且只有一个 DHCPACK 报文）， client 会发出 ARP 请求查看分配的 IP 地址是否已经被别人使用，如果可以使用，则成功获 得 IP 地址。 </p>
<p>6、如果 client 发现分配的 IP 地址已经被别人使用，则会发出 DHCPDECLINE 报文通知 DHCP server 这个 ip 已被使用，server 会将这个 ip 的租约设置为 decline-time(1hour)。然 后开始新的 DHCP 过程，从第 1 步开始。</p>
<p> 7、当 client 成功获取 IP 地址后，会根据 IP 地址使用租期自动启动续延过程，在使用租期 过去 50％时，向 DHCP server 发送单播 DHCPREQUEST 报文续延租期，如果成功即收到 DHCPACK 报文，则租期相应向前延长，如果没有收到 DHCPACK 报文，则继续使用这个 IP 地址。在使用租期过去 87.5％时，发送广播 DHCPREQUEST 报文续延租期，如果成功收到 DHCPACK 报文，则租期相应向前延长；如果失败即没有收到 DHCPACK 报文，继续使用这 个 IP 地址。在使用租期到期时，client 自动放弃使用这个 IP 地址，并开始新的 DHCP 过 程，从第 1 步开始。 </p>
<p>8、client 在成功获取 IP 地址后，随时可以通过发送 DHCPRELEASE 报文释放自己的 IP 地 址，DHCP server 收到 DHCPRELEASE 报文后，会回收相应的 IP 地址重新分配。 当存在 DHCP RELAY 时，所有的 DHCP 报文都会经过 DHCP RELAY 进行转发，整个 DHCP 交互过程同上面类型，只是在报文封装时，稍有不同。</p>
<h1 id="DHCPv6"><a href="#DHCPv6" class="headerlink" title="DHCPv6"></a>DHCPv6</h1><p>DHCPv6消息封装为UDP/IPv6数据报，它使用客户机端口546和服务器端口547.</p>
<p>一般情况下，O, M位来决定client是使用DHCPv6还是无状态自动配置，O,M都为0则是无状态自动配置。</p>
<h1 id="邻居发现协议"><a href="#邻居发现协议" class="headerlink" title="邻居发现协议"></a>邻居发现协议</h1><p>节点使用ND发现彼此在同一链路上的存在，确定彼此的链路层地址，执行重复地址检测（DAD, duplicate address detection），发现服务于子网的路由器，自动配置默认网关，发现它们连接的子网地址，以及维护路径的可达性信息。</p>
<p>路由器使用ND来发布它们的存在、子网前缀、路由和主机配置参数。如果一个特定的目的地有更好的路由可用，路由器也会使用这个消息来通知主机。</p>
<p>邻居发现协议类型</p>
<h2 id="Router-advertisement"><a href="#Router-advertisement" class="headerlink" title="Router advertisement"></a>Router advertisement</h2><p>IPv6路由器使用此消息在链路上发布它的存在。此消息包含连接上的接口用来配置自己的信息。这些信息包括路由器的IP地址、链路层地址、是否可以作为默认网关路由器、子网前缀、链路MTU、具体路由、网络中是否有DHCPv6服务器、接口是否可以通过地址自动配置特性配置地址、如果是，地址将有效的持续时间。</p>
<p>如果DHCPv6服务器可用，则在路由器公告中使用两个标志来标识该服务器。这些标志是托管地址配置标志和其他配置标志。M位和O位分别用来设置这些标志。M位表示DHCPv6服务可用于地址和配置设置。O位表示DHCPv6服务中除IP地址外的其他配置参数是否可用。</p>
<p>路由器定期发送Router Advertisement消息。advertisements之间的间隔是随机的，以减少同步性.</p>
<p><img src="/2021/09/25/rt-dev/lt10-01-router-advertisement.png"></p>
<h3 id="Router-Solicitation"><a href="#Router-Solicitation" class="headerlink" title="Router Solicitation"></a>Router Solicitation</h3><p>主机发送此消息请求链路上的IPv6路由器立即生成Router Advertisements，而不是在它们的下一次预定时间。当路由器收到一个Router Solicitatjion时，它会立即响应该消息。它向发送方主机发送一个Router Advertisement。与路由器周期性发送的advertisement不同的是，该advertisement只针对特定的主机，而周期性通告则针对链路上的所有主机。</p>
<p><img src="/2021/09/25/rt-dev/lt10-02-router-solicitation.png"></p>
<h3 id="Neighbor-Solicitation"><a href="#Neighbor-Solicitation" class="headerlink" title="Neighbor Solicitation"></a>Neighbor Solicitation</h3><p>节点主要出于三个目的使用此消息;确定邻居的链路层地址，检查已经确定的地址的有效性，并检查通过地址自动配置过程创建的地址是否唯一。</p>
<p>因为在第一个目的中，目的地址不可用，所以节点组播邻居请求消息。在剩下的两个目的中，由于目的地址是可用的，节点单播邻居请求消息。</p>
<h3 id="Neighbor-Advertisement"><a href="#Neighbor-Advertisement" class="headerlink" title="Neighbor Advertisement"></a>Neighbor Advertisement</h3><p>节点使用此消息响应Neighbor Solicitation消息。如果一个节点收到了一个neighbor solicitation消息，它会向发送方节点发送一个neighbor advertisement消息。节点也使用此消息来宣布链路层地址的变化。此消息包含节点确定neighbor advertisement消息的类型、发送方的链路层地址和发送方在网络中的角色所需的信息。</p>
<p>邻居请求和邻居公告示例如下</p>
<p><img src="/2021/09/25/rt-dev/lt10-03-neigbor-soliciation-and-neigbor-adertisement.png"></p>
<h3 id="Redirect-message"><a href="#Redirect-message" class="headerlink" title="Redirect message"></a>Redirect message</h3><p>IPv6路由器使用此消息通知原始主机关于一个特定目的地更好的下一跳地址。只有路由器可以为单播流量发送重定向消息。重定向消息仅由主机处理。</p>
<p><img src="/2021/09/25/rt-dev/lt10-04-redirect-message.png"></p>
<h3 id="Neighbor-Discovery-processes"><a href="#Neighbor-Discovery-processes" class="headerlink" title="Neighbor Discovery processes"></a>Neighbor Discovery processes</h3><p>The following table summarizes the processes that use the neighbor discovery messages.</p>
<table>
<thead>
<tr>
<th><strong>Process</strong></th>
<th><em>What does happen in this process?</em></th>
</tr>
</thead>
<tbody><tr>
<td>Router discovery</td>
<td>Hosts discover the routers attached on the same link.</td>
</tr>
<tr>
<td>Prefix discovery</td>
<td>Hosts discover the subnet or network prefixes for local link destinations.</td>
</tr>
<tr>
<td>Parameter discovery</td>
<td>Hosts discover additional  parameters and configuration settings including the link MTU (Maximum  Transmission Unit) and the default hop limit for outgoing packets.</td>
</tr>
<tr>
<td>Address auto-configuration</td>
<td>Interfaces configure their IP addresses either in the presence or absence of a DCHPv6 server.</td>
</tr>
<tr>
<td>Address resolution</td>
<td>Nodes resolve a neighbor’s IPv6 address to its link-layer address.</td>
</tr>
<tr>
<td>Next-hop determination</td>
<td>A node determines the device to  which a packet is being forwarded, based on the destination address. If  the destination address is available in the local link, the next-hop  address is the destination address. If the destination address is not  available in the local link, the next-hop address is the address of an  on-link default router.</td>
</tr>
<tr>
<td>Neighbor unreachability detection</td>
<td>A node determines whether a specific neighbor is still available on the on-link or has moved to a different link.</td>
</tr>
<tr>
<td>Duplicate address detection</td>
<td>A node determines whether an address selected by it for use is not already in use by a neighboring node.</td>
</tr>
<tr>
<td>Redirect function</td>
<td>A router informs a host about a better first-hop address to reach a destination.</td>
</tr>
</tbody></table>
<p>DHCPv6S</p>
<p>过程：</p>
<p><img src="/2021/09/25/rt-dev/dhcpv6_dhcpv6_server.png"></p>
<p>NS为客户机分配一个local IPv6地址，ff02开头 Neighbor solicitation</p>
<p>cli -&gt; ff02::2 RS</p>
<p>server -&gt; ff02::1 RA 其中带M,O</p>
<p>DHCPv6 </p>
<p>cli -&gt; server SOLICIT </p>
<p>​    其中包含事务ID,包含适合和6字节MAC地址的DUID。IA,IAID, IA中有T1=0, T2=0有server来决定。</p>
<p>​    Full Qualified Domain Name其中要求server提供DNS。主要是要server提供哪些</p>
<p>server-&gt; Advertise</p>
<p>​    提供一个全球地址，其首选生命周期和有效生命周期分别为130s和200s. DNS.</p>
<p>cli-&gt;REQUEST</p>
<p>server-&gt; reply</p>
<ul>
<li><p>无状态DHCP自动配置</p>
<p>首先发送Neighbor Solicitation来确定自己的local IPv6 IP地址</p>
<p>然后以这个地址向ff02::2广播ICMPv6发送Router Solicitation</p>
<p>接着server回ff02::1 Router Advertisement</p>
</li>
</ul>
<p>/usr/sbin/dhcp6s -3 -c /tmp/dhcp6s.conf -i br0</p>
<blockquote>
<p>root@LBR20:/# cat /tmp/dhcp6s.conf<br>option domain-name-servers fe80::bea5:11ff:feae:15a7;<br>interface br0 {<br>  allow rapid-commit;<br>  address-pool pool_netgear 1800 86400;<br>};<br>pool pool_netgear {<br>  range 2408:840c:931e:7fc9::2 to 2408:840c:931e:7fc9::40;<br>};</p>
</blockquote>
<p>6netconf/6service<br>mobile_start<br>    write_config<br>        prefixinfo=<code>get_prefix</code><br>        get_prefix<br>            local ip6=<code>ifconfig $WAN |grep &quot;inet6 addr&quot; |grep -v &quot;Link&quot; |awk &#39;&#123;print $3&#125;&#39;|head -n1</code><br>      local prelen=<code>ifconfig $WAN |grep &quot;inet6 addr&quot; |grep -v &quot;Link&quot; |awk &#39;&#123;print $3&#125;&#39;|cut -f2 -d&#39;/&#39;|head -n1</code><br>      printf “$DHCP6S_DEFAULT_TIME  $DHCP6S_PREFER_TIME  %s  %s” <code>format_prefix $ip6 $prelen</code> $prelen<br>        get_dns<br>            cat /tmp/IPV6_DNS<br>        lease_time, prefer_time, prefix, get from prefixinfo</p>
<pre><code>start_radvd
    /etc/init.d/radvd.init start
        procd_open_instance radvd
        procd_set_param command /usr/sbin/radvd -d 1 -C /tmp/radvd.conf
start_dhcp6s
    /usr/sbin/dhcp6s -3 -c dhcp6s_conf -i br0
    /etc/init.d/ripngd restart
    /etc/init.d/zebra restart
</code></pre>
<p>main</p>
<p>case ‘3’:<br>    duid_type = 3</p>
<p>case ‘i’:<br>    disabled = 3</p>
<p>cfparse(conf)<br>    yyparse()</p>
<p>server6_init(device)<br>    lease_Init()<br>    get our DUID from /tmp/dhcp6s_duid<br>    dhcp6_ctl_authinit(ctlkeyfile, &amp;ctlkey, &amp;ctldigestlen) //from /tmp/dhcp6sctlkey<br>    initialize send/receive buffer<br>    initialize socket<br>    insock port “547” ff02::1:2// “547” ff02::1:2<br>    outsokc port “546”<br>    /* set up contro socket */<br>    dhcp6_ctl_init(ctladdr, ctlport,DHCP6CTL_DEF_COMMANDQUEUELEN, &amp;ctlsock)</p>
<p>server6_mainloop()<br>    server6_recv(insock);</p>
<p>DH6_REPLY<br>    …<br>    run_script</p>
<p>​<br>process_icmp //just listen NAs or RAs<br>​    case: ND_NEIGHBOR_ADVERT //received ICMPv6 NA packet<br>​        process_na<br>​<br>​    case: ND_ROUTER_ADVERT:<br>​        process_ra<br>​            ND_OPT_PREFIX_INFORMATION<br>​            ND_OPT_RDNSS_INFORMATION<br>​            </p>
<pre><code>        /* add the default gateway &amp; wan ipv6&#39;s prefix len &amp; process rdnss info */
        process_gw_and_dns
            add_df_gw
            process_prefix
            process_dns
                ra_dns_script
                run_script
                    argv[0]=scriptpath; argv[1]=NULL
                    execve(scriptpath, argv, envp)
</code></pre>
<p>ICMPv6 Router Advertisement中包含默认路由器全局地址前缀的位置以及是否可用的信息，也包含NDS服务器的位置。    </p>
<p>RADVD<br>    /* get a raw socket for sending and receiving ICMPv6 messages */<br>    sock = open_icmpv6_socket();<br>    readin_config(conf_file) &lt; 0<br>    recv_rs_ra(sock, msg, &amp;rcv_addr, &amp;pkt_info, &amp;hoplimit);<br>    process(sock, IfaceList, msg, len,<br>                &amp;rcv_addr, pkt_info, hoplimit);<br>        ND_ROUTER_ADVERT</p>
<pre><code>    ND_ROUTER_SOLICIT
    
    process_rs
        send_ra_forall
            send_ra
    process_ra
        ND_OPT_MTU
        ND_OPT_PREFIX_INFORMATION
        ND_OPT_ROUTE_INFORMATION
        ...
        ND_OPT_RDNSS_INFORMATION
</code></pre>
<p>​<br>cmdroute<br>​    Modify_StaticRoutes<br>​        add_static_route<br>​<br>​        add_dhcp_route<br>​        add_ppp_route            </p>
<h1 id="TR069"><a href="#TR069" class="headerlink" title="TR069"></a>TR069</h1><p>client boot</p>
<blockquote>
<p>POST /openacs/acs HTTP/1.1</p>
<p>Host: 10.156.22.64:8080</p>
<p>Accept-Encoding: gzip, deflate</p>
<p>User-Agent: avsystem-demo/1.0 avsystem-libcwmp/5.6.2</p>
<p>Content-Type: text/xml; charset=utf-8</p>
<p>SOAPAction: cwmp:Inform</p>
<p>Content-Length: 1854</p>
<p>&lt;soap:Envelope xmlns:soap=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> xmlns:soap-enc=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;">http://schemas.xmlsoap.org/soap/encoding/&quot;</a> xmlns:xsi=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance&quot;">http://www.w3.org/2001/XMLSchema-instance&quot;</a> xmlns:xsd=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</a> xmlns:cwmp=”urn:dslforum-org:cwmp-1-2”&gt;<a href="soap:Header">soap:Header</a>&lt;cwmp:ID soap:mustUnderstand=”1”&gt;6357200098600682417&lt;cwmp:SupportedCWMPVersions soap:mustUnderstand=”0”&gt;1.0,1.1,1.2,1.3,1.4<a href="soap:Body">soap:Body</a><a href="cwmp:Inform">cwmp:Inform</a><DeviceId><Manufacturer>NETGEAR</Manufacturer><OUI>BCA511</OUI><ProductClass>LBR20</ProductClass><SerialNumber>BTA10154F0005</SerialNumber></DeviceId><Event soap-enc:arraytype="cwmp:EventStruct[1]"><EventStruct><EventCode>1 BOOT</EventCode><CommandKey></CommandKey></EventStruct></Event><MaxEnvelopes>1</MaxEnvelopes><CurrentTime>2021-07-12T07:29:49+00:00</CurrentTime><RetryCount>0</RetryCount><ParameterList soap-enc:arraytype="cwmp:ParameterValueStruct[6]"><ParameterValueStruct><Name>Device.RootDataModelVersion</Name><Value xsi:type="xsd:string">2.0</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.DeviceInfo.HardwareVersion</Name><Value xsi:type="xsd:string">LBR20</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.DeviceInfo.SoftwareVersion</Name><Value xsi:type="xsd:string">V2.6.5.14</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.DeviceInfo.ProvisioningCode</Name><Value xsi:type="xsd:string">AVS.1353581250.847996</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.ManagementServer.ParameterKey</Name><Value xsi:type="xsd:string">unsetCommandKey</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.ManagementServer.ConnectionRequestURL</Name><Value xsi:type="xsd:string"><a target="_blank" rel="noopener" href="http://10.156.22.56:12345/">http://10.156.22.56:12345/</a></Value></ParameterValueStruct></ParameterList>HTTP/1.1 200 OK</p>
<p>Server: Apache-Coyote/1.1</p>
<p>X-Powered-By: Servlet 2.4; JBoss-4.2.2.GA (build: SVNTag=JBoss_4_2_2_GA date=200710221139)/Tomcat-5.5</p>
<p>Set-Cookie: JSESSIONID=B6432E4C3AC74FB8C16C07864DC25234; Path=/</p>
<p>Content-Type: text/xml;charset=utf-8</p>
<p>Content-Length: 583</p>
<p>Date: Mon, 12 Jul 2021 07:29:49 GMT</p>
<p>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENC=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;">http://schemas.xmlsoap.org/soap/encoding/&quot;</a> xmlns:SOAP-ENV=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> xmlns:cwmp=”urn:dslforum-org:cwmp-1-0” xmlns:xsd=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</a> xmlns:xsi=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance&quot;&gt;">http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</a><a href="SOAP-ENV:Header">SOAP-ENV:Header</a>&lt;cwmp:ID SOAP-ENV:mustUnderstand=”1”&gt;6357200098600682417<a href="cwmp:NoMoreRequests">cwmp:NoMoreRequests</a>0<a href="SOAP-ENV:Body">SOAP-ENV:Body</a>&lt;cwmp:InformResponse xmlns:cwmp=”urn:dslforum-org:cwmp-1-0”&gt;<MaxEnvelopes>1</MaxEnvelopes>POST /openacs/acs HTTP/1.1</p>
<p>Host: 10.156.22.64:8080</p>
<p>Accept-Encoding: gzip, deflate</p>
<p>User-Agent: avsystem-demo/1.0 avsystem-libcwmp/5.6.2</p>
<p>Cookie: JSESSIONID=B6432E4C3AC74FB8C16C07864DC25234</p>
<p>Content-Length: 0</p>
<p>HTTP/1.1 200 OK</p>
<p>Server: Apache-Coyote/1.1</p>
<p>X-Powered-By: Servlet 2.4; JBoss-4.2.2.GA (build: SVNTag=JBoss_4_2_2_GA date=200710221139)/Tomcat-5.5</p>
<p>Content-Type: text/xml;charset=UTF-8</p>
<p>Content-Length: 723</p>
<p>Date: Mon, 12 Jul 2021 07:29:49 GMT</p>
<p>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENC=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;">http://schemas.xmlsoap.org/soap/encoding/&quot;</a> xmlns:SOAP-ENV=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> xmlns:cwmp=”urn:dslforum-org:cwmp-1-0” xmlns:xsd=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</a> xmlns:xsi=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance&quot;&gt;">http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</a><a href="SOAP-ENV:Header">SOAP-ENV:Header</a>&lt;cwmp:ID SOAP-ENV:mustUnderstand=”1”&gt;ID:intrnl.unset.id.GetParameterValues1626078589297.1177106648<a href="cwmp:NoMoreRequests">cwmp:NoMoreRequests</a>0<a href="SOAP-ENV:Body">SOAP-ENV:Body</a>&lt;cwmp:GetParameterValues xmlns:cwmp=”urn:dslforum-org:cwmp-1-0”&gt;<ParameterNames soap-enc:arraytype="xsd:string[1]"><string>Device.NAT.PortForwardingConnected.</string></ParameterNames>POST /openacs/acs HTTP/1.1</p>
<p>Host: 10.156.22.64:8080</p>
<p>Accept-Encoding: gzip, deflate</p>
<p>User-Agent: avsystem-demo/1.0 avsystem-libcwmp/5.6.2</p>
<p>Cookie: JSESSIONID=B6432E4C3AC74FB8C16C07864DC25234</p>
<p>Content-Type: text/xml; charset=utf-8</p>
<p>SOAPAction: </p>
<p>Content-Length: 1531</p>
<p>&lt;soap:Envelope xmlns:soap=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/envelope/&quot;">http://schemas.xmlsoap.org/soap/envelope/&quot;</a> xmlns:soap-enc=”<a target="_blank" rel="noopener" href="http://schemas.xmlsoap.org/soap/encoding/&quot;">http://schemas.xmlsoap.org/soap/encoding/&quot;</a> xmlns:xsi=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance&quot;">http://www.w3.org/2001/XMLSchema-instance&quot;</a> xmlns:xsd=”<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</a> xmlns:cwmp=”urn:dslforum-org:cwmp-1-0”&gt;<a href="soap:Header">soap:Header</a>&lt;cwmp:ID soap:mustUnderstand=”1”&gt;ID:intrnl.unset.id.GetParameterValues1626078589297.1177106648<a href="soap:Body">soap:Body</a><a href="cwmp:GetParameterValuesResponse">cwmp:GetParameterValuesResponse</a><ParameterList soap-enc:arraytype="cwmp:ParameterValueStruct[6]"><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.1.DeviceName</Name><Value xsi:type="xsd:string">Unknown</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.1.DeviceIP</Name><Value xsi:type="xsd:string">192.168.1.2</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.1.DeviceConnectionType</Name><Value xsi:type="xsd:string">Ethernet Connected</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.2.DeviceName</Name><Value xsi:type="xsd:string">CNSH1DNIPC001</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.2.DeviceIP</Name><Value xsi:type="xsd:string">192.168.1.2</Value></ParameterValueStruct><ParameterValueStruct><Name>Device.NAT.PortForwardingConnected.2.DeviceConnectionType</Name><Value xsi:type="xsd:string">Ethernet Connected</Value></ParameterValueStruct></ParameterList>HTTP/1.1 204 No Content</p>
<p>Server: Apache-Coyote/1.1</p>
<p>X-Powered-By: Servlet 2.4; JBoss-4.2.2.GA (build: SVNTag=JBoss_4_2_2_GA date=200710221139)/Tomcat-5.5</p>
<p>Date: Mon, 12 Jul 2021 07:29:56 GMT</p>
</blockquote>
<p>TR-069协议的过程</p>
<p><img src="/2021/09/25/rt-dev/20150925085529449.png"></p>
<ol>
<li>CPE和ACS建立TCP连接</li>
<li>SSL初始化进行双向认证。</li>
<li>CPE发送Inform报文，开始建立CWMP连接。Inform报文Eventcode字段描述发送Inform报文的原因，通常为“0 BOOTSTRAP”, 表示CPE首次启动建立连接。</li>
<li>如果CPE通过ACS的认证，ACS将返回Inform响应报文，连接建立完成。</li>
<li>如果CPE没有别的请求，就会发送一个HTTP POST请求，内容为空，以满足HTTP报文请求/响应交换规则。</li>
<li>ACS查询CPE上设置的轮询通知间隔的值等。</li>
<li>CPE把自身的轮询通知间隔返回给ACS.</li>
<li>ACS发现轮询通知间隔值设置不符合服务器配置于是发起设置请求，要求将CPE的轮询通知间隔设置为1800.</li>
<li>设置成功后，CPE发送响应报文。</li>
<li>ACS发送空报文通知CPE没有别的请求了。</li>
<li>CPE关闭连接。</li>
</ol>
<p>以下为设备重启到挂上TR069网管的报文流程解析</p>
<ul>
<li>(1) 设备启动；根据配置的ACS(自动配置服务器)地址，建立安全的HTTP连接以后，每次连接CPE都必须首先对ACS发出一个Inform的RPC调用请求来向ACS汇报本次连接的信息。ACS会返回给一个Inform response作为确认连接。</li>
</ul>
<p><strong>标准的Inform方法的参数如表所示</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>DeviceID</td>
<td>数据结构标识CPE</td>
</tr>
<tr>
<td>Event</td>
<td>标识此次Inform发起的原因</td>
</tr>
<tr>
<td>MaxEnvelopes</td>
<td>HTTP Response可携带SOAP信封数</td>
</tr>
<tr>
<td>CurrentTime</td>
<td>CPE当前的时间</td>
</tr>
<tr>
<td>RetryCount</td>
<td>这次Session最大的重复连接次数</td>
</tr>
<tr>
<td>ParameterList</td>
<td>这次Inform所需携带的参数</td>
</tr>
</tbody></table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">POST /service.tr069 HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">183.62</span><span class="number">.12</span><span class="number">.23</span>:<span class="number">8012</span></span><br><span class="line">User-Agent: cwmp</span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">Connection</span>: keep-alive</span><br><span class="line">Content-Length: <span class="number">1730</span></span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope </span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> </span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> </span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> </span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>946684824<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- inform方法任何时刻要建立与ACS的连接，都必须调用Inform方法--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 来初始化一个传输序列,向ACS服务器上报一些事件，具体事件就携带在EventCode --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:Inform</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 设备描述信息 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">DeviceId</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 设备厂商 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Manufacturer</span>&gt;</span>star-net<span class="tag">&lt;/<span class="name">Manufacturer</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 设备制造商的唯一标示 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">OUI</span>&gt;</span>00D0F8<span class="tag">&lt;/<span class="name">OUI</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 设备类型 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ProductClass</span>&gt;</span>SVP3000_V5_SIP_CN<span class="tag">&lt;/<span class="name">ProductClass</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 设备序列号 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">SerialNumber</span>&gt;</span>00100400RJ0100100000001AA9800003<span class="tag">&lt;/<span class="name">SerialNumber</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">DeviceId</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 引起此次会话建立的具体事件 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Event</span> <span class="attr">SOAP-ENC:arrayType</span>=<span class="string">&quot;cwmp:EventStruct[1]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">EventStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 上报BOOT事件，也就是告诉ACS要发起CWMP连接了 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 1 boot表明发起会话的原因是设备上电(首次启动或者其他原因引起的设备重启) --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">EventCode</span>&gt;</span>1 BOOT<span class="tag">&lt;/<span class="name">EventCode</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">CommandKey</span>&gt;</span><span class="tag">&lt;/<span class="name">CommandKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">EventStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Event</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 接收响应的允许SOAP信包数目，0表示无限制 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">MaxEnvelopes</span>&gt;</span>1<span class="tag">&lt;/<span class="name">MaxEnvelopes</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- cpe当前的时间 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">CurrentTime</span>&gt;</span>2000-01-01T08:00:23<span class="tag">&lt;/<span class="name">CurrentTime</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 完成inform调用前尝试的次数每次加1 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">RetryCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">RetryCount</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- CPE设备参数列表--&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">ParameterList</span> <span class="attr">SOAP-ENC:arrayType</span>=<span class="string">&quot;cwmp:ParameterValueStruct[6]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 设备描述信息 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceSummary<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>Device:1.0[](Baseline:1), VoiceService:1.0[1](Baseline:1)<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 设备的硬件版本信息 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.HardwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>5.0<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 设备的软件版本信息 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.SoftwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>AIM1.3.10.8<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 请求URL(设备联系地址) --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ConnectionRequestURL<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>http://192.168.99.17:7547/<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 对某些方法的调用会导致该值的该改变如 Scheduled Inform、reboot、download、upload方法 --&gt;</span> </span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 除此以外的调用该值均为空，此消息中设备只调用了 inform方法，故该值应该置为空 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ParameterKey<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 设备ip地址 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.LAN.IPAddress<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>192.168.99.17<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ParameterList</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:Inform</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line">&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cwmp:Inform&gt;<span class="xml"><span class="tag">&lt;<span class="name">DeviceId</span>&gt;</span><span class="tag">&lt;<span class="name">Manufacturer</span>&gt;</span>NETGEAR<span class="tag">&lt;/<span class="name">Manufacturer</span>&gt;</span><span class="tag">&lt;<span class="name">OUI</span>&gt;</span>201407<span class="tag">&lt;/<span class="name">OUI</span>&gt;</span><span class="tag">&lt;<span class="name">ProductClass</span>&gt;</span>LBR20<span class="tag">&lt;/<span class="name">ProductClass</span>&gt;</span><span class="tag">&lt;<span class="name">SerialNumber</span>&gt;</span>BTA11854B1537<span class="tag">&lt;/<span class="name">SerialNumber</span>&gt;</span><span class="tag">&lt;/<span class="name">DeviceId</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">Event</span> <span class="attr">soap-enc:arrayType</span>=<span class="string">&quot;cwmp:EventStruct[1]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">EventStruct</span>&gt;</span><span class="tag">&lt;<span class="name">EventCode</span>&gt;</span>1 BOOT<span class="tag">&lt;/<span class="name">EventCode</span>&gt;</span><span class="tag">&lt;<span class="name">CommandKey</span>&gt;</span><span class="tag">&lt;/<span class="name">CommandKey</span>&gt;</span><span class="tag">&lt;/<span class="name">EventStruct</span>&gt;</span><span class="tag">&lt;/<span class="name">Event</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">MaxEnvelopes</span>&gt;</span>1<span class="tag">&lt;/<span class="name">MaxEnvelopes</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">CurrentTime</span>&gt;</span>2021-09-09T09:08:09+00:00<span class="tag">&lt;/<span class="name">CurrentTime</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">RetryCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">RetryCount</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">ParameterList</span> <span class="attr">soap-enc:arrayType</span>=<span class="string">&quot;cwmp:ParameterValueStruct[6]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.RootDataModelVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.HardwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>LBR20<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.SoftwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>V2.6.5.14<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.ProvisioningCode<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>AVS.1353581250.847996<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ParameterKey<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>unsetCommandKey<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ConnectionRequestURL<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>http://10.156.22.101:54321/<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterList</span>&gt;</span></span>&lt;/cwmp:Inform&gt;</span><br></pre></td></tr></table></figure>



<p>iDeviceId, Manufacturer</p>
<ul>
<li><ol start="2">
<li>ACS服务器接受到设备端(CPE端)发出的inform消息之后，会给予一个 inform response响应机cwmp连接创建成功</li>
</ol>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OKDate: Tue, <span class="number">02</span> Aug <span class="number">2011</span> <span class="number">03</span>:<span class="number">20</span>:<span class="number">53</span> GMTServer: Microsoft-IIS/<span class="number">6.</span>0X-Powered-By: ASP.NETX-AspNet-Version: <span class="number">2.0</span>.50727<span class="built_in">Set</span>-Cookie: SerialNumber=00100400RJ0100100000001AA9800003; path=<span class="regexp">/Cache-Control: privateContent-Type: text/</span>xml;charset=UTF-8Content-Length: <span class="number">522</span>&lt;!-- 对设备端inform消息的响应即接受连接请求 --&gt;<span class="xml"><span class="tag">&lt;<span class="name">soap:Envelope</span>  <span class="attr">xmlns:soap</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>  <span class="attr">xmlns:cwmp</span>=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>  <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  <span class="attr">xmlns:SOAP-ENC</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;</span>  <span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span>    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>946684824<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span>    <span class="tag">&lt;<span class="name">cwmp:HoldRequests</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:HoldRequests</span>&gt;</span>  <span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span>  <span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span>    <span class="comment">&lt;!-- ACS接受设备端(cpe)端的inform请求(即创建cwmp连接的请求) --&gt;</span>    <span class="tag">&lt;<span class="name">cwmp:InformResponse</span>&gt;</span>      <span class="tag">&lt;<span class="name">MaxEnvelopes</span>&gt;</span>1<span class="tag">&lt;/<span class="name">MaxEnvelopes</span>&gt;</span>    <span class="tag">&lt;/<span class="name">cwmp:InformResponse</span>&gt;</span>  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>(3) 设备端发送空消息，表示没有后续的请求</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /service.tr069 HTTP/<span class="number">1.</span>1Host: <span class="number">183.62</span><span class="number">.12</span><span class="number">.23</span>:<span class="number">8012</span>  User-Agent: cwmpContent-Type: text/xml; charset=utf-8Connection: keep-aliveCookie: SerialNumber=00100400RJ0100100000001AA9800003;path=/Content-Length: <span class="number">0</span>&lt;!-- Host: ACS(自动配置服务器)地址 --&gt;&lt;!-- Cookie: 设置在设备的序列号--&gt;&lt;!-- Content-Length: 消息内容长度为<span class="number">0</span>代表空消息--&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(4) ACS服务器收到空消息后，根据空消息中携带的序列号对设备进行合法性验证，若验证通过则进行后续操作，若不通过则下发消息提示设备非法。序列号的判断在ACS内部判断，未体现在报文中</li>
<li>(5) ACS验证设备序列号合法，发送消息要求设备端上报网管的账号信息</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attr">Date</span>: Tue, <span class="number">02</span> Aug <span class="number">2011</span> <span class="number">03</span>:<span class="number">20</span>:<span class="number">53</span> GMT</span><br><span class="line"><span class="attr">Server</span>: Microsoft-IIS/<span class="number">6.0</span></span><br><span class="line">X-Powered-By: ASP.NET</span><br><span class="line">X-AspNet-Version: <span class="number">2.0</span><span class="number">.50727</span></span><br><span class="line"><span class="built_in">Set</span>-Cookie: SerialNumber=00100400RJ0100100000001AA9800003; path=/</span><br><span class="line">Cache-Control: private</span><br><span class="line">Content-Type: text/xml;charset=UTF-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">658</span></span><br><span class="line"></span><br><span class="line">&lt;soap:Envelope  xmlns:soap=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span> </span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:HoldRequests</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:HoldRequests</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 请求的方法为GetParameterValues，获取设备端的参数信息 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:GetParameterValues</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &lt;ParameterNamesSOAP-ENC:arrayType=&quot;xsd:string[2]&quot;&gt;</span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 获取设备TR069网管用户名 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>Device.ManagementServer.Username<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 获取设备TR069网管密码 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>Device.ManagementServer.Password<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ParameterNames</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:GetParameterValues</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span></span><br><span class="line">&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(6) 设备端接收该ACS服务器请求上报账号的消息后，将发送设备上配置的账号信息作为请求的响应</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">183.62</span><span class="number">.12</span><span class="number">.23</span>:<span class="number">8012</span></span><br><span class="line">User-Agent: cwmp</span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">Connection</span>: keep-alive</span><br><span class="line"><span class="attr">Cookie</span>: SerialNumber=00100400RJ0100100000001AA9800003;path=/</span><br><span class="line">Content-Length: <span class="number">828</span></span><br><span class="line"><span class="attr">SOAPAction</span>: <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope  xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 将账号信息作为ACS请求的响应消息 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:GetParameterValuesResponse</span>&gt;</span>      </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">ParameterList</span> <span class="attr">xsi:type</span>=<span class="string">&quot;SOAP-ENC:Array&quot;</span> <span class="attr">SOAP-ENC:arrayType</span>=<span class="string">&quot;cwmp:ParameterValueStruct[2]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 设置在设备上的网管用户名 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.Username<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 用户名的具体值 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>66661160<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 设置在设备上的网管密码 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.Password<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="comment">&lt;!-- 密码的具体值 --&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Value</span>&gt;</span>66661160<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ParameterList</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:GetParameterValuesResponse</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line">&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(7) ACS服务器收到消息后，根据消息中携带的账号信息进行合法性验证，若验证通过则进行后续操作，若不通过则下发消息提示账号非法。序列号的判断在ACS内部判断，未体现在报文中</li>
<li>(8) ACS验证账号合法，发送消息要求设备从特定URL上下载配置文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attr">Date</span>: Tue, <span class="number">02</span> Aug <span class="number">2011</span> <span class="number">03</span>:<span class="number">21</span>:<span class="number">04</span> GMT</span><br><span class="line"><span class="attr">Server</span>: Microsoft-IIS/<span class="number">6.0</span></span><br><span class="line">X-Powered-By: ASP.NET</span><br><span class="line">X-AspNet-Version: <span class="number">2.0</span><span class="number">.50727</span></span><br><span class="line"><span class="built_in">Set</span>-Cookie: SerialNumber=00100400RJ0100100000001AA9800003; path=/</span><br><span class="line">Cache-Control: private</span><br><span class="line">Content-Type: text/xml;charset=UTF-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">856</span></span><br><span class="line"></span><br><span class="line">&lt;soap:Envelope  xmlns:soap=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:HoldRequests</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:HoldRequests</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:Download</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">CommandKey</span>&gt;</span>M Download<span class="tag">&lt;/<span class="name">CommandKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 文件类型 配置文件--&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FileType</span>&gt;</span>3 Vendor Configuration File<span class="tag">&lt;/<span class="name">FileType</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 配置文件的URL地址，设备端从该地址获取配置文件并自动载入设备 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">URL</span>&gt;</span>http://183.62.12.23:8012/Config.aspx?ID=00100400RJ0100100000001AA9800003<span class="tag">&lt;/<span class="name">URL</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Description</span>&gt;</span><span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Username</span>&gt;</span><span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Password</span>&gt;</span><span class="tag">&lt;/<span class="name">Password</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FileSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">FileSize</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">TargetFileName</span>&gt;</span>ConfigFile.xml<span class="tag">&lt;/<span class="name">TargetFileName</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">DelaySeconds</span>&gt;</span>0<span class="tag">&lt;/<span class="name">DelaySeconds</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">SuccessURL</span>&gt;</span><span class="tag">&lt;/<span class="name">SuccessURL</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FailureURL</span>&gt;</span><span class="tag">&lt;/<span class="name">FailureURL</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:Download</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span></span><br><span class="line">&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(9) 设备接收到该消息之后，并根据消息中的URL地址下载配置文件并自动配置，同时给ACS服务器一个下载成功的响应消息</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Host: <span class="number">183.62</span><span class="number">.12</span><span class="number">.23</span>:<span class="number">8012</span></span><br><span class="line">User-Agent: cwmp</span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">Connection</span>: keep-alive</span><br><span class="line"><span class="attr">Cookie</span>: SerialNumber=00100400RJ0100100000001AA9800003;path=/</span><br><span class="line">Content-Length: <span class="number">484</span></span><br><span class="line"><span class="attr">SOAPAction</span>: <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope  xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 通过该消息告知ACS服务器设备成功获取配置文件 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:DownloadResponse</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 成功下载的状态码 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Status</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Status</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:DownloadResponse</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line">&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(10) ACS服务器发送消息，要求设备从特定的URL下载升级文件(是否升级可由用户自行决定)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attr">Date</span>: Tue, <span class="number">02</span> Aug <span class="number">2011</span> <span class="number">03</span>:<span class="number">21</span>:<span class="number">04</span> GMT</span><br><span class="line"><span class="attr">Server</span>: Microsoft-IIS/<span class="number">6.0</span></span><br><span class="line">X-Powered-By: ASP.NET</span><br><span class="line">X-AspNet-Version: <span class="number">2.0</span><span class="number">.50727</span></span><br><span class="line"><span class="built_in">Set</span>-Cookie: SerialNumber=00100400RJ0100100000001AA9800003; path=/</span><br><span class="line">Cache-Control: private</span><br><span class="line">Content-Type: text/xml;charset=UTF-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">889</span></span><br><span class="line"></span><br><span class="line">&lt;soap:Envelope  xmlns:soap=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span> </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:HoldRequests</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:HoldRequests</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span> </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:Download</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">CommandKey</span>&gt;</span>M Download<span class="tag">&lt;/<span class="name">CommandKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 文件类型升级文件 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FileType</span>&gt;</span>1 Firmware Upgrade Image<span class="tag">&lt;/<span class="name">FileType</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 升级文件的URL地址，设备端从该地址获取配置文件并自动载入设备 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">URL</span>&gt;</span>http://183.62.12.23:8010/DeviceSoftWareVersion/20110714/svp3000.update<span class="tag">&lt;/<span class="name">URL</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Description</span>&gt;</span><span class="tag">&lt;/<span class="name">Description</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Username</span>&gt;</span><span class="tag">&lt;/<span class="name">Username</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Password</span>&gt;</span><span class="tag">&lt;/<span class="name">Password</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FileSize</span>&gt;</span>3493888<span class="tag">&lt;/<span class="name">FileSize</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">TargetFileName</span>&gt;</span>/DeviceSoftWareVersion/20110714/svp3000.update<span class="tag">&lt;/<span class="name">TargetFileName</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">DelaySeconds</span>&gt;</span>0<span class="tag">&lt;/<span class="name">DelaySeconds</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">SuccessURL</span>&gt;</span><span class="tag">&lt;/<span class="name">SuccessURL</span>&gt;</span> </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FailureURL</span>&gt;</span><span class="tag">&lt;/<span class="name">FailureURL</span>&gt;</span> </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:Download</span>&gt;</span>  </span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span></span><br><span class="line">&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(11) 设备接收到该消息之后，并根据消息中的URL地址获取升级文件，同时给予ACS服务器一个响应</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /service.tr069 HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">183.62</span><span class="number">.12</span><span class="number">.23</span>:<span class="number">8012</span></span><br><span class="line">User-Agent: cwmp</span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">Connection</span>: keep-alive</span><br><span class="line"><span class="attr">Cookie</span>: SerialNumber=00100400RJ0100100000001AA9800003;path=/</span><br><span class="line">Content-Length: <span class="number">484</span></span><br><span class="line"><span class="attr">SOAPAction</span>: <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope  xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> <span class="attr">xmlns</span>:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 通过该消息告知ACS服务器设备成功获取配置文件 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">cwmp:DownloadResponse</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 成功下载的状态码 --&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Status</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Status</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">cwmp:DownloadResponse</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span></span><br><span class="line">&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>(12) ACS服务器发送空消息结束流程</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Tue, 02 Aug 2011 03:21:05 GMT</span><br><span class="line">Server: Microsoft-IIS/6.0</span><br><span class="line">X-Powered-By: ASP.NET</span><br><span class="line">X-AspNet-Version: 2.0.50727</span><br><span class="line">Set-Cookie: SerialNumber=00100400RJ0100100000001AA9800003; path=/</span><br><span class="line">Cache-Control: private</span><br><span class="line">Content-Length: 0 </span><br><span class="line"></span><br><span class="line">&lt;!-- Content-Length: 消息内容长度为0代表空消息 --&gt;12345678910</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>TR069协议簇的其他规范</strong><br>TR069协议不仅仅包括TR-069子协议，还包括其他一些的协议，构成了一个完整的网管协议簇。与之配套的TR-098协议和TR-104协议分别定义了CPE的数据业务的管理参数和VoIP业务的管理参数，WT-135协议用于定义数字机顶盒的管理参数，TR-111协议定义了在家庭内部数字设备上实施TR069网管的机制，WT-121协议则是各个厂家在实现和部署TR069过程中对协议的修订。 </p>
<p>附件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">POST /openacs/acs HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">10.156</span><span class="number">.22</span><span class="number">.132</span>:<span class="number">8080</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">User-Agent: avsystem-demo/<span class="number">1.0</span> avsystem-libcwmp/<span class="number">5.6</span><span class="number">.2</span></span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">SOAPAction</span>: cwmp:Inform</span><br><span class="line">Content-Length: <span class="number">1856</span></span><br><span class="line"></span><br><span class="line">&lt;soap:Envelope xmlns:soap=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:soap-enc=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xmlns:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-2&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>16759009647336812618<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:SupportedCWMPVersions</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;0&quot;</span>&gt;</span>1.0,1.1,1.2,1.3,1.4<span class="tag">&lt;/<span class="name">cwmp:SupportedCWMPVersions</span>&gt;</span><span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:Inform</span>&gt;</span><span class="tag">&lt;<span class="name">DeviceId</span>&gt;</span><span class="tag">&lt;<span class="name">Manufacturer</span>&gt;</span>NETGEAR<span class="tag">&lt;/<span class="name">Manufacturer</span>&gt;</span><span class="tag">&lt;<span class="name">OUI</span>&gt;</span>201407<span class="tag">&lt;/<span class="name">OUI</span>&gt;</span><span class="tag">&lt;<span class="name">ProductClass</span>&gt;</span>LBR20<span class="tag">&lt;/<span class="name">ProductClass</span>&gt;</span><span class="tag">&lt;<span class="name">SerialNumber</span>&gt;</span>BTA11854B1537<span class="tag">&lt;/<span class="name">SerialNumber</span>&gt;</span><span class="tag">&lt;/<span class="name">DeviceId</span>&gt;</span><span class="tag">&lt;<span class="name">Event</span> <span class="attr">soap-enc:arrayType</span>=<span class="string">&quot;cwmp:EventStruct[1]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">EventStruct</span>&gt;</span><span class="tag">&lt;<span class="name">EventCode</span>&gt;</span>1 BOOT<span class="tag">&lt;/<span class="name">EventCode</span>&gt;</span><span class="tag">&lt;<span class="name">CommandKey</span>&gt;</span><span class="tag">&lt;/<span class="name">CommandKey</span>&gt;</span><span class="tag">&lt;/<span class="name">EventStruct</span>&gt;</span><span class="tag">&lt;/<span class="name">Event</span>&gt;</span><span class="tag">&lt;<span class="name">MaxEnvelopes</span>&gt;</span>1<span class="tag">&lt;/<span class="name">MaxEnvelopes</span>&gt;</span><span class="tag">&lt;<span class="name">CurrentTime</span>&gt;</span>2021-09-09T09:08:09+00:00<span class="tag">&lt;/<span class="name">CurrentTime</span>&gt;</span><span class="tag">&lt;<span class="name">RetryCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">RetryCount</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterList</span> <span class="attr">soap-enc:arrayType</span>=<span class="string">&quot;cwmp:ParameterValueStruct[6]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.RootDataModelVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.HardwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>LBR20<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.SoftwareVersion<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>V2.6.5.14<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.DeviceInfo.ProvisioningCode<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>AVS.1353581250.847996<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ParameterKey<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>unsetCommandKey<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.ManagementServer.ConnectionRequestURL<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>http://10.156.22.101:54321/<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterList</span>&gt;</span><span class="tag">&lt;/<span class="name">cwmp:Inform</span>&gt;</span><span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span>&lt;<span class="regexp">/soap:Envelope&gt;HTTP/</span><span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attr">Server</span>: Apache-Coyote/<span class="number">1.1</span></span><br><span class="line">X-Powered-By: Servlet <span class="number">2.4</span>; JBoss-<span class="number">4.2</span><span class="number">.2</span>.GA (build: SVNTag=JBoss_4_2_2_GA date=<span class="number">200710221139</span>)/Tomcat-<span class="number">5.5</span></span><br><span class="line"><span class="built_in">Set</span>-Cookie: JSESSIONID=1ACE2A4FA966FBD9EA2625107101E140; Path=/</span><br><span class="line">Content-Type: text/xml;charset=utf-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">584</span></span><br><span class="line"><span class="attr">Date</span>: Thu, <span class="number">09</span> Sep <span class="number">2021</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">09</span> GMT</span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>16759009647336812618<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:NoMoreRequests</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:NoMoreRequests</span>&gt;</span><span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:InformResponse</span> <span class="attr">xmlns:cwmp</span>=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">MaxEnvelopes</span>&gt;</span>1<span class="tag">&lt;/<span class="name">MaxEnvelopes</span>&gt;</span><span class="tag">&lt;/<span class="name">cwmp:InformResponse</span>&gt;</span><span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span>&lt;<span class="regexp">/SOAP-ENV:Envelope&gt;POST /</span>openacs/acs HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">10.156</span><span class="number">.22</span><span class="number">.132</span>:<span class="number">8080</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">User-Agent: avsystem-demo/<span class="number">1.0</span> avsystem-libcwmp/<span class="number">5.6</span><span class="number">.2</span></span><br><span class="line"><span class="attr">Cookie</span>: JSESSIONID=1ACE2A4FA966FBD9EA2625107101E140</span><br><span class="line">Content-Length: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attr">Server</span>: Apache-Coyote/<span class="number">1.1</span></span><br><span class="line">X-Powered-By: Servlet <span class="number">2.4</span>; JBoss-<span class="number">4.2</span><span class="number">.2</span>.GA (build: SVNTag=JBoss_4_2_2_GA date=<span class="number">200710221139</span>)/Tomcat-<span class="number">5.5</span></span><br><span class="line">Content-Type: text/xml;charset=UTF-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">722</span></span><br><span class="line"><span class="attr">Date</span>: Thu, <span class="number">09</span> Sep <span class="number">2021</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">09</span> GMT</span><br><span class="line"></span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">SOAP-ENV:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>ID:intrnl.unset.id.GetParameterValues1631182089834.833271886<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:NoMoreRequests</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cwmp:NoMoreRequests</span>&gt;</span><span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:GetParameterValues</span> <span class="attr">xmlns:cwmp</span>=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterNames</span> <span class="attr">SOAP-ENC:arrayType</span>=<span class="string">&quot;xsd:string[1]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">string</span>&gt;</span>Device.NAT.PortForwardingConnected.<span class="tag">&lt;/<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterNames</span>&gt;</span><span class="tag">&lt;/<span class="name">cwmp:GetParameterValues</span>&gt;</span><span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span>&lt;<span class="regexp">/SOAP-ENV:Envelope&gt;POST /</span>openacs/acs HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="attr">Host</span>: <span class="number">10.156</span><span class="number">.22</span><span class="number">.132</span>:<span class="number">8080</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">User-Agent: avsystem-demo/<span class="number">1.0</span> avsystem-libcwmp/<span class="number">5.6</span><span class="number">.2</span></span><br><span class="line"><span class="attr">Cookie</span>: JSESSIONID=1ACE2A4FA966FBD9EA2625107101E140</span><br><span class="line">Content-Type: text/xml; charset=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">SOAPAction</span>: </span><br><span class="line">Content-Length: <span class="number">1054</span></span><br><span class="line"></span><br><span class="line">&lt;soap:Envelope xmlns:soap=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:soap-enc=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xmlns:cwmp=<span class="string">&quot;urn:dslforum-org:cwmp-1-0&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:ID</span> <span class="attr">soap:mustUnderstand</span>=<span class="string">&quot;1&quot;</span>&gt;</span>ID:intrnl.unset.id.GetParameterValues1631182089834.833271886<span class="tag">&lt;/<span class="name">cwmp:ID</span>&gt;</span><span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span><span class="tag">&lt;<span class="name">cwmp:GetParameterValuesResponse</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterList</span> <span class="attr">soap-enc:arrayType</span>=<span class="string">&quot;cwmp:ParameterValueStruct[3]&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.NAT.PortForwardingConnected.1.DeviceName<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>Unknown<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.NAT.PortForwardingConnected.1.DeviceIP<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>192.168.1.2<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;<span class="name">Name</span>&gt;</span>Device.NAT.PortForwardingConnected.1.DeviceConnectionType<span class="tag">&lt;/<span class="name">Name</span>&gt;</span><span class="tag">&lt;<span class="name">Value</span> <span class="attr">xsi:type</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span>Ethernet Connected<span class="tag">&lt;/<span class="name">Value</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterValueStruct</span>&gt;</span><span class="tag">&lt;/<span class="name">ParameterList</span>&gt;</span><span class="tag">&lt;/<span class="name">cwmp:GetParameterValuesResponse</span>&gt;</span><span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span>&lt;<span class="regexp">/soap:Envelope&gt;HTTP/</span><span class="number">1.1</span> <span class="number">204</span> No Content</span><br><span class="line"><span class="attr">Server</span>: Apache-Coyote/<span class="number">1.1</span></span><br><span class="line">X-Powered-By: Servlet <span class="number">2.4</span>; JBoss-<span class="number">4.2</span><span class="number">.2</span>.GA (build: SVNTag=JBoss_4_2_2_GA date=<span class="number">200710221139</span>)/Tomcat-<span class="number">5.5</span></span><br><span class="line"><span class="attr">Date</span>: Thu, <span class="number">09</span> Sep <span class="number">2021</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">12</span> GMT</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="LTE"><a href="#LTE" class="headerlink" title="LTE"></a>LTE</h1><p>preinit<br>/* busybox start <em>/<br>start_kernel<br>    mem_init …<br>    rest_init<br>        kernel_thread(kernel_init)<br>            sched_init_smp<br>            do_basic_setup<br>            run_init_process(“/etc/preinit”)<br>                preinit<br>                    main to mount file system<br>                    exec /sbin/init<br>                        /etc/inittab<br>                        /etc/init.d/rcS /</em> default sysinit script */</p>
<pre><code>    orbi will try to call /etc/preinit, /sbin/init/, /etc/init, /bin/init , /bin/sh
    
    sysinit: /etc/init.d/rcS S boot
    boot rc.d/process
    ...
    start_stage0 boot
        vlan(port) init
            net-lan start mode
                set the port ip and address and brctrl add some port to bridge
            net-wan start mode
                 mobile_wan start
                    echo 2000&gt;/proc/sys/net/core/netdev_max_backlog //max performance of LTE, packet loss. 1000 to 2000, there is not packet loss, this about 100Mbps for TCP
                    enable hot swap
                        lte_init_set //set otp disable B13, thermal set start
                        lte power-on
                        change band setting //according to region to set band            
                        change mbc setting
                        get mobile sim card state
                        dni_mobile_scan
                            get_iccid
                            accord iccid to get country,ISP,APN,PDP type,username,password
                            quectel_option_check
                            quectel-CM call
                            ping -c 8.8.8.8
                        or
                            wwan_connect
                                get LTE params to call
    set_dns//if static                            
    setup_interface_dhcp
</code></pre>
<p>dnichat /dev/ttyUSB2 at+<br>    exe_cmd<br>        set alarm signal to void precess dead<br>        OTA upgrade no timeout<br>        alarm(EXIT_TIMEOUT);</p>
<pre><code>    //init
    InitConn(115200, devstr)
        open(final_devname, O_RDWR | O_NOCTTY)
        ioctl(fd, TIOCEXCL);
        fcntl(fd, F_SETFL, 0);
        tcgetattr(fd, &amp;term);
        SendStrCmd(fd, cmdstr);
        ReadResp()
</code></pre>
<h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><p>router中的dnsmasq 配置</p>
<blockquote>
<p>/usr/sbin/dnsmasq –except-interface=lo -r /tmp/resolv.conf -u root -P 4096 –lan-interface=br0 -x /var/run/dnsmasq.pid –log-facility /tmp/dnsmasq.log –log-queries</p>
</blockquote>
<blockquote>
<p>nameserver 112.65.184.255<br>nameserver 210.22.84.3<br>nameserver 2408:8888:0000:8888:0000:0000:0000:0008 # IPV6 wwan0<br>nameserver 2408:8899:0000:8899:0000:0000:0000:0008 # IPV6 wwan0</p>
</blockquote>
<ul>
<li><p>访问<a target="_blank" rel="noopener" href="http://www.qq.com/">www.qq.com</a> 的DNS过程</p>
</li>
<li><p>LAN</p>
<ul>
<li><p>question</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_question" alt="image-20210830150147489"></p>
</li>
<li><p>response</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_response" alt="image-20210830150342225"></p>
</li>
</ul>
</li>
<li><p>WAN</p>
<ul>
<li><p>question1 for first DNS</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_wan_question" alt="image-20210830151310242"></p>
</li>
<li><p>question2 for second DNS server</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_wan_question2" alt="image-20210830151520688"></p>
</li>
<li><p>response1 for first DNS server</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_wan_response1" alt="image-20210830151953797"></p>
</li>
<li><p>response2 for second DNS server</p>
<p><img src="/2021/09/25/rt-dev/qq_dns_wan_response2" alt="image-20210830153753073"></p>
</li>
</ul>
</li>
</ul>
<p>一般是从本地缓存中查找，如果没有查找在通过本地主机去访问上层的DNS SERVER（router），如果上层DNS SERVER不知道就通过WAN口去访问ISP DNS severs。另外，如果有多个DNS SERVER, DNS系统会同时向这几个DNS server查询。</p>
<h1 id="NTP"><a href="#NTP" class="headerlink" title="NTP"></a>NTP</h1><p>NTP(Network Time Protocol）网络时间协议基于UDP，用于网络时间同步的协议，使网络中的计算机时钟同步到UTC，再配合各个时区的偏移调整就能实现精准同步对时功能。提供NTP对时的服务器有很多，比如微软的NTP对时服务器，利用NTP服务器提供的对时功能，可以使我们的设备时钟系统能够正确运行。</p>
<p>NTP报文格式</p>
<p><img src="https://img-blog.csdn.net/20180811164243878?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Rvc3RoaW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>NTP报文格式如上图所示，它的字段含义参考如下：</p>
<p>LI 闰秒标识器，占用2个bit<br>VN 版本号，占用3个bits，表示NTP的版本号，现在为3<br>Mode 模式，占用3个bits，表示模式<br>stratum（层），占用8个bits<br>Poll 测试间隔，占用8个bits，表示连续信息之间的最大间隔<br>Precision 精度，占用8个bits，，表示本地时钟精度<br>Root Delay根时延，占用8个bits，表示在主参考源之间往返的总共时延<br>Root Dispersion根离散，占用8个bits，表示在主参考源有关的名义错误<br>Reference Identifier参考时钟标识符，占用8个bits，用来标识特殊的参考源<br>参考时间戳，64bits时间戳，本地时钟被修改的最新时间。<br>原始时间戳，客户端发送的时间，64bits。<br>接受时间戳，服务端接受到的时间，64bits。<br>传送时间戳，服务端送出应答的时间，64bits。<br>认证符（可选项）</p>
<p><img src="https://img-blog.csdn.net/20180811164448323?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Rvc3RoaW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>抛开复杂的协议报文，我们来理解一下NTP客户端与服务器的交互过程，进而理解参考时间戳、原始时间戳、接受时间戳、传送时间戳的关系。如图，客户端和服务端都有一个时间轴，分别代表着各自系统的时间，当客户端想要同步服务端的时间时，客户端会构造一个NTP协议包发送到NTP服务端，客户端会记下此时发送的时间t0，经过一段网络延时传输后，服务器在t1时刻收到数据包，经过一段时间处理后在t2时刻向客户端返回数据包，再经过一段网络延时传输后客户端在t3时刻收到NTP服务器数据包。特别声明，t0和t3是客户端时间系统的时间、t1和t2是NTP服务端时间系统的时间，它们是有区别的。对于时间要求不那么精准设备，直接使用NTP服务器返回t2时间也没有太大影响。但是作为一个标准的通信协议，它是精益求精且容不得过多误差的，于是必须计算上网络的传输延时。客户端与服务端的时间系统的偏移定义为θ、网络的往返延迟定义为δ，基于此，可以对t2进行精确的修正，已达到相关精度要求，它们的计算公式如下：</p>
<p><img src="https://img-blog.csdn.net/20180811164701121?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Rvc3RoaW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>式中：</p>
<p>t0是请求数据包传输的客户端时间戳</p>
<p>t1是请求数据包回复的服务器时间戳</p>
<p>t2是响应数据包传输的服务器时间戳</p>
<p>t3是响应数据包回复的客户端时间戳</p>
<p>对此，我们只需将NTP服务端返回的时间t2加上网络延时δ的一半就可以了（t2+δ/2）。<br>————————————————<br>版权声明：本文为CSDN博主「dosthing」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/dosthing/article/details/81588219">https://blog.csdn.net/dosthing/article/details/81588219</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">config_get time_zone</span><br><span class="line"></span><br><span class="line">select_ntp_servers</span><br><span class="line"></span><br><span class="line">​	根据不同的时区选择NTP server</span><br><span class="line"></span><br><span class="line">usd=socket((AF_INET, SOCK_DGRAM, IPPROTO_UDP))</span><br><span class="line"></span><br><span class="line">setup_receive</span><br><span class="line"></span><br><span class="line">​	sockaddr_in sa_rcvr;</span><br><span class="line"></span><br><span class="line">​	sa_rcvr.sin_family=AF_INET;</span><br><span class="line"></span><br><span class="line">​	sa_rcvr.sin_addr.s_addr=htonl(interface)</span><br><span class="line"></span><br><span class="line">​	sa_rcvr.sin_port=htons(port);</span><br><span class="line"></span><br><span class="line">​	bind(usd, (struct sockaddr *)&amp;sa_rcvr, <span class="keyword">sizeof</span> sa_rcvr);</span><br><span class="line"></span><br><span class="line">​	fcntl(usd, F_SETFD, FD_CLOEXEC);</span><br><span class="line">setup_transmit</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa_dest</span>;</span></span><br><span class="line">	sa_dest.sin_family=AF_INET;</span><br><span class="line">	sa_dest.sin_addr.s_addr=inet_addr(host);</span><br><span class="line">	sa_dest.sin_port=htons(port);</span><br><span class="line">    connect(usd, (struct sockaddr *)&amp;sa_dest, <span class="keyword">sizeof</span>(sa_dest)) ;</span><br><span class="line">send_packet</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> data[<span class="number">12</span>];</span><br><span class="line">	data[<span class="number">0</span>]= htonl((LI&lt;&lt;<span class="number">30</span>)|(VN&lt;&lt;<span class="number">27</span>)|(MODE&lt;&lt;<span class="number">24</span>)|(STRATUM&lt;&lt;<span class="number">16</span>)|(POLL&lt;&lt;<span class="number">8</span>)|(PREC &amp; <span class="number">0xff</span>));<span class="comment">//0 3 3 0 4 -6</span></span><br><span class="line">	data[<span class="number">1</span>]=htonl(<span class="number">1</span>&lt;&lt;<span class="number">16</span>); <span class="comment">/* Root Delay seconds */</span></span><br><span class="line">	data[<span class="number">2</span>]=htonl(<span class="number">1</span>&lt;&lt;<span class="number">16</span>); <span class="comment">/* Root Dispersion (seconds) */</span></span><br><span class="line">	get_time_now</span><br><span class="line">        truct timeval now;</span><br><span class="line">		gettimeofday(&amp;now, <span class="literal">NULL</span>);</span><br><span class="line">		*time_coarse = now.tv_sec + JAN_1970; <span class="comment">/* 1970 - 1900 in seconds */</span></span><br><span class="line">		*time_fine = NTPFRAC(now.tv_usec); <span class="comment">/* (4294*(x) + ((1981*(x))&gt;&gt;11)) */</span></span><br><span class="line">	data[<span class="number">10</span>]=htonl(time_coarse);</span><br><span class="line">	data[<span class="number">11</span>]=htonl(time_fine);</span><br><span class="line">	send(usd, data, <span class="number">48</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">static</span> u32 incoming_word[<span class="number">325</span>];</span><br><span class="line">	recvfrom(usd, incoming, sizeof_incoming, <span class="number">0</span>, (struct sockaddr *)&amp;sa_xmit_in, &amp;sa_xmit_len);</span><br><span class="line">	get_packet_timestamp(usd, &amp;udp_arrival_ntp); <span class="comment">/* 获取到达的时间 */</span></span><br><span class="line">	rfc1305print(incoming_word, &amp;udp_arrival_ntp, ntpc, &amp;error);</span><br><span class="line">		el_time = orgtime - arrival;</span><br><span class="line">		st_time = xmttime - rectime;</span><br><span class="line">		skew1 = rectime - orgtime;</span><br><span class="line">		skew2 = arrival - xmttime;</span><br><span class="line"></span><br><span class="line">	t0:原始时间</span><br><span class="line">    t1:接收时间</span><br><span class="line">    t2:传送时间</span><br><span class="line">    t3：到达时间</span><br><span class="line">    t2+ ((t3-t0) - (t2 -t1))/<span class="number">2</span>;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>





<h1 id="FIREWALL"><a href="#FIREWALL" class="headerlink" title="FIREWALL"></a>FIREWALL</h1><h2 id="1-0-net-wall与netfilter整个通信过程"><a href="#1-0-net-wall与netfilter整个通信过程" class="headerlink" title="1.0 net-wall与netfilter整个通信过程"></a>1.0 net-wall与netfilter整个通信过程</h2><h3 id="1-0-1-register-table-register-match-and-register-target"><a href="#1-0-1-register-table-register-match-and-register-target" class="headerlink" title="1.0.1 register table , register match and register target"></a>1.0.1 register table , register match and register target</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_match</span> <span class="title">xxx_match</span> =</span> &#123;</span><br><span class="line">    .name = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    .match = match_handle_function,</span><br><span class="line">    .family = NFPROTO_IPV4,</span><br><span class="line">    .proto = IPPROTO_TCP,</span><br><span class="line">    matchsize = <span class="number">-1</span>,</span><br><span class="line">    .me = THIS_MODULE</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xt_register_matches(struct xt_match *match, <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span><br><span class="line">	 xt_register_match(&amp;match[i]);</span><br><span class="line">	 	list_add(&amp;match-&gt;<span class="built_in">list</span>, &amp;xt[af].match);</span><br><span class="line">	注册一个ipt_match最终会添加到xt[]结构体数组中 	</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_af</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">match</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">target</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">compat_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">compat_delta</span> *<span class="title">compat_tab</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> number; <span class="comment">/* number of slots in compat_tab[] */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cur; <span class="comment">/* number of used slots in compat_tab[] */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xt_register_target(&amp;xxx_tg_reg);</span><br><span class="line">	list_add(&amp;target-&gt;<span class="built_in">list</span>, &amp;xt[af].target)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> <span class="title">xxx_tg_reg</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">    .name <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    .family = NFPROTO_IPV4,</span><br><span class="line">    .target = target_handle_function,</span><br><span class="line">    .table = <span class="string">&quot;filter&quot;</span> <span class="keyword">or</span> <span class="string">&quot;nat&quot;</span> ...,</span><br><span class="line">    .hooks = (<span class="number">1</span>&lt;&lt;NF_INET_LOCAL_IN)|(<span class="number">1</span>&lt;&lt;NF_INET_FORWARD)|...,</span><br><span class="line">    .checkentry = check_function,</span><br><span class="line">    .me = THIS_MODULE</span><br><span class="line">    </span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不管是match还是target，都有一个结构体这个结构体中包含各自的处理函数，而这个结构体最终会被注册到xt[af]这个全局数组的链表中。</p>
<h3 id="1-0-2-register-hook-ops"><a href="#1-0-2-register-hook-ops" class="headerlink" title="1.0.2 register hook_ops"></a>1.0.2 register hook_ops</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*nf_nat_standalone.c*/</span></span><br><span class="line"><span class="function">nf_nat_standalone_init</span></span><br><span class="line"><span class="function">	<span class="title">nf_nat_rule_init</span><span class="params">()</span></span>; <span class="comment">//nf_nat_rule.c</span></span><br><span class="line">		register_pernet_subsys(&amp;nf_nat_rule_net_ops)</span><br><span class="line">			nf_nat_rule_net_ops=&#123;</span><br><span class="line">				.init = nf_nat_rule_net_init,</span><br><span class="line">				.<span class="built_in">exit</span> = nf_nat_rule_net_ext,</span><br><span class="line">			&#125;</span><br><span class="line">			nf_nat_rule_net_init</span><br><span class="line">				net-&gt;ipv4.nat_table = ipt_register_table(net, &amp;nat_table, repl);</span><br><span class="line">					<span class="function">xt_register_table</span></span><br><span class="line"><span class="function">						<span class="title">list_for_each_entry</span><span class="params">(t, &amp;net-&gt;xt.tables[table-&gt;af], <span class="built_in">list</span>)</span> </span>&#123;</span><br><span class="line">							<span class="keyword">if</span> (<span class="built_in">strcmp</span>(t-&gt;name, table-&gt;name) == <span class="number">0</span>) &#123;</span><br><span class="line">								ret = -EEXIST;</span><br><span class="line">								<span class="keyword">goto</span> unlock;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						list_add(&amp;table-&gt;<span class="built_in">list</span>, &amp;net-&gt;xt.tables[table-&gt;af]); <span class="comment">//table is finally added to net-&gt;xt.tables[NFPROTO_IPV4]</span></span><br><span class="line">		xt_register_target(&amp;ipt_snat_reg);<span class="comment">//register snat target</span></span><br><span class="line">		xt_register_target(&amp;ipt_dnat_reg); <span class="comment">//register dnat target</span></span><br><span class="line">	nf_register_hooks(nf_nat_ops, ARRAY_SIZE(nf_nat_ops))</span><br><span class="line">		nf_register_hook(nf_nat_ops[i])</span><br><span class="line">			list_for_each_entry(elem, &amp;nf_hooks[reg-&gt;pf][reg-&gt;hooknum], <span class="built_in">list</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (reg-&gt;priority &lt; elem-&gt;priority)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		list_add_rcu(&amp;reg-&gt;<span class="built_in">list</span>, elem-&gt;<span class="built_in">list</span>.prev);</span><br><span class="line">	<span class="comment">/*for ipv4 these hooks_ops will be added to nf_hooks[NFPROTO_IPV4][...]*/</span></span><br><span class="line">		</span><br></pre></td></tr></table></figure>



<h3 id="1-0-3-应用层中的数据添加到内核的table中"><a href="#1-0-3-应用层中的数据添加到内核的table中" class="headerlink" title="1.0.3 应用层中的数据添加到内核的table中"></a>1.0.3 应用层中的数据添加到内核的table中</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">iptc_init()</span><br><span class="line">	ipt_getinfo.name = <span class="string">&quot;nat&quot;</span></span><br><span class="line">	getsockopt(sockfd, IPPROTO_IP, IPT_SO_GET_INFO, &amp;info, &amp;s)</span><br><span class="line">		<span class="comment">/*ip_tables.c*/</span></span><br><span class="line">		do_ipt_get_ctl </span><br><span class="line">			get_info(sock_net(sockfd), info, s, <span class="number">0</span>)</span><br><span class="line">				t=try_then_request_module(xt_find_table_lock(net, AF_INET, name), <span class="string">&quot;iptable_%s&quot;</span>, name) </span><br><span class="line">					xt_find_table_lock</span><br><span class="line">						list_for_each_entry(t, &amp;net-&gt;xt.tables[af], <span class="built_in">list</span>)</span><br><span class="line">							<span class="keyword">if</span>(<span class="built_in">strcmp</span>(t-&gt;name, name)==<span class="number">0</span> &amp;&amp; try_module_get(t-&gt;me))</span><br><span class="line">								<span class="keyword">return</span> t</span><br><span class="line">				*<span class="keyword">private</span> = t-&gt;<span class="keyword">private</span></span><br><span class="line">				info.valid_hooks = t-&gt;valid_hooks</span><br><span class="line">				<span class="built_in">memcpy</span>(info.hook_entry, <span class="keyword">private</span>-&gt;hook_entry, <span class="keyword">sizeof</span>(info.hook_entry))</span><br><span class="line">				<span class="built_in">memcpy</span>(info.underflow, <span class="keyword">private</span>-&gt;underflow)</span><br><span class="line">				info.num_entries = <span class="keyword">private</span>-&gt;number;</span><br><span class="line">				info.size = <span class="keyword">private</span>-&gt;size;</span><br><span class="line">				<span class="built_in">strcpy</span>(info.name, name);</span><br><span class="line">				copy_to_user(usr, &amp;info, *len)</span><br><span class="line">	h=alloc_handle(info.name, info.size, info.num_entries)</span><br><span class="line">				<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct iptc_handle));</span><br><span class="line">				h-&gt;entries = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct ipt_get_entries) + size);</span><br><span class="line">				<span class="built_in">strcpy</span>(h-&gt;entries-&gt;name, <span class="string">&quot;nat&quot;</span>)</span><br><span class="line">				h-&gt;entries-&gt;size = size</span><br><span class="line">	h-&gt;info = info;</span><br><span class="line">	h-&gt;entries-&gt;size = h-&gt;info.size</span><br><span class="line">	getsockopt(sockfd, IPPROTO_IP, IPT_SO_GET_ENTRIES, h-&gt;entries, &amp;tmp)</span><br><span class="line">		<span class="comment">/*ip_tables.c*/</span></span><br><span class="line">		do_ipt_get_ctl</span><br><span class="line">			get_entries(sock_net(sockfd), h-&gt;entries, tmp)</span><br><span class="line">				copy_from_user(&amp;get, h-&gt;entries, <span class="keyword">sizeof</span>(get))</span><br><span class="line">				t = xt_find_tabe_lock(net, AF_INET, get.name)<span class="comment">//this function has been parsed</span></span><br><span class="line">				struct xt_table_info *<span class="keyword">private</span> = t-&gt;<span class="keyword">private</span>;</span><br><span class="line">				copy_entries_to_user(<span class="keyword">private</span>-&gt;size, t, h-&gt;entries-&gt;entrytable)</span><br><span class="line">	parse_table(h)</span><br><span class="line">	<span class="keyword">return</span> h;</span><br><span class="line">	</span><br><span class="line">ipt_append_entry(<span class="string">&quot;PREROUTING&quot;</span>, e, handle)</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chain_head</span> *<span class="title">c</span>=</span>iptcc_find_label(chain, *handle) <span class="comment">//iptcc_find_label(&quot;PREROUTING&quot;, *handle)</span></span><br><span class="line">		list_for_each(pos, &amp;handle-&gt;chains)&#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">chain_head</span> *<span class="title">c</span> =</span> list_entry(pos, struct chain_head, <span class="built_in">list</span>);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(c-&gt;name, name))</span><br><span class="line">				<span class="keyword">return</span> c;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rule_head</span> *<span class="title">r</span>=</span> iptcc_alloc_rule(c, e-&gt;next_offset)</span><br><span class="line">		r=<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*r)+e-&gt;next_offset)</span><br><span class="line">		r-&gt;chain = c</span><br><span class="line">		r-&gt;size = size</span><br><span class="line">	<span class="built_in">memcpy</span>(r-&gt;entry, e, e-&gt;next_offset)</span><br><span class="line">	iptcc_map_target(*handle, r)</span><br><span class="line">	list_add_tail(&amp;r-&gt;<span class="built_in">list</span>, &amp;c-&gt;rules) <span class="comment">//add r-&gt;list to c-&gt;rules</span></span><br><span class="line">	set_changed(*handle)	</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>iptc_commit的过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">iptc_commit</span></span><br><span class="line"><span class="function">	<span class="title">iptcc_compile_table</span><span class="params">(*handle, repl)</span></span></span><br><span class="line"><span class="function">		<span class="title">iptcc_compile_chain</span><span class="params">(h, repl, c)</span></span></span><br><span class="line"><span class="function">		<span class="comment">/*rules finally are added to repl-&gt;entries*/</span></span></span><br><span class="line"><span class="function">			<span class="title">list_for_each_entry</span><span class="params">(r, &amp;c-&gt;rules, <span class="built_in">list</span>)</span> </span>&#123;</span><br><span class="line">				<span class="function">iptcc_compile_rule</span></span><br><span class="line"><span class="function">					<span class="title">memcpy</span><span class="params">((<span class="keyword">char</span> *)repl-&gt;entries+r-&gt;offset, r-&gt;entry, r-&gt;size)</span>)</span></span><br><span class="line"><span class="function">					&#125;</span></span><br><span class="line"><span class="function">				<span class="title">setsockopt</span><span class="params">(sockfd, IPPROTO_IP, IPT_SO_SET_REPLACE, repl, <span class="keyword">sizeof</span>(*repl)+repl-&gt;size)</span></span></span><br><span class="line"><span class="function">					do_ipt_set_ctl <span class="comment">//use this function to replace setsockopt ip_tables.c</span></span></span><br><span class="line"><span class="function">						<span class="title">do_replace</span><span class="params">(sock_net(sk), repl, len)</span></span>;</span><br><span class="line">							copy_from_user(&amp;tmp, user, <span class="keyword">sizeof</span>(tmp))</span><br><span class="line">							newinfo = xt_alloc_talbe_info(tmp.size)</span><br><span class="line">							loc_cpu_entry=newinfo-&gt;entries[raw_smp_processor_id()]</span><br><span class="line">							copy_from_user(loc_cpu_entry, user+<span class="keyword">sizeof</span>(tmp), tmp.size) <span class="comment">//copy repl-&gt;entries to loc_cpu_entry	</span></span><br><span class="line">							translate_table(net, newinfo, loc_cpu_entry, &amp;tmp);</span><br><span class="line">								xt_entry_foreach(iter, loc_cpu_entry, newinfo-&gt;size ) <span class="comment">//get ipt_entry which is copied from repl-&gt;entries</span></span><br><span class="line">									find_check_entry(iter, net, repl-&gt;name, repl-&gt;size);</span><br><span class="line">										find_check_match(ematch, &amp;mtpar);</span><br><span class="line">										 xt_request_find_match(NFPROTO_IPV4, m-&gt;u.user.name, m-&gt;u.user.revision);</span><br><span class="line">										 	xt_find_match(nfproto, name, revision);</span><br><span class="line">										 		list_for_each_entry(m, &amp;xt[af].match, <span class="built_in">list</span>) &#123;</span><br><span class="line">													<span class="keyword">if</span> (<span class="built_in">strcmp</span>(m-&gt;name, name) == <span class="number">0</span>) &#123;</span><br><span class="line">														<span class="keyword">if</span> (m-&gt;revision == revision) &#123;</span><br><span class="line">															<span class="keyword">if</span> (try_module_get(m-&gt;me)) &#123;</span><br><span class="line">																mutex_unlock(&amp;xt[af].mutex);</span><br><span class="line">																<span class="keyword">return</span> m;</span><br><span class="line">										m-&gt;u.kernel.match = match; <span class="comment">//match the &quot;match&quot; which registered to xt[af].match</span></span><br><span class="line">										xt_request_find_target(NFPROTO_IPV4, t-&gt;u.user.name,t-&gt;u.user.revision);</span><br><span class="line">											 xt_find_target(af, name, revision);</span><br><span class="line">											 	list_for_each_entry(t, &amp;xt[af].target, <span class="built_in">list</span>) &#123;</span><br><span class="line">													<span class="keyword">if</span> (<span class="built_in">strcmp</span>(t-&gt;name, name) == <span class="number">0</span>) &#123;</span><br><span class="line">														<span class="keyword">if</span> (t-&gt;revision == revision) &#123;</span><br><span class="line">															<span class="keyword">if</span> (try_module_get(t-&gt;me)) &#123;</span><br><span class="line">																mutex_unlock(&amp;xt[af].mutex);</span><br><span class="line">																<span class="keyword">return</span> t;</span><br><span class="line">											t-&gt;u.kernel.target = target; <span class="comment">//match the &quot;target&quot; which registered to xt[af].target</span></span><br><span class="line">							__do_replace(net, tmp.name, tmp.valid_hooks, newinfo,tmp.num_counters, tmp.counters); <span class="comment">//update xt_talbe_info</span></span><br><span class="line">									t = try_then_request_module(xt_find_table_lock(net, AF_INET, name), <span class="string">&quot;iptables_%s&quot;</span>, name) <span class="comment">//get table 	from net-&gt;xt.tables[af]	</span></span><br><span class="line">										xt_replace_table(t, num_counters, newinfo, &amp;ret)</span><br><span class="line">											table-&gt;<span class="keyword">private</span> = newinfo</span><br></pre></td></tr></table></figure>



<h3 id="1-0-4-内核中match和target的调用"><a href="#1-0-4-内核中match和target的调用" class="headerlink" title="1.0.4 内核中match和target的调用"></a>1.0.4 内核中match和target的调用</h3><p>以NAT表为例，在net-wall中NAT分为：</p>
<p>POSTROUTING:    ppp0_masq brwan_masq br0_masq</p>
<p>PREROUTING: net_dnat lan_dnat upnp_rule iqmp_chain ACCEPT wanlan_config_rule ftp_rule dns_hijack_rule</p>
<p>首先每个table,不管是标准的还是扩展的table在内核中对应的match和target。也就是说在用户层中net-wall或者iptables中的table都会有在内核中的注册的match和target与之对应。对于NAT table会注册一个dnat的target.同样如果match的是tcp, 那么也是要注册一个tcp的target。这些match和target最终都会注册到xt[af]链表中。</p>
<p>NAT这个table会在ipt_commit后通过setoptsock与内核通信，首先用在translate_table中将应用层规则匹配到之前在内核中注册的match和target，然后替代内核中旧的规则。</p>
<img src="/2021/09/25/rt-dev/net-wall2netfilter.jpg" style="zoom: 150%;">

<ul>
<li>当网络包在内核传输调用firewall的过程</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">for</span> each prerouting input forward output postrouting call </span></span><br><span class="line"><span class="function"><span class="title">ip_forward</span><span class="params">(skb)</span>|<span class="title">ip_local_deliver</span><span class="params">(skb)</span>|<span class="title">ip_rcv</span><span class="params">(skb)</span>|<span class="title">ip_mc_output</span><span class="params">(skb)</span>|ip_vs_nat_send_or_cont</span></span><br><span class="line"><span class="function">	<span class="title">NF_HOOK</span><span class="params">(NFPROTO_IPV4, NF_INET_FORWARD|NF_INET_LOCAL_IN|NF_INET_PRE_ROUTING|NF_INET_POST_ROUTING|NF_INET_LOCAL_OUT, skb, skb-&gt;dev,rt-&gt;dst.dev, ip_forward_finish)</span></span>;</span><br><span class="line">		NF_HOOK_THRESH(pf, hook, skb, in, out, okfn, INT_MIN);</span><br><span class="line">			ret = nf_hook_thresh(pf, hook, skb, in, out, okfn, thresh);</span><br><span class="line">				 nf_hook_slow(pf, hook, skb, indev, outdev, okfn, thresh);</span><br><span class="line">				 	nf_iterate(&amp;nf_hooks[pf][hook], skb, hook, indev, outdev, &amp;elem, okfn, hook_thresh);</span><br><span class="line">				 		verdict = (*elemp)-&gt;hook(*elemp, skb, indev, outdev, okfn);</span><br><span class="line">				 		<span class="comment">/*filter&#x27;s hook function is defined in iptables_filter.c and it&#x27;s iptable_filter_hook, mangle&#x27;shook is so, iptable_mangle.c*/</span></span><br><span class="line">				 		<span class="comment">/* nf_nat_standalone.c according to hooknum, there are different hook in nf_nat_ops[] */</span></span><br><span class="line">				 		<span class="function">nf_nat_ipv4_in</span></span><br><span class="line"><span class="function">				 			<span class="title">nf_nat_ipv4_fn</span><span class="params">(ops, skb, in, out, okfn)</span></span>;</span><br><span class="line">				 				ret = nf_nat_rule_find(skb, ops-&gt;hooknum, in, out, ct);</span><br><span class="line">				 					ipt_do_table(skb, hooknum, in, out, net-&gt;ipv4.nat_table); <span class="comment">/*match function and target function*/</span></span><br><span class="line">				 						<span class="keyword">private</span> = table-&gt;<span class="keyword">private</span>;</span><br><span class="line">				 						table_base = <span class="keyword">private</span>-&gt;entries[cpu];</span><br><span class="line">				 						e = get_entry(table_base, <span class="keyword">private</span>-&gt;hook_entry[hook]);<span class="comment">/*this is got from ipv4.nat_table*/</span></span><br><span class="line">				 						<span class="comment">/*search match and target*/</span></span><br><span class="line">										<span class="keyword">do</span> &#123;</span><br><span class="line">											<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> *<span class="title">t</span>;</span></span><br><span class="line">											<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> *<span class="title">ematch</span>;</span></span><br><span class="line">									</span><br><span class="line">											IP_NF_ASSERT(e);</span><br><span class="line">											<span class="keyword">if</span> (!ip_packet_match(ip, indev, outdev,</span><br><span class="line">											    &amp;e-&gt;ip, acpar.fragoff)) &#123;</span><br><span class="line">									 no_match:</span><br><span class="line">												e = ipt_next_entry(e);</span><br><span class="line">												<span class="keyword">continue</span>;</span><br><span class="line">											&#125;</span><br><span class="line">											<span class="comment">/*get match*/</span></span><br><span class="line">											xt_ematch_foreach(ematch, e) &#123;</span><br><span class="line">												acpar.match     = ematch-&gt;u.kernel.match;</span><br><span class="line">												acpar.matchinfo = ematch-&gt;data;</span><br><span class="line">												<span class="keyword">if</span> (!acpar.match-&gt;match(skb, &amp;acpar)) <span class="comment">/*run the match register by ipt_match_register*/</span></span><br><span class="line">													<span class="keyword">goto</span> no_match;</span><br><span class="line">											&#125;</span><br><span class="line">									</span><br><span class="line">											ADD_COUNTER(e-&gt;counters, skb-&gt;len, <span class="number">1</span>);</span><br><span class="line">									</span><br><span class="line">											t = ipt_get_target(e);</span><br><span class="line">											IP_NF_ASSERT(t-&gt;u.kernel.target);</span><br><span class="line">									</span><br><span class="line">									<span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_NETFILTER_XT_TARGET_TRACE)</span></span><br><span class="line">											<span class="comment">/* The packet is traced: log it */</span></span><br><span class="line">											<span class="keyword">if</span> (unlikely(skb-&gt;nf_trace))</span><br><span class="line">												trace_packet(skb, hook, in, out,</span><br><span class="line">													     table-&gt;name, <span class="keyword">private</span>, e);</span><br><span class="line">									<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">											<span class="comment">/* Standard target? */</span></span><br><span class="line">											<span class="keyword">if</span> (!t-&gt;u.kernel.target-&gt;target) &#123;</span><br><span class="line">												<span class="keyword">int</span> v;</span><br><span class="line">									</span><br><span class="line">												v = ((struct xt_standard_target *)t)-&gt;verdict;</span><br><span class="line">												<span class="keyword">if</span> (v &lt; <span class="number">0</span>) &#123;</span><br><span class="line">													<span class="comment">/* Pop from stack? */</span></span><br><span class="line">													<span class="keyword">if</span> (v != XT_RETURN) &#123;</span><br><span class="line">														verdict = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(-v) - <span class="number">1</span>;</span><br><span class="line">														<span class="keyword">break</span>;</span><br><span class="line">													&#125;</span><br><span class="line">													<span class="keyword">if</span> (*stackptr &lt;= origptr) &#123;</span><br><span class="line">														e = get_entry(table_base,</span><br><span class="line">														    <span class="keyword">private</span>-&gt;underflow[hook]);</span><br><span class="line">														pr_debug(<span class="string">&quot;Underflow (this is normal) &quot;</span></span><br><span class="line">															 <span class="string">&quot;to %p\n&quot;</span>, e);</span><br><span class="line">													&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">														e = jumpstack[--*stackptr];</span><br><span class="line">														pr_debug(<span class="string">&quot;Pulled %p out from pos %u\n&quot;</span>,</span><br><span class="line">															 e, *stackptr);</span><br><span class="line">														e = ipt_next_entry(e);</span><br><span class="line">													&#125;</span><br><span class="line">													<span class="keyword">continue</span>;</span><br><span class="line">												&#125;</span><br><span class="line">												<span class="keyword">if</span> (table_base + v != ipt_next_entry(e) &amp;&amp;</span><br><span class="line">												    !(e-&gt;ip.flags &amp; IPT_F_GOTO)) &#123;</span><br><span class="line">													<span class="keyword">if</span> (*stackptr &gt;= <span class="keyword">private</span>-&gt;stacksize) &#123;</span><br><span class="line">														verdict = NF_DROP;</span><br><span class="line">														<span class="keyword">break</span>;</span><br><span class="line">													&#125;</span><br><span class="line">													jumpstack[(*stackptr)++] = e;</span><br><span class="line">													pr_debug(<span class="string">&quot;Pushed %p into pos %u\n&quot;</span>,</span><br><span class="line">														 e, *stackptr - <span class="number">1</span>);</span><br><span class="line">												&#125;</span><br><span class="line">									</span><br><span class="line">												e = get_entry(table_base, v);</span><br><span class="line">												<span class="keyword">continue</span>;</span><br><span class="line">											&#125;</span><br><span class="line">									</span><br><span class="line">											acpar.target   = t-&gt;u.kernel.target;</span><br><span class="line">											acpar.targinfo = t-&gt;data;</span><br><span class="line">									</span><br><span class="line">											verdict = t-&gt;u.kernel.target-&gt;target(skb, &amp;acpar);</span><br><span class="line">											<span class="comment">/* Target might have changed stuff. */</span></span><br><span class="line">											ip = ip_hdr(skb);</span><br><span class="line">											<span class="keyword">if</span> (verdict == XT_CONTINUE)</span><br><span class="line">												e = ipt_next_entry(e);</span><br><span class="line">											<span class="keyword">else</span></span><br><span class="line">												<span class="comment">/* Verdict */</span></span><br><span class="line">												<span class="keyword">break</span>;</span><br><span class="line">										&#125; <span class="keyword">while</span> (!acpar.hotdrop);</span><br><span class="line">								ret=	ipt_do_table will <span class="keyword">return</span> NF_DROP|NF_ACCEPT|NF_STOLEN|NF_QUEUE|NF_REPEAT|NF_STOP	</span><br><span class="line">								<span class="keyword">if</span>(ret = NF_ACCEPT)</span><br><span class="line">								&#123;&#125;</span><br><span class="line">								<span class="keyword">return</span> ret</span><br><span class="line">							<span class="keyword">if</span>(ret != NF_ACCEPT)</span><br><span class="line">							<span class="keyword">return</span> ret	</span><br><span class="line">				<span class="comment">/* Do packet manipulations according to nf_nat_setup_info.  */</span></span><br><span class="line">				<span class="keyword">return</span> nf_nat_packet(ct, ctinfo, ops-&gt;hooknum, skb);	 		</span><br><span class="line">										<span class="comment">/* Non-atomic: these bits don&#x27;t change. */</span></span><br><span class="line">					<span class="keyword">if</span> (ct-&gt;status &amp; statusbit) &#123;</span><br><span class="line">						<span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_tuple</span> <span class="title">target</span>;</span></span><br><span class="line">				</span><br><span class="line">						<span class="comment">/* We are aiming to look like inverse of other direction. */</span></span><br><span class="line">						nf_ct_invert_tuplepr(&amp;target, &amp;ct-&gt;tuplehash[!dir].tuple);</span><br><span class="line">								ret = nf_ct_invert_tuple(inverse, orig, __nf_ct_l3proto_find(orig-&gt;src.l3num), __nf_ct_l4proto_find(orig-&gt;src.l3num, orig-&gt;dst.protonum));</span><br><span class="line">									inverse-&gt;src.l3num = orig-&gt;src.l3num;</span><br><span class="line">									<span class="keyword">if</span> (l3proto-&gt;invert_tuple(inverse, orig) == <span class="number">0</span>)</span><br><span class="line">										<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">								</span><br><span class="line">									inverse-&gt;dst.dir = !orig-&gt;dst.dir;</span><br><span class="line">								</span><br><span class="line">									inverse-&gt;dst.protonum = orig-&gt;dst.protonum;</span><br><span class="line">									<span class="keyword">return</span> l4proto-&gt;invert_tuple(inverse, orig);</span><br><span class="line">						l3proto = __nf_nat_l3proto_find(target.src.l3num);</span><br><span class="line">						l4proto = __nf_nat_l4proto_find(target.src.l3num,</span><br><span class="line">										target.dst.protonum);</span><br><span class="line">						<span class="keyword">if</span> (!l3proto-&gt;manip_pkt(skb, <span class="number">0</span>, l4proto, &amp;target, mtype))</span><br><span class="line">			nf_nat_ipv4_manip_pkt(struct sk_buff *skb, <span class="keyword">unsigned</span> <span class="keyword">int</span> iphdroff, <span class="keyword">const</span> struct nf_nat_l4proto *l4proto, <span class="keyword">const</span> struct nf_conntrack_tuple *target, <span class="keyword">enum</span> nf_nat_manip_type maniptype)</span><br><span class="line"></span><br><span class="line">										|&#123;</span><br><span class="line">																					</span><br><span class="line">										|&#125;</span><br><span class="line">							<span class="keyword">return</span> NF_DROP;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">							</span><br></pre></td></tr></table></figure>





<h2 id="1-1-config-ap-mode-rule"><a href="#1-1-config-ap-mode-rule" class="headerlink" title="1.1 config_ap_mode_rule"></a>1.1 config_ap_mode_rule</h2><p>这个函数的功能就是实现：</p>
<pre><code>iptables -t nat -A PREROUTING -i br0 -d ![br0_addr] -p udp --dport 53 -j REDIRECT --to-port 53
</code></pre>
<p>table: nat</p>
<p>match :udp</p>
<p>target : REDIRECT</p>
<p>udp和REDIRECT都是标准的match和target,即内核中已经注册了。</p>
<h3 id="1-1-1-reset-firewall"><a href="#1-1-1-reset-firewall" class="headerlink" title="1.1.1 reset_firewall"></a>1.1.1 reset_firewall</h3><p>在reset Firewalls后通过iptc_init获取到一个nat handler</p>
<p><img src="/2021/09/25/rt-dev/hash_example.png" alt="图1.1.2.1 iptc_handle"></p>
<h3 id="1-1-2-create-the-REDIRECT-rule"><a href="#1-1-2-create-the-REDIRECT-rule" class="headerlink" title="1.1.2 create the REDIRECT rule"></a>1.1.2 create the REDIRECT rule</h3><blockquote>
<p>iptables -t nat -A PREROUTING -i br0 -p tcp –dport $srcPortNumber -j REDIRECT –to-port $dstPortNumber</p>
<p>iptables -t nat -A PREROUTING -i br0 -p udp –dport $srcPortNumber -j REDIRECT –to-port $dstPortNumber</p>
</blockquote>
<ol start="0">
<li><p>首先分配一个ipt_entry的地址空间，将ipt_entry的target_offset和next_offset初始化为这个结构体的末尾。</p>
</li>
<li><p>接着用append_match(e, “udp”, sizeof(ipt_udp)来在之前分配的ipt_entry结构体后再分配一个ipt_match结构体和一个ipt_udp结构体。而ipt_entry的target_offset和next_offset的值指向重现分配的整个结构体末尾。最后再设置udp结构体的值。</p>
</li>
<li><p>用append_target来在ipt_match后附加一个“REDIRECT”的ipt_target和ip_nat_multi_range。</p>
</li>
</ol>
<p>再完成一系列的配置后得到的ipt_entry如下图所示：</p>
<p><img src="/2021/09/25/rt-dev/ap_mode_config.png"></p>
<p>然后调用iptc_append_entry(“PREROUTING”, e, &amp;handle)将上图的ipt_entry结构体附加到nat的“PREROUTING” HOOK节点中中.</p>
<p>接着是build_lan_http_redirect_rule，即远程管理功能将WAN口的端口如8443转发到WAN口的443端口或80端口。</p>
<p>如下图所示</p>
<p><img src="/2021/09/25/rt-dev/create_lan_tcp_redirect_rule.png"></p>
<p>上图中的min_ip=max_ip=net_interfaces[NET_IF].ifa_local.s_addr为WAN IP。</p>
<p>而对于lan ftp redirect rule只是将from和to的端口号换了其它都与上图一样。</p>
<p>net_dnat_rule会添加到dnatp2p_list中，所以遍历这个链表中的rule，将rule-&gt;entry附加到handle上。</p>
<p>最后再iptc_commit(&amp;handle)。</p>
<h3 id="1-1-3-REDIRECT-target-in-kernel"><a href="#1-1-3-REDIRECT-target-in-kernel" class="headerlink" title="1.1.3 REDIRECT target in kernel"></a>1.1.3 REDIRECT target in kernel</h3><p>在net/ipv4/netfilter/ipt_REDIRECT.c中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">xt_target redirect_tg_reg __read_mostly = &#123;</span><br><span class="line">    .name = <span class="string">&quot;REDIRECT&quot;</span>,</span><br><span class="line">    .family = NFPROTO_IPV4,</span><br><span class="line">    .target = redirect_tg,</span><br><span class="line">    .targetsize = <span class="keyword">sizeof</span>(struct nf_nat_ipv4_multi_range_compat),</span><br><span class="line">    .hooks = (<span class="number">1</span>&lt;&lt; NF_INET_PRE_ROUTING)|(<span class="number">1</span>&lt;&lt;NF_INET_LOCAL_OUT),</span><br><span class="line">    .checkentry = redirect_tg_check,</span><br><span class="line">    .me = THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//这个结构体会被注册到xt[af]中</span></span><br><span class="line">xt_register_target(&amp;redirect_tg_reg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*skb为匹配到的网络包，</span></span><br><span class="line"><span class="comment">* par为用户层设置的参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">redirect_tg(struct sk_buff *skb, <span class="keyword">const</span> struct xt_action_param *par)</span><br><span class="line">    <span class="comment">/*只支持PREROUTING和local out的hook*/</span></span><br><span class="line">    NF_CT_ASSET(par-&gt;hooknum == NF_INET_PRE_ROUTING || par-&gt;hooknum ==NF_INET_LOCAL_OUT);</span><br><span class="line"><span class="comment">/*只支持新的连接和类似new的相关存在的连接，像ICMP错误*/</span></span><br><span class="line">NF_CT_ASSERT(ct &amp;&amp; (ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED));</span><br><span class="line"><span class="comment">/*如果是LOCAL_OUT，则会把目的地址改为127.0.0.1,否则为输入网络接口的IP地址*/</span></span><br><span class="line"><span class="keyword">if</span>(par-&gt;hooknum == NF_INET_LOCAL_OUT)</span><br><span class="line">    newdst = htonl(<span class="number">0x7F000001</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    newdst = indev-&gt;ifa_list-&gt;ifa_local; </span><br><span class="line"></span><br><span class="line">newrange= (struct nf_nat_ipv4_range)&#123;</span><br><span class="line">    mr-&gt;range[<span class="number">0</span>].flags | NF_NAT_RANGE_MAP_IPS,</span><br><span class="line">    newdst, newdst,</span><br><span class="line">    mr-&gt;range[<span class="number">0</span>].min, mr-&gt;range[<span class="number">0</span>].max</span><br><span class="line">&#125;;</span><br><span class="line"> <span class="keyword">return</span> nf_nat_setup_info(ct, &amp;newrange, NF_NAT_MANIP_DST);</span><br></pre></td></tr></table></figure>

<p>当网络包被match后，调用“REDIRECT” target，则会调用redirect_tg， DEDIRECT和NAT区别在于REDIRECT只能在本机上进行端口转换，可以看到它的IP地址为127.0.0.1或者输入网络接口的IP地址。不能像NAT一样，进行内部和外部地址间的端口转换。</p>
<h2 id="1-2-init-upnp-rules"><a href="#1-2-init-upnp-rules" class="headerlink" title="1.2 init upnp rules"></a>1.2 init upnp rules</h2><p>首先从/tmp/upnp_pmlist中提取出protocol ,inport ,extport ,dstip, 然后根据提取出来的信息进行规则添加。</p>
<h3 id="1-2-1-generate-dnat-rules"><a href="#1-2-1-generate-dnat-rules" class="headerlink" title="1.2.1 generate dnat rules"></a>1.2.1 generate dnat rules</h3><h4 id="firewall-pass-through"><a href="#firewall-pass-through" class="headerlink" title="firewall pass-through"></a>firewall pass-through</h4><p><img src="/2021/09/25/rt-dev/dnat_firewall_pass_through.png"></p>
<p>这部分只关注目的IP地址，协议和端口然后target为Accept。</p>
<h4 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h4><p><img src="/2021/09/25/rt-dev/create_dnat_rule.png"></p>
<p>这里我关注的部分是端口号和协议，即我们只匹配对应的协议（tcp/udp）的外部端口号，然后将其转发为目的IP的内部端口。</p>
<blockquote>
<p>Chain MINIUPNPD (1 references)<br>pkts bytes target     prot opt in     out     source               destination<br>0     0 DNAT       udp  –  *      *       0.0.0.0/0            0.0.0.0/0            udp dpt:8000 to:192.168.1.10:8000<br>0     0 DNAT       tcp  –  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8000 to:192.168.1.10:8000<br>0     0 DNAT       udp  –  *      *       0.0.0.0/0            0.0.0.0/0            udp dpt:19609 to:192.168.1.2:8000<br>0     0 DNAT       tcp  –  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10775 to:192.168.1.2:8000</p>
</blockquote>
<h3 id="1-2-2-generate-dnat-p2p-rules"><a href="#1-2-2-generate-dnat-p2p-rules" class="headerlink" title="1.2.2 generate dnat p2p rules"></a>1.2.2 generate dnat p2p rules</h3><p><img src="/2021/09/25/rt-dev/create_dnatp2p_rule.png"></p>
<p>对于dnatp2p与dnat基本上是一样的，只是nf_nat_range的flags有点不同。而对于传入的extports[0]和exports[1]不同也会使得匹配的不是某一个端口而是一个范围的端口来进行转发。而对于外部端口和内部端口不同则会使得外部端口转发到指定的内部端口。</p>
<h2 id="1-3-port-forwarding-rules"><a href="#1-3-port-forwarding-rules" class="headerlink" title="1.3 port forwarding rules"></a>1.3 port forwarding rules</h2><p>端口转发使用的函数和upnp的是一样的都是将外部的端口范围转发到内部IP的端口范围。而对于TCP的内外部端口号都为1723时是特定为Cisco的GRE tunnels服务的。</p>
<blockquote>
<p>forwarding1=rmeote TCP/UDP 12345 12345 3389 3389 192.168.1.2 0 0</p>
</blockquote>
<h2 id="1-4-init-firewall"><a href="#1-4-init-firewall" class="headerlink" title="1.4 init firewall"></a>1.4 init firewall</h2><p>首先从datalib中获取wan_proto然后再进行validate ifaces, init default rule, init pmss rule, init notsyn rule, pppoe 和 pptp等初始化。</p>
<h3 id="1-4-1-validate-ifaces"><a href="#1-4-1-validate-ifaces" class="headerlink" title="1.4.1 validate ifaces"></a>1.4.1 validate ifaces</h3><p>获取WAN口和LAN口的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ifconf</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> ifc_len; <span class="comment">/*size of buffer*/</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span> *ifcu_buf;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> *<span class="title">ifcu_req</span>;</span></span><br><span class="line">	&#125;ifc_ifcu;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifc_buf ifc_ifcu.ifcu_buf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifc_req ifc_ifcu.ifcu_req</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> &#123;</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> IFHWADDRLEN 6</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span> ifrn_name[IFNAMSIZ]; <span class="comment">/*if name, e.g. &quot;en0&quot;*/</span></span><br><span class="line">	&#125;ifr_ifrn;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">ifru_addr</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">ifru_dstaddr</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">ifru_broadaddr</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">ifru_netmask</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">ifru_hwaddr</span>;</span></span><br><span class="line">		<span class="keyword">short</span> ifru_flags;</span><br><span class="line">		<span class="keyword">int</span> ifru_ivalue;</span><br><span class="line">		<span class="keyword">int</span> ifru_mtu;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">ifmap</span> <span class="title">ifru_map</span>;</span></span><br><span class="line">		<span class="keyword">char</span> ifru_slave[IFNAMSIZ]; <span class="comment">/*Just fits the size*/</span></span><br><span class="line">		<span class="keyword">char</span> ifru_newname[IFNAMSIZ];</span><br><span class="line">		<span class="keyword">void</span> * ifru_data;</span><br><span class="line">		sturct if_settings ifru_settings;</span><br><span class="line">	&#125;ifr_ifru;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_name ifr_ifrn.ifrn_name <span class="comment">/*interface name*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_hwaddr ifr_ifrm.ifrn_hwaddr <span class="comment">/*MAC address*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_addr ifr_ifru.ifru_addr <span class="comment">/*address*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_dstaddr ifr_ifru.ifru_dstaddr <span class="comment">/* other end of p-p lnk*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_broadaddr ifr_ifru.ifru_broadaddr <span class="comment">/* broadcast address */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_netmask ifr_ifru.ifru_netmask <span class="comment">/* interface net mask */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_flags ifr_ifru.ifru_flags <span class="comment">/* flags */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_metric ifr_ifru.ifru_ivalue <span class="comment">/* metric */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_mtu ifr_ifru.ifru_mtu <span class="comment">/* mtu */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_map ifr_ifru.ifru_data <span class="comment">/* device map */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_slave ifr_ifru.ifru_slave <span class="comment">/* slave device */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_data ifr_ifru.ifru_data <span class="comment">/* for use by interface */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_ifindex ifr_ifru.ifru_ivalue <span class="comment">/* interface index */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_bandwidth ifr_ifru.ifru_ivalue <span class="comment">/* link bandwidth */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_qlen ifr_ifru.ifru_ivalue <span class="comment">/* Queue length */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ifr_newname ifr_ifru.ifru_newname <span class="comment">/* newname */</span></span></span><br><span class="line"><span class="meta">#defien ifr_settings ifr_ifru.ifru_settings <span class="comment">/* Device/proto settings */</span></span></span><br></pre></td></tr></table></figure>

<p>fd = socket(AF_INET, SOCK_DGRAM, 0);</p>
<p>ioctrl(fd, SIOCGIADDR, &amp;ifr);会将获取接口地址，并用ifr指向其地址。也可以根据ioctrl中的flag来获取广播地址或子网掩码等。</p>
<p>最后配置/proc/sys/net/ipv4/ip_forward(ip_dynaddr, icmp_echo_ignore_broadcasts, tcp_ecn…)和/proc/sys/net/ipv4/conf/(interface)/accept_source_route(accept_redirects, log_martians…)</p>
<h3 id="1-4-2-初始化默认规则"><a href="#1-4-2-初始化默认规则" class="headerlink" title="1.4.2 初始化默认规则"></a>1.4.2 初始化默认规则</h3><p>对于默认规则是将匹配IP_CT_ESTABLISHED和IP_CT_RELATED 的状态掩码（见ip_conntrack_info）并ACCEPT 。</p>
<p>对于标准规则只是分配一个ipt_entry然后再其后append一个target。</p>
<p>对于conntrack的状态为已经建立（established）和和（related）的match，target为Accept。</p>
<h3 id="1-4-3-其它初始化"><a href="#1-4-3-其它初始化" class="headerlink" title="1.4.3 其它初始化"></a>1.4.3 其它初始化</h3><p>初始化一些TCP MSS,SYN等规则，然后初始化pppoe和pptp。</p>
<h2 id="1-5-初始化netfilter"><a href="#1-5-初始化netfilter" class="headerlink" title="1.5 初始化netfilter"></a>1.5 初始化netfilter</h2><h2 id="1-6-init-trigger-rules"><a href="#1-6-init-trigger-rules" class="headerlink" title="1.6 init trigger rules"></a>1.6 init trigger rules</h2><p>该功能在内部输出的某个端口在预先设置的内部端口范围内时触发某个指定端口来向某个server进行访问。</p>
<p>要正确设置 port trigger，您的电脑必须具备可触发路由器开启指定端口的应用程序。 以下图例为 port triggering 连接至 IRC 服务器。<br><img src="http://kmpic.asus.com/images/2014/07/29/ef5dca68-650f-4eb0-a8e1-2dbb76d57997.jpg" alt="img"></p>
<p><img src="http://kmpic.asus.com/images/2014/07/29/fec202f6-4ca0-4933-84d5-8d14c5d9638a.jpg" alt="img"></p>
<p>当连接到 IRC 服务器时，客户端（图标中的PC 2）使用端口范围 6660-7000 向外连接。</p>
<p>IRC 服务器验证用户名称，接着使用端口 113 与客户端电脑建立新连接。</p>
<p><strong>“Non-Working Port Trigger”图标显示了失败的 IRC 连接</strong>。</p>
<p>- 在此情境中，路由器因为无法决定哪一台电脑正在请求访问 IRC，因此放弃连接。</p>
<p><strong>「**Working Port Trigger。**」图标显示成功使用端口范围 6660-7000 向外连接。**，</strong>使用端口 113 传入连接**。</p>
<p>- 在此情境中，路由器的端口触发设定指定端口 113 来接收传入资料。 譬如，电脑 2 使用端口 6767 向外连接时，会暂时使用端口 113 接收所有传入连接。</p>
<p> net-wall中的实现方式如下：</p>
<p><img src="/2021/09/25/rt-dev/create_trigger_rule.png"></p>
<p>对于ipt_match后udp也可以是tcp,通过目的源地址ip和目的端口来匹配然后再target中进行触发端口设置。这里的mport是触发后的那个端口，而target中的startport和endport为触发端口范围。</p>
<p>而在kmod_trigger中也有对trigger内核驱动进行设置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">create_trigger_del_flag_proc</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	<span class="title">proc_create</span><span class="params">(<span class="string">&quot;trigger_del_flag&quot;</span>,<span class="number">0</span>, <span class="literal">NULL</span>, &amp;trigger_del_flag_fops)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">		<span class="keyword">static</span> <span class="keyword">const</span> struct file_operations trigger_del_flag_fops </span>= &#123;</span><br><span class="line">			.open =trigger_del_flag_proc_open,</span><br><span class="line">    		.read = seq_read,</span><br><span class="line">    		.write = trigger_del_flag_write,</span><br><span class="line">    		.llseek = seq_lseek,</span><br><span class="line">    		.release = single_release,</span><br><span class="line">&#125;;</span><br><span class="line">trigger_del_flag_proc_open</span><br><span class="line">    single_open</span><br><span class="line">    	...</span><br><span class="line">    这个主要是打开缓存文件</span><br><span class="line">  <span class="keyword">return</span> ipt_register_target(&amp;ipt_trigger_reg);</span><br><span class="line">	ipt_trigger_reg = &#123;</span><br><span class="line">        	.name = <span class="string">&quot;TRIGGER&quot;</span>,</span><br><span class="line">        	.target = ipt_trigger_target,</span><br><span class="line">        	.checkentry = ipt_trigger_check,</span><br><span class="line">        	...</span><br><span class="line">    &#125;</span><br><span class="line">	ipt_trigger_target</span><br><span class="line">         (ipt_trigger_info)* info= xt_action_param *par-&gt;targinfo</span><br><span class="line">		由于我们在应用程序中设置的type为IPT_TRIGGER_OUT(info-&gt;type),所以调用</span><br><span class="line">       	trigger_out</span><br><span class="line">        	将info中的信息配置到ipt_trigger结构体中并添加到一个全局链表中(trigger_list)然后启动定时器。</span><br><span class="line">    当定时器时间到时，触发trigger_timeout函数</span><br><span class="line">ip_ct_iterate_cleanup(ip_ct_kill_triggered, trig)</span><br><span class="line">        nf_ct_iterate_cleanup(&amp;init_net, iter, data)</span><br><span class="line">        	get_next_corpse(net, iter, data, &amp;bucket)</span><br><span class="line">        		iter(ct, data)</span><br><span class="line">        		ip_ct_kill_triggered(ct, trig)</span><br><span class="line">        			<span class="comment">/*比较协议和目的端口是否在startport和endport之间*/</span></span><br><span class="line">        			<span class="keyword">if</span>(trig-&gt;rproto == proto || trig-&gt;proto == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> (tri-&gt;ports.rport[<span class="number">0</span>] &lt;= dport &amp;&amp; trig-&gt;ports.rport[<span class="number">1</span>] &gt;= dport)</span><br><span class="line">            nf_ct_put(ct)<span class="comment">//释放该连接</span></span><br><span class="line">  		trigger_in</span><br><span class="line">              ct-&gt;status &amp; IPS_TRIGGER <span class="comment">//判断进来的包的连接状态是否是IPS_TRIGGER </span></span><br><span class="line">              iph = ip_hdr(skb); <span class="comment">//获取IP头部</span></span><br><span class="line">			  tcph = (<span class="keyword">void</span> *)iph + (iph-&gt;ih1 &lt;&lt; <span class="number">2</span>); <span class="comment">//获取tcp或者udp头部</span></span><br><span class="line">			  遍历trigger_list来比较是否tcp或者udp的目的端口在ipt_trigger-&gt;ipt_trigger_ports的rport[<span class="number">0</span>]和rport[<span class="number">1</span>]之间。</span><br><span class="line">             若端口是在其中间则启动定时器，并返回NF_ACCEPT来接收这个包。当定时器到了时则会释放该连接     </span><br><span class="line">       trigger_nat  </span><br><span class="line">                  前面的匹配和trigger_in差不多，但最后是调用到nf_nat_setup_info来进行IP地址的NAT转换</span><br><span class="line">                        </span><br></pre></td></tr></table></figure>

<p>在net-wall中的build_net_dnat_chains中可以看到，trigger_rule即在之前target为“TRIGGER”的ipt_entry会被添加到dnat_chain中。后面还有activate_trigger_rules, 加入IPT_TRIGGER_REFRESH和IPT_TRIGGER_IN类型的ipt_trigger_rule到net_policy的chain中。</p>
<p>对于进入的包只会匹配start_port和end_port和mport是在出去的包中进行匹配</p>
<h2 id="1-7-init-block-site-rules"><a href="#1-7-init-block-site-rules" class="headerlink" title="1.7 init block site rules"></a>1.7 init block site rules</h2><p>将value(baidu youdao …)储存到sites[]中。</p>
<p><img src="/2021/09/25/rt-dev/create_blk_site_rule.png"></p>
<p>如上图所示，防火墙首先会匹配多个端口和网站关键字，然后排除TrustIP，最后在target中将这些包reject。当然这些match为扩展match，所以应该在内核中注册这些match。</p>
<p>同样对于reject target后的数据是ipt_netgear_reject_info,也需要register target。</p>
<p>Netfilter IPv4 Hooks</p>
<ul>
<li>NF_INET_PRE_ROUTING<ul>
<li>Incoming packets pass this hook in ip_rcv() before routing</li>
</ul>
</li>
<li>NF_INET_LOCAL_IN<ul>
<li>All incoming packets addressed to the local host pass this hook in ip_local_deliver()</li>
</ul>
</li>
<li>NF_INET_FORWARD<ul>
<li>All incoming packets not addressed to the local host pass this hook in ip_forward().</li>
</ul>
</li>
<li>NF_INET_LOCAL_OUT<ul>
<li>All outgoing packets created by this local computer pass thsi hook in ip_build_and_send_pkt()</li>
</ul>
</li>
<li>NF_INET_POST_ROUTING<ul>
<li>All outgoing packets(forwarded or locally created) will pass this hook in ip_finish_output()</li>
</ul>
</li>
</ul>
<h2 id="1-8-DMZ"><a href="#1-8-DMZ" class="headerlink" title="1.8 DMZ"></a>1.8 DMZ</h2><p>路由器中默认是不让外部的网络访问内网的，可以通过DMZ来指定一个内网IP使得外网可以访问。</p>
<p>例如：DMZ server是10.10.0.10，那么在net-wall中会将这个加到/tmp/netwall-rules</p>
<blockquote>
<p>#DMZ Rules Begin:<br>DNAT            net             loc:10.10.0.10  !icmp</p>
</blockquote>
<h2 id="1-8-iptables"><a href="#1-8-iptables" class="headerlink" title="1.8 iptables"></a>1.8 iptables</h2><ul>
<li><p>iptables的匹配（matches）</p>
<p>-p –protocol 检测特定协议，必须是/etc/protocols里面定义</p>
<p>-s –src, –source 匹配源地址 可单个主机，也可地址加子网掩码匹配整个网络</p>
<p>-d –dst –destination 匹配目的地址</p>
<p>-i –in-interface 以包进入所使用的网络接口来匹配包，只能用于INPUT, FORWARD和PREROUTING三个链</p>
<p>-o, –out-interface 以包离开本地所使用的网络接口来匹配包</p>
<p>-f –fragment 用来匹配一个被分片的包的第二片或及以后的部分。</p>
<p>–sport –source-port 源端口来匹配包，不指定此项，则暗示所有端口</p>
<p>–source-port 22:80（80：22） 22到80的所有端口，可以省略第一个号，默认为0，端口前的感叹号表示取反如–source-port !22:80表示菜单22到80端口之外的所有端口</p>
<p>–dport –destination-port 匹配目的端口</p>
<p>–tcp-flags 匹配指定的TCP标记 SYN, FIN, ACK SYN RST, URG, PSH 第一个参数表示要匹配的标记，第二个参数指定再第一个列表中出现的且必须被设为1的标记，其它标记必须为0</p>
<pre><code>iptables -p tcp --tcp-flags SYN,FIN,ACK SYN表示匹配那些SYN标记被设置而FIN和ACK标记没有设置的包，注意各标记之间只有一个逗号而没有空格。
</code></pre>
<p>–syn 匹配那些SYN标记被设置而ACK和RST标记没有被设置的包</p>
<p>–tco-option</p>
<p>根据选项匹配包</p>
<ul>
<li><p>UDP匹配器</p>
</li>
<li><p>ICMP匹配器</p>
<p>–icmp-type 根据ICMP类型匹配包</p>
</li>
<li><p>显示匹配</p>
<ul>
<li><p>地址匹配选项</p>
<p>–src-type</p>
<p>iptables -A INPUT -m addrtype –src-type UNICAST</p>
<p>这个选项主要用来匹配报文的源地址类型 BROADCAST, MULTICAST</p>
<p>–dst-type</p>
</li>
<li><p>comment match</p>
<p>这个匹配器主要用来再内核和规则集里增加注释，这样就能够让人更加容易知道规则的作用并已于调试。并不是一个真正的匹配器，需要-m comment加载</p>
<p>–comment</p>
<p>iptables -A INPUT -m comment –comment “A comment”</p>
<p>–comment 选项用来添加实际的注释内容，每个注释最大的长度为256字节</p>
</li>
<li><p>contrack匹配器</p>
<p>–ctstate</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctstate RELATED</p>
<p>这个match用来根据连接跟踪的状态匹配报文状态，它和以前的状态匹配功能是一样的，可以使用的状态如下：</p>
<p>INVALID, ESTABLESHD, NEW, RELATED, SNAT, DNAT</p>
<p>一次可以匹配多个状态，但这些状态要用逗号隔开：-m conntrack –ctstate ESTABLISHED, RELATED.</p>
<p>–ctproto</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctproto TCP</p>
<p>这个match匹配协议，它和–protocol用法一样</p>
<p>–ctorigsrc</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctorigsrc 192.168.0.0/24</p>
<p>这个match匹配正向连接的源地址，用法和源地址匹配一样</p>
<p>–ctorigdst</p>
<p>iptables -A INPUT -p tcp  -m conntrackf –ctorigdst 192.168.0.0/24</p>
<p>–ctreplsrc</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctreplsrc 192.168.0.0/24</p>
<p>这个match匹配反向连接的源地址</p>
<p>–ctrepldst</p>
<p>–ctstatus</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctstatus RELATED</p>
<p>这个匹配连接的状态，可用值如下：</p>
<pre><code>NONE: 该连接没有状态

EXPECTED:这个连接是被expextation创建的期望连接

SEEN-REPLY:这个连接已经得到方向报文，但是还没有保障。

ASSURED:这个连接已经有保障了，除非它的超时或者一种关闭，这个连接才会被删除。
</code></pre>
<p>–ctexpire</p>
<p>iptables -A INPUT -p tcp -m conntrack –ctexpire 100:150</p>
<p>这个match用来匹配连接的连接跟踪系统里面的超时实际，单位s</p>
</li>
<li><p>DSCP匹配器</p>
<p>–dscp</p>
<p>iptables -A INPUT -p tcp -m dscp –dscp 32</p>
<p>这个选项指定匹配的数值，我们可以输入10进制或者16进制。</p>
<p>–dscp–class</p>
<p>iptables -A INPUT -p tcp -m dscp –dscp-class BE</p>
<p>用来基于报文的diffServ类型来匹配报文，这个值可以是RFC里面定义的BE, EF AFxx,CSxx</p>
</li>
<li><p>ECN匹配器</p>
<p>ecn match用来基于TCP的ECN字段匹配报文。</p>
<p>iptables -A INPUT -p tcp -m ecn –ecn-tcp-cwr</p>
<p>–ecn-tcp-ece</p>
<p>–ecn-ip-ect</p>
</li>
<li><p>Hashlimit匹配器</p>
<p>它为每个目的地址，源地址，目的端口以及源端口都建立hash表项。例如你可以设置每一个IP地址每秒钟最多接收1000个报文，或者你可以设置每种业务报文每秒最多200个。</p>
<p>每一条规则创建一个单独的hashtable,每个hashtable都有最大尺寸以及最大数量的桶。hash表里是一个或多个源地址，目的地址，源/目的端口的组合。</p>
<p>–hashlimit</p>
<p>iptables -A INPUT -p tcp –dst 192.168.0.3 -m hashlimit –hashlimit 1000/sec –hashlimit-mode dstip, dstport –hashlimit-name hosts</p>
<p>–hashlimit 指定每个桶的限度，在这个例子中是1000，这个数值可以是/sec ,/minute, /hour或者/day.默认是/sec</p>
<p>–hashlimit-mode</p>
<p>–hashlimit-mode选项指定了那些值用来作为hash的key.这个例子里面，我们用dstip,所以192.168.0.0/16网络里面的每台主机都会被限制1000/sec，我们可以在源/目的地址，源/目的端口里面选择一个或多个</p>
<p>–hashlimit-name</p>
<p>这个选项指定了具体hash的名称，可以在/proc/net/ipt_hashlimit里面看到</p>
<p>–hashlimit-burst</p>
<p>iptables -A INPUT -p tcp –dst 192.168.0.3 -m hashlimit –hashlimit 1000 –hashlimit-mode dstip,dstport –hashlimit-name hosts –hashlimit-burst 2000</p>
<p>这个选项和–limit-burst一样设置桶的最大尺寸，每个桶都会有一个突发大小，令牌桶的工作原理参考limit match</p>
<p>–hashlimit-htable-size</p>
<p>这个选项设置最多可用的桶的数目</p>
<p>–hashlimit-htable-max</p>
<p>设定hash表项的最大值，包含所有连接，当然包含那些暂时没有激活的连接</p>
<p>–hashlimit-htable-gcinterval</p>
<p>垃圾回收多久运行，太小占系统资源，太大会有大量无用连接占用hash表项。</p>
<p>–hashlimit-htableg-expire</p>
<p>这个值设定一个空闲的hash表项会超时，假如一个桶长于这个时间没有使用，它就会超时，接着下一次垃圾回收就会把它从hash表项中删除</p>
</li>
<li><p>helper匹配器</p>
<p>这个match是基于连接的helper模块名称来匹配报文的。我们看下FTP的会话，首先打开控制绘画，接着在控制会话里面协商数据会话的参数，ip_conntrack_ftp helper模块就会发现这个协商数据，接着创建一个关联的连接到控制连接上，这个一个报文进来我们就能够知道它管理到哪一个协议。</p>
<p>–helper</p>
<p>iptables -A INPUT -p tcp -m helper –helper ftp-21</p>
<p>–heper选项的参数是一个字符串，它告诉match哪一个helper被匹配，我们可以指定在哪个端口上面这个期望被创建</p>
</li>
<li><p>IP范围匹配器</p>
<p>IP范围匹配用来匹配一整段的IP,和–source以及destination匹配工作原理一样，只是IP范围更加灵活，它可以匹配整段的地址。</p>
<p>–src-range</p>
<p>iptalbes -A INPUT -p tcp -m iprange –src-range 192.168.1.13-192.168.2.19</p>
<p>匹配从192.168.1.13到192.168.2.19之内的所有地址，也可以！取反</p>
<p>–dst-range</p>
</li>
<li><p>长度匹配器</p>
<p>–length</p>
<p>iptalbes -A INPUT -p tcp -m length –length 1400:1500</p>
</li>
<li><p>限速匹配器</p>
<p>这个匹配必须由-m limit指定才能使用</p>
<p>–limit</p>
<p>iptables -A INPUT -m limit –limit 3/hour</p>
<p>一小时最多匹配3次</p>
<p>–limit-burst</p>
</li>
<li><p>MAC地址匹配器</p>
<p>iptables -A INPUT -m mac –mac-source 00:00:00:00:00:01</p>
<p>基于包的MAC源地址匹配包</p>
</li>
<li><p>Mark匹配器</p>
<p>–mark</p>
</li>
<li><p>多端口匹配器</p>
<p>–source-port</p>
<p>iptables -A INPUT -p tcp -m multiport –source-port 22,53,80,110</p>
<p>最多能够匹配15个不连续的源端口，它使用的前提是通过-p tcp或者-p udp指定协议，其实它就是增强版的–source-port功能</p>
<p>–destination-port</p>
<p>–port</p>
<p>iptables -A INPUT -p tcp -m multiport –port 22,53,80,110</p>
<p>同端口多端口匹配，意思是它匹配的是那种源端口和目的端口是同一个端口的包，如80到80，110到110</p>
</li>
<li><p>报文类型匹配器</p>
<p>–pkt-type</p>
<p>iptables -A OUTPUT -m pkttype –pky-type unicast</p>
<p>–pkt-type告诉报文类型匹配器什么样的报文将被匹配，它的值可能是unicast, broadcast or multicast可取反</p>
</li>
<li><p>状态匹配器</p>
<p>iptables -A INPUT -m state –state RELATED, ESTABLISHED</p>
<p>指定要匹配包的状态，INVALID, ESTABLISHED, NEW和RELATED。</p>
</li>
</ul>
</li>
<li><p>iptables的动作（target）和跳转（jumps）</p>
<p>DNAT target</p>
<p>DNAT target 用来做目的地址转换，换句话讲就是重写报文的目的地址。DNAT只在NAT表里面的PREROUTING和OUTPUT链上有效。</p>
<p>–to-destination</p>
<p>iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 –dport 80 -j DNAT –to-destination 192.168.1.1-192.168.1.10</p>
<p>指定要写入IP头的地址，这也是包要被转发到的地方。上面的例子就是要把发往地址15.45.23.67的包都转发到一段LAN使用的私有地址中，即192.168.1.1到192.168.1.10.如前所述，在这种情况下，每个流都会被随机分配一个要转发到的地址，但同一个流总是使用同一个地址。我们也可以只指定一个IP地址作为参数，这样所有的包都被转发到同一台机子。我们还可以在地址后指定一个或一个范围端口。比如：–to-destination 192.168.1.1:80或–to-destination 192.168.1.1:80-100. SNAT的语法和这个target的一样，只是目的不同罢了。要注意只有先用–protocol指定了TCP或UDP协议，才能使用端口。</p>
<p>eg:我们想通过internet发布我们的web服务，但是我们只有一个IP地址，并且HTTP服务器放置在我们的内网中，这条防火墙就有了唯一的IP地址，我们称之为$INET_IP，而HTTP服务器有一个内网地址，我们称之为$HTTP_IP。最后防火墙郑家一个内网地址$LAN_IP.那么我们在NAT表的PREROUTING链里面要做的第一件事情如下：</p>
<p>iptables -t nat -A PREROUTING –dst $INET_IP -p tcp –dport 80 -j DNAT –to-destination $HTTP_IP</p>
<p>所有从Internet上面访问本机80端口的报文都会被转发到内部的HTTP服务器上面。假如你通过Internet做上面的测试，一切工作非常完美。假如你通过同一内网其它主机访问这台web服务器呢？那么它就工作不正常了。这其实是路由的问题。我们把外网访问我们服务器的那台机器的IP地址记为$EXT_BOX.</p>
<ol>
<li>包从地址为$EXT_BOX的机器出发，去往地址为$INET_IP的机子</li>
<li>报文到达防火墙</li>
<li>防火墙这个报文做地址转换，而且这个报文还要通过其它很多链。</li>
<li>报文离开防火墙并被转发到$HTTP_IP</li>
<li>报文到达HTTP服务器，并且HTTP服务器对这个报文做出应答，应答包需要再次通过防火墙。当然，这要求防火墙作为HTTP到达$EXT_BOX的网关。一般情况下，防火墙就是HTTP服务器的缺省网关。</li>
<li>防火墙复原返回报文，这样这个报文看起来就像是防火墙自己发出的。</li>
<li>返回报文和往常一样返回$EXT_BOX</li>
</ol>
<p>现在看看假如和HTTP服务器一个网络的主机访问会出现什么问题。这儿我们定义访问的主机地址为$LAN_BOX, 其它不变。</p>
<ol>
<li>报文离开￥LAN_BOX到到$INET_IP</li>
<li>报文到达防火墙</li>
<li>报文做DNAT以及所需的操作，但是这个报文没有做SNAT,所以源地址仍然是一样的。</li>
<li>报文离开防火墙并且达到HTTP服务器。</li>
<li>HTTP服务器尝试回应这个包，查找路由表得知是同一个网络的主机，所有就直接给这台主机发送回应报文。</li>
<li>回复包到达客户机，但它会困惑，因为这个包不是来自它访问的那台机子。这样，它就会把这个包扔掉去等待“真正”的回复包</li>
</ol>
<p>如果对那些进入防火墙而且是去往地址为$HTTP_IP、端口是80的包做SNAT操作，那么那些包好像是从$LAN_IP来的了，也就是这些包的源地址被改为$LAN_IP了。这样，HTTP服务器就会把回复包发给防火墙，而防火墙会再对包做un-DNAT操作，并把包发送给客户机</p>
<p>iptables -t nat -A POSTROUTING -p tcp –dst $HTTP_IP –dport 80 -j SNAT –to-source $LAN_IP</p>
<p>对于防火墙自己访问HTTP服务器，还是不行，我们要再nat表的OUTPUT链中添加下面的规则：</p>
<p>iptables -t nat -A OUTPUT –dst $INET_IP -p tcp –dport 80 -j DNAT –to-destination $HTTP_IP</p>
<p>和HTTP服务器不在同一个网的机子能正常访问</p>
<p>和它在一个内网的机子也可以正常访问</p>
<p>防火墙本身也能访问</p>
<ul>
<li><p>DROP target</p>
<p>顾名思义，如果包符合条件，这个target就会把它丢弃。</p>
<p>REJECT target 在丢弃包的同时还返回一个错误信息。</p>
</li>
<li><p>DSCP target</p>
<p>这个target修改报文里面的DSCP mark,DSCP target能够设吹TCP报文的DSCP只为任意你想要的。DSCP是一种把服务分类的方法，并且基于这些分类方法在通过路由器的时候给予不同的优先级。通过这个方法，你可以对交换性强的TCP会话一个交互性强的连接。对于一些优先级低的连接，例如SMTP,你可以通过一些慢速网络传递。</p>
<p>–set-dscp</p>
<p>iptables -t mangle -A FORWARD -p tcp –dport 80 -j DSCP -set-dscp 1</p>
</li>
<li><p>MASQUERADE target </p>
<p>这个target和SNAT target的作用是一样的，区别就是它不需要指定 –to-source. MASQUERADE 是专门涉及用于那些动态获取IP地址的连接的，比如拨号上网、DHCP连接等。如果有固定IP还是用SNAT target</p>
<p>伪装一个连接意味着，我们自动获取网络接口的IP地址，而不使用–to-source. 当接口停用时，MASQUERADE不会记住任何连接，这在我们kill掉接口时是有很大的好处。如果我们使用的是SNAT target，连接跟踪的数据是被保留下来的，而且时间要好几天，着可是要占用很多连接跟踪的内存的。和SNAT一样只能用于nat表的POSTROUTING链</p>
<p>–to-ports</p>
<p>iptables -t nat -A POSTROUTING -p TCP -j MASQUERADE –to-ports 1024-31000</p>
<p>在指定TCP或UDP的前提下，设置外出包能使用的端口。</p>
</li>
<li><p>NETMAP target</p>
<p>NETMAP是SNAT和DNAT的新实现，在转化过程里面做的是1：1的映射，即一个私有地址映射到一个公网地址，它们的主机地址部分不做更改。</p>
<p>iptables -t mangle -A PREROUTING -s 192.168.1.0/24 -j NETMAP –to 10.5.6.0/24</p>
<p>192.168.1.x会直接变成10.5.6.x。</p>
</li>
<li><p>REDIRECT target</p>
<p>在防火墙所在的机子内部转发包或到另一个端口。比如，我们可以把所有去往端口HTTP的包REDIRECT到HTTP proxy，当然着都发生在我们自己主机内部。它只能用在nat表的PREROUTING、OUTPUT链和被它们调用的自定义链里。</p>
<p>–to-ports</p>
<p>iptables -t nat -A PREROUTING -p tcp –dport 80 -j REDIRECT –to-ports 8080</p>
<p>在指定TCP或UDP协议的前提下，定义目的端口，方法如下：</p>
<ol>
<li>不使用这个选项，目的端口不会被改变</li>
<li>指定一个端口，如–to-ports 8080</li>
<li>指定端口范围，如–to-ports 8080-8090</li>
</ol>
</li>
<li><p>REJECT target</p>
<p>–reject-with</p>
<p>iptables -A FORWARD -p TCP –dorpt 22 -j REJECT –reject-with tcp-reset</p>
<p>告诉REJECT target 应向发送者返回什么样的信息。一旦满足了设定的条件，就要发送相应的信息，然后再像DROP一样无情的抛弃。</p>
<p>可用的信息类型：</p>
<pre><code>1. icmp-net-unreachable
2. icmp-host-unreachable
3. icmp-port-unreachable
4. icmp-proto-unreachable
5. icmp-net-prohibited
6. icmp-host-prohibited.
</code></pre>
</li>
<li><p>RETURN target</p>
<p>它使包返回上一层，顺序是：子链-&gt;父链-&gt;缺省的策略。就是若在子链中遇到了RETURN，则返回父链的下一条规则继续进行条件的比较。若是在父链中遇到RETURN，就要被缺省策略（一般是ACCEPT或DROP）。</p>
</li>
<li><p>SNAT target</p>
<p>这个target是用来源网络地址转换的，就是重写包的源IP地址。当我们有几个机子共享一个Internet连接时，就能用到它了。先在内核里打开ip转发功能，然后再写一个SNAT规则，就可以把所有从本地网络出去的包的源地址改为Internet连接的地址了。</p>
<p>–to-source</p>
<p>iptables -t nat -A POSTROUTING -p tcp -o eth- -j SNAT –to-source 194.236.50.155-194.236.50.160:1024-32000</p>
<p>指定源地址和端口，有以下几种方式：</p>
<ol>
<li>单独的地址。</li>
<li>一段连续的地址，用连字符分隔，如194.236.50-194.236.50.160，这样可以实现负载平衡。每个流被随机分配一个IP，但对于同一个流使用的时同一个IP</li>
<li>在指定-p tcp或udp的前提下，可以指定源端口的范围如194.236.50.155：1024-32000.</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="1-9-add-rule-to-net-wall"><a href="#1-9-add-rule-to-net-wall" class="headerlink" title="1.9 add rule to net-wall"></a>1.9 add rule to net-wall</h2><ul>
<li>descption: 自己添加一个可以block url site的规则，目前我们项目中的block url site只能block http.</li>
<li>实现目标：使能后被block的网站不能通过浏览器访问。但如果是trustIP(可以是多个)则可以访问该网站。</li>
<li>实现方法：通过nslookup(自己实现)来获取到该网站的IP地址，block发送该网站的所有IP地址的80， 8080， 8008和443端口。</li>
</ul>
</li>
<li><p>实际上，match来匹配目的IP为nslookup获取到的IP地址（可能有多个）， 而target是reject就可以了，也就是这个table属于filter。这个应该属于扩展match，我们在匹配目的IP地址的时候进行多个IP地址匹配，同时也进行多个目的端口匹配。与此同时，对于源IP是TrustIP(也可能是多个)，我们直接认为这个包不符合我们的match。</p>
</li>
<li><p>扩展match中用到的match后跟着的数据结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipt_urlBlock_info_mul</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> TrustIP[<span class="number">32</span>];<span class="comment">//最多可支持32个Trust IP地址</span></span><br><span class="line">    <span class="keyword">int</span> TrustIP_num; <span class="comment">//要TrustIP 数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> BlkIP[<span class="number">64</span>]; <span class="comment">//最多可block 64个IP地址</span></span><br><span class="line">    <span class="keyword">int</span> BlkIP_num;<span class="comment">//要block的IP数量</span></span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>

<p><mark>需要注意的是我在开始的时候用的是指针即”unsigned int *TrustIP;”而不是数组，因为指针的大小固定，它指向一个地址，而我们在用户空间的是虚拟地址，所以会在这个match的kmod中出现不能处理这个虚拟地址的报错，并因此crash。</mark></p>
</li>
<li><p>net-wall中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">init_blk_site_rules_mul(); <span class="comment">//shorewall.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_blk_site_rules_mul</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_multiport_v1</span> <span class="title">mp</span>;</span></span><br><span class="line">    conntrack_tcp_forward(<span class="number">0</span>);<span class="comment">//echo 0&gt;/proc/sys/net/ipv4/netfilter/ip_conntrack_tcp_forward_accept</span></span><br><span class="line">    mp.count = <span class="number">4</span>;</span><br><span class="line">    mp.ports[<span class="number">0</span>] = <span class="number">80</span>;</span><br><span class="line">    mp.ports[<span class="number">1</span>] = <span class="number">8080</span>;</span><br><span class="line">    mp.ports[<span class="number">2</span>] = <span class="number">8008</span>;</span><br><span class="line">    mp.prots[<span class="number">3</span>] = <span class="number">443</span>;</span><br><span class="line">    blksite_rule = create_block_url_rule_mul(&amp;mp, IPT_NETGEAR_HTTP_SITE_PROHIBITED);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> struct ipt_entry *<span class="title">create_block_url_rule_mul</span><span class="params">(struct ipt_multiport_v1 *mp, ipt_reject_with rejwith)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*其它关于multiport的code与create_block_url_rule匹配的一致*/</span></span><br><span class="line">     m = append_match(&amp;e, <span class="string">&quot;urlBlock_mul&quot;</span>, <span class="keyword">sizeof</span>(struct ipt_urlBlock_info_mul))   </span><br><span class="line">     blkinfo = (struct ipt_urlBlock_info_mul *)m-&gt;data;</span><br><span class="line">    <span class="keyword">if</span>(config_match(<span class="string">&quot;block_endis_Trusted_IP&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Trust_IP_num = atoi(config_get(<span class="string">&quot;block_endis_Trusted_IP_num&quot;</span>));</span><br><span class="line">        trust_ip_size = Trusted_IP_num &lt; <span class="number">32</span> ? Trusted_IP_num : <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt; trust_ip_size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(tmp_name, <span class="string">&quot;block_trustedip%d&quot;</span>, i);</span><br><span class="line">            blkinfo-&gt;TrustIP[i] = inet_addr(config_get(tmp_name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    blkinfo-&gt;TrustIP_num = Trusted_IP_num;</span><br><span class="line">    blk_ip_num = atoi(config_get(<span class="string">&quot;BlkIPNum&quot;</span>));</span><br><span class="line">    url_des=fopen(<span class="string">&quot;/tmp/url_to_ip.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(url_des == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    blk_ip_size = blk_ip_num &lt;<span class="number">128</span> ? blk_ip_num :<span class="number">128</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt; blk_ip_size; &amp;&amp; fgets(url_buf, <span class="number">128</span>, url_des); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        blkinfo-&gt;BlkIP[i] inet_addr(url_buf);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(url_des);</span><br><span class="line">    blkinfo-&gt;BlkIP_num = blk_ip_num;</span><br><span class="line">    ...</span><br><span class="line">     <span class="comment">/*后面是关于reject的target不变*/</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于扩展的match，只需控制match-&gt;data[0]所指向的数据即可。</p>
</li>
<li><p>kmod中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ipt_urlBlock_mul_match</span><span class="params">(<span class="keyword">const</span> struct sk_buff *skb, struct xt_action_param *par)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_urlBlock_info_mul</span> *<span class="title">blkinfo</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *matchinfo = par-&gt;matchinfo;</span><br><span class="line">    iph = ip_hdr(skb); <span class="comment">//获取ip头部</span></span><br><span class="line">    blkinfo = (struct ipt_urlBlock_info_mul *)matchinfo;</span><br><span class="line">    <span class="keyword">if</span>(blkinfo == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; blkinfo-&gt;TrustIP_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(blkinfo-&gt;TrustIP == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/*如果源IP地址和我们信任的IP地址相同就直接跳过*/</span></span><br><span class="line">        <span class="keyword">if</span>(iph-&gt;saddr == blkinfo-&gt;TrustIP[I])</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; blkinfo-&gt;BlkIP_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(blkinfo-&gt;BlkIP == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/*如果目的IP地址为我们block的IP地址则认为是匹配到*/</span></span><br><span class="line">            <span class="keyword">if</span>(iph-&gt;daddr == blkinfo-&gt;BlkIP[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_match</span> <span class="title">urlBlock_mul_match</span> =</span> &#123;</span><br><span class="line">    .name = <span class="string">&quot;urlBlock_mul&quot;</span>,</span><br><span class="line">    .match = ipt_urlBlock_mul_match,</span><br><span class="line">    .family = NFPROTO_IPV4,</span><br><span class="line">    .proto = IPPROTO_TCP,</span><br><span class="line">    .matchsize = <span class="number">-1</span>,</span><br><span class="line">    .me = THIS_MODULE</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> xt_register_match(&amp;urlBlock_mul_match);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><p>解析URL地址</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> h_errno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> URL_IP <span class="meta-string">&quot;/tmp/url_to_ip.txt&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parse_url2file</span><span class="params">(<span class="keyword">char</span> **url, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">host</span>,*<span class="title">host2</span>;</span></span><br><span class="line">	<span class="keyword">char</span> hname[<span class="number">30</span>];</span><br><span class="line">	<span class="keyword">int</span> value=<span class="number">0</span>;</span><br><span class="line">	FILE *url_des=<span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> m=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> len=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">long</span> read_offset=<span class="number">0</span>;	</span><br><span class="line">	url_des = fopen(URL_IP, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(url_des == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open file error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">for</span>(m=<span class="number">0</span>; m&lt;size; m++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">		host=<span class="literal">NULL</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;url%d:%s \n&quot;</span>, m, url[m]);</span><br><span class="line">		host=gethostbyname(url[m]);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;gethostbyname\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(host==<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;host == NULL\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(h_errno)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> NO_ADDRESS:</span><br><span class="line">				value=<span class="number">1</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;The requested name is valid but does not have an IP address.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> NO_RECOVERY:</span><br><span class="line">				value=<span class="number">2</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;A non-recoverable name server error occurred.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> TRY_AGAIN:</span><br><span class="line">				value=<span class="number">3</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;A temporary error occurred on an authoritative name server. Try again later.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> HOST_NOT_FOUND:</span><br><span class="line">				value=<span class="number">4</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;The specified host is unknown.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				value=<span class="number">-1</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Unknown error.\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		fclose(url_des);</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">128</span>]=&#123;<span class="number">0</span>&#125;;	</span><br><span class="line">	<span class="keyword">while</span>(host-&gt;h_addr_list[i])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* one line includes a url and its ip addresses like this www.baidu.com:104.193.88.77;104.193.88.123</span></span><br><span class="line"><span class="comment">		 * when update url&#x27;s ip addresses, firstly, we should match the url. if not, we should add the url to new line, else we just update  </span></span><br><span class="line"><span class="comment">		 * </span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Name:	%s\n&quot;</span>,host-&gt;h_name);			</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Address: %u.%u.%u.%u\n&quot;</span>,host-&gt;h_addr_list[i][<span class="number">0</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">1</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">2</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">3</span>] &amp; <span class="number">0x000000FF</span>);</span><br><span class="line">		<span class="built_in">sprintf</span>(buf, <span class="string">&quot;%u.%u.%u.%u\n&quot;</span>,host-&gt;h_addr_list[i][<span class="number">0</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">1</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">2</span>] &amp; <span class="number">0x000000FF</span>,host-&gt;h_addr_list[i][<span class="number">3</span>] &amp; <span class="number">0x000000FF</span>);</span><br><span class="line">		i++;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;buf:%s\n&quot;</span>, buf);	</span><br><span class="line">		len=<span class="built_in">strlen</span>(buf);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		read_offset += len;</span></span><br><span class="line"><span class="comment">		fputs(buf, url_des);</span></span><br><span class="line"><span class="comment">		fseek(url_des, read_offset, SEEK_SET);</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="built_in">fprintf</span>(url_des, <span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(url_des);</span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* url_sites[]=&#123;<span class="string">&quot;www.baidu.com&quot;</span>,<span class="string">&quot;www.cn.bing.com&quot;</span>&#125;;</span><br><span class="line">	parse_url2file(url_sites, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个进程的功能相当于nslookup, 将解析的的IP地址存在/tmp/url_to_ip.txt中，也可以直接将nslookup解析到的IP地址写入到/tmp/url_to_ip.txt</p>
<blockquote>
<p>设置config值：</p>
<pre><code>block_endis_Trusted_IP_num=2
block_trustedip0=192.168.1.6
block_trustedip1=192.168.1.7
    
BlkIPNum=2
</code></pre>
</blockquote>
<p>测试时最好在单网卡情况下进行，或者设置好其它网卡的路由。</p>
<p>设置完成后用浏览器访问<a target="_blank" rel="noopener" href="http://www.baidu.com和www.cn.bing.com,会出现访问不了的现象./">www.baidu.com和www.cn.bing.com，会出现访问不了的现象。</a></p>
<p>而将LAN PC的IP地址改为192.168.1.6后，再次访问这两个地址就可以了。</p>
<ul>
<li><p>小结</p>
<p>这个例子只是用来测试用的，在kmod中可以用printk添加一些打印，会发现所有的包都会来匹配，那么代码中使用循环来遍历我在用户空间设置的IP地址，肯定会影响网络包的流通速度。可以将用户层的IP地址转变成哈希表来匹配，这样会减少不必要的遍历。</p>
</li>
</ul>
<h2 id="1-10-conntrack"><a href="#1-10-conntrack" class="headerlink" title="1.10 conntrack"></a>1.10 conntrack</h2><ul>
<li><p>数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_tuple</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_man</span> <span class="title">src</span>;</span>  <span class="comment">//源端信息</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//目的端信息。</span></span><br><span class="line">    <span class="comment">/* These are the parts of the tuple which are fixed. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">nf_inet_addr</span> <span class="title">u3</span>;</span>  <span class="comment">//目的IP地址</span></span><br><span class="line"> <span class="comment">//目的端口的信息，不同协议使用不同的报文字段</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">             <span class="comment">/* Add other protocols here. */</span></span><br><span class="line">            __be16 all;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                __be16 port;<span class="comment">//TCP报文就使用目的端口</span></span><br><span class="line">            &#125; tcp;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                 __be16 port;<span class="comment">//UDP报文就使用目的端口</span></span><br><span class="line">            &#125; udp;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                <span class="keyword">u_int8_t</span> type, code;<span class="comment">//ICMPP报文使用type，cod两个字段</span></span><br><span class="line">            &#125; icmp;</span><br><span class="line">            。。。。。。。 <span class="comment">//其他协议此处省略</span></span><br><span class="line">        &#125; u;</span><br><span class="line">        <span class="comment">//传输层协议类型，既L4协议类型</span></span><br><span class="line">        <span class="keyword">u_int8_t</span> protonum;</span><br><span class="line">        <span class="comment">//标识连接的方向，一条连接分两个方向，一来一回</span></span><br><span class="line">        <span class="comment">/* The direction (for tuplehash) */</span></span><br><span class="line">        <span class="keyword">u_int8_t</span> dir;</span><br><span class="line">    &#125; dst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_man</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">     <span class="class"><span class="keyword">union</span> <span class="title">nf_inet_addr</span> <span class="title">u3</span>;</span> <span class="comment">//IP地址</span></span><br><span class="line">    <span class="comment">//L4协议源端信息</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">nf_conntrack_man_proto</span> <span class="title">u</span>;</span></span><br><span class="line">    <span class="comment">//L3协议类型</span></span><br><span class="line">    <span class="keyword">u_int16_t</span> l3num;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//L4层源端的信息。</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">nf_conntrack_man_proto</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* Add other protocols here. */</span></span><br><span class="line">    __be16 all;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        __be16 port;</span><br><span class="line">    &#125; tcp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        __be16 port;</span><br><span class="line">    &#125; udp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        __be16 id;</span><br><span class="line">    &#125; icmp;</span><br><span class="line">    。。。。。。<span class="comment">//其他协议此处省略</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面数据结构定义看，标识一条连接的元组为：<br>TCP  源IP，源端口，L3协议类型，目的IP，目的端口号，L4协议类型<br>UDP  源IP，源端口，L3协议类型，目的IP，目的端口号，L4协议类型<br>ICMP 源IP，L3协议类型，目的IP，id，type，code,，L4协议类型</p>
<p>其它协议。</p>
<ul>
<li>conntrack的定义</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">一个连接包含正反两个方向的两条报文流。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_conn</span> &#123;</span></span><br><span class="line">    <span class="comment">//对连接的引用计数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack</span> <span class="title">ct_general</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> lock;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//正向和反向的连接元组信息。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_tuple_hash</span> <span class="title">tuplehash</span>[<span class="title">IP_CT_DIR_MAX</span>];</span></span><br><span class="line">    <span class="comment">//该连接的连接状态</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> status;</span><br><span class="line">    <span class="comment">//如果该连接是期望连接，指向跟其关联的主连接</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_conn</span> *<span class="title">master</span>;</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	连接垃圾回收定时器</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timeout</span>;</span></span><br><span class="line">	    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	存储特定协议的连接跟踪信息</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">nf_conntrack_proto</span> <span class="title">proto</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*指向扩展结构，该结构中包含一些基于连接的功能扩展处理函数 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_ct_ext</span> *<span class="title">ext</span>;</span></span><br><span class="line">   </span><br><span class="line">	<span class="comment">//网络命名空间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">ct_net</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_tuple_hash</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_nulls_node</span> <span class="title">hnnode</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack_tuple</span> <span class="title">tuple</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*每个struct nf_conn实例代表一个连接。每个skb都有一个指针，指向和它相关联的连接。*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> &#123;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">nf_conntrack</span> *<span class="title">nfct</span>;</span><span class="comment">//指向struct nf_conn实例</span></span><br><span class="line">	kmemcheck_bitfield_begin(flags1);</span><br><span class="line">	    __u8 local_df:<span class="number">1</span>,</span><br><span class="line">	   cloned:<span class="number">1</span>,</span><br><span class="line">	  ip_summed:<span class="number">2</span>,</span><br><span class="line">	  nohdr:<span class="number">1</span>,</span><br><span class="line">	  nfctinfo:<span class="number">3</span>; <span class="comment">//记录报文的连接状态。</span></span><br><span class="line">	  kmemcheck_bitfield_end(flags1);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 每个网络命名空间有如下一个数据结构的实例，来管理和存放生成的连接的一些信息。*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netns_ct</span> </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> expect_count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> htable_size; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">nf_conntrack_cachep</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_nulls_head</span> *<span class="title">hash</span>;</span><span class="comment">//存放已经经过确认的连接hash表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">expect_hash</span>;</span><span class="comment">//期望连接hash表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_nulls_head</span> <span class="title">unconfirmed</span>;</span> <span class="comment">//存放没经过确认的连接hash表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_nulls_head</span> <span class="title">dying</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_conntrack_stat</span> *<span class="title">stat</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> hash_vmalloc;</span><br><span class="line">    <span class="keyword">int</span> expect_vmalloc;</span><br><span class="line">    <span class="keyword">char</span> *slabname;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>…</p>
</li>
<li><p>NAT</p>
<ul>
<li><p>SNAT</p>
<p>发出去的时候替换源IP</p>
</li>
<li><p>DNAT</p>
<p>收到包时替换目的IP</p>
</li>
<li><p>无论是SNAT还是DNAT它target最终调用到nf_nat_setup_info来修改contrack中的源目的IP和端口等信息。</p>
</li>
<li><p>NAT hook函数中最终调用nf_nat_packet根据contrack中的信息修改skb的IP地址和端口等信息。</p>
</li>
</ul>
<p>在1.0.4的当网络包在内核传输调用firewall的过程分析过程可以看到在target调用完成后再调用nf_nat_packet函数。</p>
</li>
</ul>
<h2 id="1-11总结"><a href="#1-11总结" class="headerlink" title="1.11总结"></a>1.11总结</h2><p>开发过程中需要注意的是对于match来说两个参数一个是skb,另一个是传入的数据，而传入的数据必须是skb中有的所以，必须了解skb中所包含的内容，这样在扩展match时可以信手拈来。</p>
<p>而对于target来说也是包含这两个参数，不同的是target可以决定包的去向，我们一般是Drop或者Accept，但是由于NAT的引入，所以会出现转发等。而要了解NAT则需进一步了解conntrack</p>
<h1 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h1><h1 id="1-路由器中的连接结构"><a href="#1-路由器中的连接结构" class="headerlink" title="1 路由器中的连接结构"></a>1 路由器中的连接结构</h1><h2 id="1-1-XR500中的结构"><a href="#1-1-XR500中的结构" class="headerlink" title="1.1 XR500中的结构"></a>1.1 XR500中的结构</h2><p>对于像XR500中的只有一个switch, CPU与switch的连接示意图如下所示：</p>
<p><img src="/2021/09/25/rt-dev/switch_to_cpu_structure_xr500.png" alt="switch2cpu"></p>
<p>本文档中所有XR500的举例都是基于V2.3.2.122</p>
<p>在console中输入“swconfig dev switch0 show”, 可以看到</p>
<blockquote>
<p>VLAN 1:<br>vid: 1<br>ports: 1 2 3 4 6<br>VLAN 2:<br>vid: 2<br>ports: 0 5</p>
</blockquote>
<p>拿到一个路由器，可以看到它有5个端口，这5个端口从WAN口开始在switch中分别由‘5’，‘4’，‘3’，‘2’，‘1’代表。其实它还有两个端口，这两个端口连接Linux系统的eth0和eth1.</p>
<p>switch除开VLAN功能外，只是一个具有记忆功能的HUB。也就是说在XR500等路由器启动后，不对switch进行配置，它是不分WAN和LAN的，它都是在同一个局域网内。</p>
<p>上面的VLAN1和VLAN2是对WAN和LAN的划分。vlan 1, 顾名思义，是将1 2 3 4 6划分在同一个局域网，而vlan 2 是将端口 0 和 5划分到一个局域网。需要注意的是，这里的数字后没有带t, 也就是不带tag。对于没有带tag的端口它只能划分到一个局域网中，而不是像带tag时的端口可以根据tag的vid来处于不同的局域网。例如：</p>
<blockquote>
<p>VLAN 1:<br>vid: 1<br>ports: 1 2 3 4 6<br>VLAN 2:<br>vid: 2<br>ports: 0 1 5</p>
</blockquote>
<p>上面将端口1（实际上是路由器上标识的端口4）同时设置带VLAN 1和VLAN 2。测试会发现端口1只能拿到VLAN 2中dhcp分配的IP 地址，即使WAN没有任何dhcp server, 端口1也不会从LAN端获取IP地址。因为swconfig是先把端口1划分到VLAN 1，接着又把端口1划分到VLAN 2，最终端口1只在最后设置的VLAN2中有效。</p>
<h2 id="1-2-Orbi中的结构"><a href="#1-2-Orbi中的结构" class="headerlink" title="1.2 Orbi中的结构"></a>1.2 Orbi中的结构</h2><p>以MINI举例（以下都是基于V2.3.7.22）</p>
<p><img src="/2021/09/25/rt-dev/switch_to_cpu_structure_orbi.png" alt="switch_to_cpu_structure_orbi"></p>
<p>如上图所示，mini中的switch与CPU只有一个端口相连，switch发送给CPU的包会带有port_id,CPU会根据port_id来区分该包是走eth0还是走eth1。</p>
<p>在essedma/edma_axi.c中的edma_axi_probe函数中可以看到，将端口ID填充到网络设备查找表（portid_netdev_lookup_tbl）。如下图关于edma的设备树(linux-version/arch/boot/dts/qcom-ipq40xx.dtsi)的中关于eth0和eth1的vlan_tag分别为0x02和0x3c。那么0x02 -&gt; 00000010 -&gt; port1会在网络设备查找表中对应eth0,而0x3c -&gt; 00111100 -&gt; port2, port3, port4, port5会在网络设备查找表对应eth1。这里switch的port5并没有接出来。</p>
<p>在essdma/edma.c中的edma_rx_complete会根据switch中传入的port_id来查询网络设备查找表来找到该port_id对应的网络设备即eth0或eth1。</p>
<p><img src="/2021/09/25/rt-dev/mini_dts" alt="qcom-ipq40xx.dtsi"></p>
<p>ssdk_sh vlan entry show</p>
<blockquote>
<p>root@RBR40:/# ssdk_sh vlan entry show</p>
<p>SSDK Init OK!<br>[vid]:1     [fid]:1      [member]:0x1d<br>[tagged_member]:0x0     [untagged_member]:0x1d    [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:2     [fid]:2      [member]:0x3<br>[tagged_member]:0x0     [untagged_member]:0x3     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>total 2 entries</p>
<p>operate done.</p>
</blockquote>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>  vid: 1<br>  ports: 0 2 3 4<br>VLAN 2:<br>  vid: 2<br>  ports: 0 1</p>
</blockquote>
<p>对比两个命令来看：</p>
<p>VLAN1: member:0x1d ports:0 2 3 4</p>
<p>VLAN2: meber:0x3 ports: 0 1</p>
<p>0xld-&gt; 00011101   0x3-&gt;00000011</p>
<p>这样可以理解为：</p>
<p>bit 0 -&gt; port0; bit 1 -&gt; port1; bit 2 -&gt; port2; bit 3 -&gt; port3; bit 4 -&gt; port4; </p>
<p>那么就可以知道0x1d其实是设置的port0, port2, port3, port4为一个VLAN。而 port0和port1为一个VLAN。</p>
<p>从上面的配置可以知道，WAN和LAN两个局域网都包括端口0，这个switch只通过一个端口连接CPU。在硬件上少一个端口，必须在软件上来对不同的局域网进行区分。</p>
<h1 id="2-WAN和LAN的划分"><a href="#2-WAN和LAN的划分" class="headerlink" title="2 WAN和LAN的划分"></a>2 WAN和LAN的划分</h1><h2 id="2-1-XR500的WAN和LAN的划分"><a href="#2-1-XR500的WAN和LAN的划分" class="headerlink" title="2.1 XR500的WAN和LAN的划分"></a>2.1 XR500的WAN和LAN的划分</h2><p>在第1章说的是switch中WAN和LAN的划分，但其实Linux系统还不知道。默认情况下进行的是如下的设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth1 hw ether lanmac</span><br><span class="line">ifconfig eth0 hw ether wanmac</span><br><span class="line">ip link <span class="built_in">set</span> dev eth1 name ethlan</span><br><span class="line">ip link <span class="built_in">set</span> dev eth0 name ethwan</span><br><span class="line">brctl addif br0 ethlan</span><br><span class="line">ifconfig br0 hw ether lanmac</span><br><span class="line">brctrl addif brwan ethwan</span><br><span class="line">sw_configvlan <span class="string">&quot;normal&quot;</span></span><br></pre></td></tr></table></figure>

<p>第3,4行相当于一个改名操作，直接把eth1改名为ethlan,把eth0改名为ethwan。可以发现在这两条指令运行后找不到eth0和eth1了，因为它们已经被ethwan和ethlan替代了。</p>
<p>也就是说当没有vlan的时候ethwan就相当于eth0,  ethlan就相当于eth1。后续的net-wan和net-lan对只是对ethwan, ethlan或br0, brwan进行操作。</p>
<h2 id="2-2-Orbi中WAN和LAN的划分"><a href="#2-2-Orbi中WAN和LAN的划分" class="headerlink" title="2.2 Orbi中WAN和LAN的划分"></a>2.2 Orbi中WAN和LAN的划分</h2><p>对于Orbi中WAN口和LAN口的划分其实是分为两步，①edma在初始化的时候根据设备树中的信息来设置，哪些端口走eth0,哪些端口走eth1。②swconfig 配置WAN局域网和LAN局域网。</p>
<ol>
<li>根据1.2中qcom-ipq40xx.dtsi的设置，可以知道switch的端口1走eth0，端口2，3，4，5（Mini中没有端口5）走eth1.</li>
<li>根据1.2小节中swconfig dev switch0 show可以知道，switch中是将端口1作为一个局域网，端口2，3,4作为同一个局域网。再结合1，可以知道端口1为WAN局域网，端口2,3,4为LAN局域网。</li>
</ol>
<h1 id="3-VLAN"><a href="#3-VLAN" class="headerlink" title="3 VLAN"></a>3 VLAN</h1><h2 id="3-1-XR500-VLAN"><a href="#3-1-XR500-VLAN" class="headerlink" title="3.1 XR500 VLAN"></a>3.1 XR500 VLAN</h2><p>将XR500的VLAN设置成下所示(5Gwifi添加到VLAN 20)：</p>
<p><img src="/2021/09/25/rt-dev/vlan_gui_setting" alt="XR500_VLAN"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>VLAN ID</th>
<th>Ports</th>
</tr>
</thead>
<tbody><tr>
<td>Internet</td>
<td>10</td>
<td>1 3 4,  2.4g</td>
</tr>
<tr>
<td>test</td>
<td>20</td>
<td>2, 5g</td>
</tr>
</tbody></table>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>vid: 20<br>ports: 0t 2 5t 6t<br>VLAN 2:<br>vid: 10<br>ports: 0t 5t<br>VLAN 3:<br>vid: 1<br>ports: 1 3 4 6</p>
</blockquote>
<p>cat /tmp/sw.conf</p>
<blockquote>
<p>root@XR500:/# cat /tmp/sw.conf<br>config switch<br>option name ‘switch0’<br>option reset ‘1’<br>option enable_vlan ‘1’</p>
<p>config switch_vlan<br>option device ‘switch0’<br>option vlan ‘1’<br>option vid ‘20’<br>option ports ‘0t 5t 6t 2’</p>
<p>config switch_vlan<br>option device ‘switch0’<br>option vlan ‘2’<br>option vid ‘10’<br>option ports ‘0t 5t’</p>
<p>config switch_vlan<br>option device ‘switch0’<br>option vlan ‘3’<br>option vid ‘1’<br>option ports ‘6 1 3 4’</p>
</blockquote>
<p>brctl show</p>
<blockquote>
<p>bridge name     bridge id               STP enabled     interfaces<br>br0             8000.8c3bad10a33a       no              ath1<br>                                                  ethlan<br>                                                  tap0<br>br20            8000.8c3bad10a33b       yes             ath0<br>                                                  eth0.20<br>                                                  ethlan.20<br>brwan           8000.8c3bad10a33b       no              ethwan</p>
</blockquote>
<ol>
<li><p>VLAN 1 vid : 20, ports: 0t, 2, 5t, 6t。</p>
<p>‘t’指网络包进来的时候，该包必须带20的tag，但进来后会被剥离，但出去的时候又会重新打上该tag。也就是 0，5，6进来前或出去后的包都必须带tag。这也就是brctl show中显示的eth0.20(5), ethlan.20(6)。这里的ethlan其实就是eth1, 但ethwan并不等于eth0。switch内部已经将0.20， 2， 5.20， 6.20配置成一个局域网了。5.20 即为 eth0.20, 而6.20等于ethlan.20(但在此之前需要执行“ip link set dev eth1 name ethlan”).</p>
<p>这里WAN口连接的网络数据要携带VID 20的tag，某个设备连接到路由器LAN口的Port3(对应的应该是switch port2),数据可以不需要携带任何tag。这种情况下LAN端设备和WAN连接的网络可以正常通信。在switch中，数据可能是直接从端口5（进入前和进入后带tag20）到端口2（进入前和出去后不带tag）,不会经过switch端口0和端口6.</p>
<p>而对于WIFI 5G（ath0）无论是与WAN口还是与Port3(对应的应该是switch port2)通信则不会在switch中进行交换数据。从brctrl show中可以看出ath0是与ethlan.20和eth0.20配置在同一网桥，那么WAN口或Port3(对应的应该是switch port2)要与ath0通信则要经过switch端口0和端口6。</p>
</li>
<li><p>VLAN 2 vid: 10, ports: 0t, 5t</p>
<p>switch将0.10和5.10配置成同一个局域网，但可以看到在brctl show中没有eth0.10之类的。是因为Internet VLAN执行的是“ip link set dev eth0.10 name ethwan”, 也就是将eth0.10作为ethwan。目前switch的0端口作为WAN口的物理接口，只有带tag 10的包进来它才能显示为“有网”。</p>
</li>
<li><p>VLAN 3 vid: 1 ports: 1 3 4 6</p>
<p>LAN端的设置，和默认一样。</p>
</li>
</ol>
<h2 id="3-2-ORBI-VLAN"><a href="#3-2-ORBI-VLAN" class="headerlink" title="3.2 ORBI VLAN"></a>3.2 ORBI VLAN</h2><p>Orbi中除了VLAN mode都是使用swconfig配置的。对于vlan mode，是使用ssdk.sh。</p>
<ol>
<li>VLAN的配置如下</li>
</ol>
<p><img src="/2021/09/25/rt-dev/mini_vlan_config" alt="mini_vlan_config"></p>
<ol start="2">
<li>vlan实际的设置</li>
</ol>
<blockquote>
<p>root@RBR40:/# cat /tmp/ssdk.sh<br>/usr/sbin/ssdk_sh vlan entry flush<br>/usr/sbin/ssdk_sh vlan entry create 20<br>/usr/sbin/ssdk_sh vlan entry append 20 20 0,1 0,1 null null no no<br>/usr/sbin/ssdk_sh vlan entry create 4075<br>/usr/sbin/ssdk_sh vlan member add 4075 0 tagged<br>/usr/sbin/ssdk_sh vlan member add 4075 2 untagged<br>/usr/sbin/ssdk_sh portvlan defaultcvid set 2 4075<br>/usr/sbin/ssdk_sh qos ptDefaultCpri set 2 0<br>/usr/sbin/ssdk_sh vlan entry create 1<br>/usr/sbin/ssdk_sh vlan member add 1 0 tagged<br>/usr/sbin/ssdk_sh vlan member add 1 3 untagged<br>/usr/sbin/ssdk_sh vlan member add 1 4 untagged<br>/usr/sbin/ssdk_sh portvlan defaultcvid set 3 1<br>/usr/sbin/ssdk_sh portvlan defaultcvid set 4 1<br>/usr/sbin/ssdk_sh qos ptDefaultCpri set 3 0<br>/usr/sbin/ssdk_sh qos ptDefaultCpri set 4 0<br>/usr/sbin/ssdk_sh vlan entry create 10<br>/usr/sbin/ssdk_sh vlan entry append 10 10 0,1 0,1 null null no no<br>/usr/sbin/ssdk_sh misc cpuvid set enable</p>
</blockquote>
<blockquote>
<p>root@RBR40:/# brctl show<br>bridge name     bridge id               STP enabled     interfaces<br>br0             8000.201407112a30       no              ath0<br>                                               ath01<br>                                               ath02<br>                                               ath1<br>                                               ath2<br>                                               ath21<br>                                               eth1<br>br20            8000.201407112a31       yes             eth0.20<br>                                               eth1.4075<br>brwan           8000.8c3bad193029       no              eth0.10</p>
</blockquote>
<blockquote>
<p>#flush all VLAN entries</p>
<p>/usr/sbin/ssdk_sh vlan entry flush</p>
<p>#create a VLAN entry 20</p>
<p>/usr/sbin/ssdk_sh vlan entry create 20</p>
<p>#append a VLAN entry</p>
<p>/usr/sbin/ssdk_sh vlan entry append 20 20 0,1 0,1 null null no no</p>
<p>#create a VLAN entry 4075</p>
<p>/usr/sbin/ssdk_sh vlan entry create 4075</p>
<p>#add member 0 to entry 4075 with tag</p>
<p>/usr/sbin/ssdk_sh vlan member add 4075 0 tagged</p>
<p>#add member 2 to entry 4075 to entry 4075 without tag</p>
<p>/usr/sbin/ssdk_sh vlan member add 4075 2 untagged</p>
<p>#set default VLAN id 4075 of port 2</p>
<p>/usr/sbin/ssdk_sh portvlan defaultcvid set 2 4075</p>
<p>#set default ctag priority for received frames of a port “<port_id> <a href="cpri:0-7">cpri:0-7</a>“</port_id></p>
<p>/usr/sbin/ssdk_sh qos ptDefaultCpri set 2 0</p>
<p>#create vlan entry 1</p>
<p>/usr/sbin/ssdk_sh vlan entry create 1</p>
<p>#add vlan member 0, 3, 4 to vlan entry 1</p>
<p>/usr/sbin/ssdk_sh vlan member add 1 0 tagged<br>/usr/sbin/ssdk_sh vlan member add 1 3 untagged<br>/usr/sbin/ssdk_sh vlan member add 1 4 untagged</p>
<p>#set default VLAN id 1 of port 3 and port 4</p>
<p>/usr/sbin/ssdk_sh portvlan defaultcvid set 3 1<br>/usr/sbin/ssdk_sh portvlan defaultcvid set 4 1</p>
<p>#set default 0 priority for received frames of port 3 and port 4</p>
<p>/usr/sbin/ssdk_sh qos ptDefaultCpri set 3 0<br>/usr/sbin/ssdk_sh qos ptDefaultCpri set 4 0</p>
<p>#create vlan entry 10</p>
<p>/usr/sbin/ssdk_sh vlan entry create 10</p>
<p>#append a vlan entry</p>
<p>/usr/sbin/ssdk_sh vlan entry append 10 10 0,1 0,1 null null no no</p>
<p>#set to cpu vid status &lt;enable|disable&gt;</p>
<p>/usr/sbin/ssdk_sh misc cpuvid set enable</p>
</blockquote>
<p>对于用ssdk_sh配置switch的命令的流程：</p>
<ol>
<li>清空vlan entry。</li>
<li>创建一个vlan entry即vlan ID。</li>
<li>附加vlan entry,基本上是添加带tag的端口和设置该entry的一些功能。一般执行了这一步就不用执行第4步。</li>
<li>为vlan entry添加它的成员端口，可以带tag也可以不带。</li>
<li>对于不带tag的端口需要设置进来的包打上默认的tag。</li>
<li>对于不带tag的端口还需要设置qos优先级。</li>
<li>最后设置cpu vid状态使能。</li>
</ol>
<p>由于没有指令手册，关于一些指令的功能其实可以通过测试来了解。比如vlan 10在vlan append指令执行后为什么没有执行</p>
<p>/usr/sbin/ssdk_sh vlan member add 10 0 tagged</p>
<p>/usr/sbin/ssdk_sh vlan member add 10 1 tagged</p>
<p>可以一条条指令的执行，然后调用ssdk_sh vlan entry show,可以知道端口0和端口1的已被添加到vlan 10的tagged member中了。</p>
<blockquote>
<p>10    [fid]:10     [member]:0x3<br>[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
</blockquote>
<p>因为是一个端口与CPU通信所以这里在设置vlan 20的时候并不是将switch中的LAN所对应的端口打上tag20,而是打上（4095-20）。这样做可以使eth0对应的vlan端口和eth1中对应的vlan端口必须通过CPU来通信，而不是都配置成tag20的时候可以直接通过switch来进行通信。通过CPU来交换vlan可能会降低速度，当初这么设计可能是可以用通过防火墙来统一控制端口。</p>
<p>从vlan配置的脚本中可以看到之前是通过swconfig命令来设置，从/tmp/sw.conf中也可以看到，至于为什么会换成ssdk_sh来设置，现在也不得而知。</p>
<blockquote>
<p>root@RBR40:/# cat /tmp/sw.conf<br>config switch<br>  option name ‘switch0’<br>  option reset ‘1’<br>  option enable_vlan ‘1’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘1’<br>  option vid ‘20’<br>  option ports ‘0t 1t’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘2’<br>  option vid ‘4075’<br>  option ports ‘0t 2’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘3’<br>  option vid ‘1’<br>  option ports ‘0t 3 4’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘4’<br>  option vid ‘10’<br>  option ports ‘0t 1t’</p>
</blockquote>
<ol start="3">
<li>vlan端口状态显示</li>
</ol>
<blockquote>
<p>root@RBR40:/# ssdk_sh vlan entry show</p>
<p>SSDK Init OK!<br>[vid]:1     [fid]:1      [member]:0x19<br>[tagged_member]:0x1     [untagged_member]:0x18    [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:10    [fid]:10     [member]:0x3<br>[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:20    [fid]:20     [member]:0x3<br>[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:4075  [fid]:4075   [member]:0x5<br>[tagged_member]:0x1     [untagged_member]:0x4     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>total 4 entries</p>
<p>operate done.</p>
</blockquote>
<p>swconfig dev switch0 show</p>
<blockquote>
<pre><code>    vid: 1
    ports: 0 2 3 4
    VLAN 2:
    vid: 2

    

    ​        ports: 0 1
</code></pre>
</blockquote>
<p>可以看到这里的swconfig dev switch0 show并不准确，它所显示的是上一次也就是normal情况下使用swconfig dev switch0 /tmp/sw.conf的信息。但ssdk_sh显示的信息是正确的，关于swconfig和ssdk_sh的区别可以看第5章。</p>
<h1 id="4-改变WAN口"><a href="#4-改变WAN口" class="headerlink" title="4 改变WAN口"></a>4 改变WAN口</h1><h2 id="4-1-XR500改变WAN口"><a href="#4-1-XR500改变WAN口" class="headerlink" title="4.1 XR500改变WAN口"></a>4.1 XR500改变WAN口</h2><p>路由器为了方便用户操作将WAN口设置为固定的，其实对于WAN口和LAN口在同一个switch中，WAN口是可以改变。甚至可以有多个WAN口，当然这样可能会带来其它的问题（可能会有多个dhcp server）。</p>
<p>先看默认情况下的switch：</p>
<blockquote>
<p>VLAN 1:<br>vid: 1<br>ports: 1 2 3 4 6<br>VLAN 2:<br>vid: 2<br>ports: 0 5</p>
</blockquote>
<p>物理WAN网线直接连接的是端口5，它其实是与端口0在同一个网桥或局域网，也就是可以把0口作为WAN口。但端口0我们并看不到，但它是与Linux系统端的eth0相连的, 因此又可以把eth0作为WAN口。而默认情况下又通过“ip link set dev eth0 name ethwan”, 将eth0改名为ethwan，然后再用brctl addif brwan ethwan将ethwan添加到brwan网桥中，那么最终可以将brwan视作WAN口。</p>
<p>目标：将端口2（路由器壳上标记的端口3）作为WAN口，其它的作为LAN</p>
<p>那switch的显示应该是这样的</p>
<blockquote>
<p>VLAN 1:<br>vid: 1<br>ports: 1 3 4 5 6<br>VLAN 2:<br>vid: 2<br>ports: 0 2</p>
</blockquote>
<p>只需将/tmp/sw.conf中的port 2和 port 5对换即可</p>
<blockquote>
<p>config switch<br>  option name ‘switch0’<br>  option reset ‘1’<br>  option enable_vlan ‘1’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘1’<br>  option vid ‘1’<br>  option ports ‘6 1 3 4 5’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘2’<br>  option vid ‘2’<br>  option ports ‘0 2’</p>
</blockquote>
<p>然后运行swconfig dev switch0 load /tmp/sw.conf就可以了。</p>
<blockquote>
<p>dess vlan member update</p>
</blockquote>
<p>也会调用到dess vlan member update</p>
<blockquote>
<p> ssdk_sh vlan entry show</p>
<p> SSDK Init OK!switch_ioctl<br> sw_uk_exec shell<br> sw_uk_if shell<br> switch_ioctl<br> sw_uk_exec shell<br> sw_uk_if shell<br> switch_ioctl</p>
</blockquote>
<p>对于mini改变WAN口并不方便，但可以通过改变设备树中eth0(gmac0)和eth1(gmac1)的vlan_tag来换WAN口。</p>
<h2 id="4-2-Orbi改变WAN口"><a href="#4-2-Orbi改变WAN口" class="headerlink" title="4.2 Orbi改变WAN口"></a>4.2 Orbi改变WAN口</h2><p>根据2.2节Orbi中WAN/LAN的划分，可以设置如下：</p>
<p>目标将端口4设置为WAN口，端口1，2，3 为LAN口</p>
<ol>
<li><p>eth0和eth1初始化端口</p>
<p>端口4-&gt;00010000-&gt;0x10</p>
<p>端口1,2,3(,5)-&gt;00101110-&gt;0x2e </p>
<p><img src="/2021/09/25/rt-dev/change_wan_dts" alt="mini_change_wan_dts"></p>
<p>这样端口4会走eth0,端口1,2,3会走eth1</p>
</li>
<li><p>swconfig dev load /tmp/sw.conf</p>
<p>swconfig需要将端口1,2,3配置成一个局域网，端口4配置成一个局域网。</p>
<blockquote>
<p>root@RBR40:/# cat /tmp/sw.conf<br>config switch<br>  option name ‘switch0’<br>  option reset ‘1’<br>  option enable_vlan ‘1’</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘1’<br>  option vid ‘1’<br>  option ports ‘0 1 2 3 ‘</p>
<p>config switch_vlan<br>  option device ‘switch0’<br>  option vlan ‘2’<br>  option vid ‘2’<br>  option ports ‘0 4’</p>
</blockquote>
</li>
</ol>
<p>通过上面两步就可以实现端口4和端口1的功能互换，端口4作为WAN口。</p>
<h1 id="5-用户与switch交互过程"><a href="#5-用户与switch交互过程" class="headerlink" title="5 用户与switch交互过程"></a>5 用户与switch交互过程</h1><p>XR500和mini与switch交换的过程有两种：swconfig和ssdk_sh。swconfig通过netlink直接与内核通信来操作switch，而ssdk_sh通过打开/dev/switch_ssdk来对switch进行操作。其实这两个命令最终调用的最底层函数都是一样的即dess_xxx.c(dess_vlan.c, dess_portvlan.c …)。</p>
<h2 id="5-1-swconfig"><a href="#5-1-swconfig" class="headerlink" title="5.1 swconfig"></a>5.1 swconfig</h2><p>以下是swconfig的主要执行过程。</p>
<p>文件路径：</p>
<p>​    swconfig module: package/network/config/swconfig</p>
<p>​    swconfig.c: linux内核code/drivers/net/phy/</p>
<p>​    qca-nss-ssdk: fal, rel, dess</p>
<p><img src="/2021/09/25/rt-dev/rt-dev%5Cswconfig_flow.png" alt="ssdk_flow"></p>
<p>无论是XR500中关于swconfig命令都是swconfig模块实现的。我们主要用到的是“swconfig dev switch0 show”和“swconfig dev switch0 load /tmp/sw.conf”.</p>
<ol>
<li><p>swconfig dev switch0 load /tmp/sw.conf</p>
<ol>
<li>swconfig 通过uci来解析/tmp/sw.conf,然后依次对每一个config通过netlink与内核通信来设置switch。通过上图可以知道netlink中调用到的是swconfig_set_vlan_ports,而这个函数会调用到qca_ar8327_sw_hw_set_ports。qca_ar8327_sw_hw_set_ports这个函数只会对qca_phy_priv结构体中的几个数组进行修改。到这里，并不会修改switch。</li>
<li>在所有的config都设置完成后，swconfig模块会调用一个apply动作并传递给内核来把qca_phy_priv这个结构体传递给switch。也就是上图调用到fal_vlan,上图中的fal只是一组接口函数，真正对寄存器操作的函数是在dess中进行的。</li>
</ol>
</li>
<li><p>swconfig dev switch0 show</p>
<p>show命令的调用过程如上图，它最终获取的只是qca_phy_priv中的数据，它并不是获取的switch端口的信息。也就是说，它获取的只是上次swconfig命令对switch设置的信息。如果调用其它的命令对switch进行设置，那么swconfig show命令就不准确了。</p>
</li>
</ol>
<h2 id="5-2-ssdk-sh"><a href="#5-2-ssdk-sh" class="headerlink" title="5.2 ssdk_sh"></a>5.2 ssdk_sh</h2><p><img src="/2021/09/25/rt-dev/ssdk_flow.png" alt="ssdk_flow"></p>
<p>ssdk_sh是在qca-ssdk-shell_dni，不带参数直接运行ssdk_sh会进入用户交互状态。这里主要介绍的是”ssdk_sh vlan”。</p>
<p>在ssdk_sh的主程序shell.c中首先调用的是cmd_init，这个函数主要是打开“/dev/switch_ssdk”模块并返回文件描述符。接着cmd_args会被调用，cmd_args首先调用cmd_parse通过传入的命令参数在CONFIG VLAN TABLE中查找改命令所对应的API id并返回。cmd_exec通过获取到的api id来执行fal_vlan中所对应的函数。需要注意的是这里的fal_vlan和swconfig命令所调用的不同，这里的fal_vlan中的函数大多都是包裹函数都要执行sw_uk_exec。 sw_uk_exec通过ioctl函数与之前在cmd_init中打开的switch_ssdk模块进行通信。ioctl对应的于switch_ssdk中的函数其实是switch_ioctl. switch_ioctl最终会调用到dess_vlan中对应的函数。这里调用的dess_vlan和之前swconfig命令所调用的就是一样的了。</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h1><p>虽然VLAN的脚本好像有很多，但其实知道怎么配置switch和brctl就可以了。因为脚本中最终也是来配置/tmp/sw.conf和bridge。</p>
<p>swconfig和ssdk_sh虽然操作指令不同，最终操作switch的函数是一样的。</p>
<h6 id><a href="#" class="headerlink" title></a></h6>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/2021/05/21/password-test_cp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/21/password-test_cp/" itemprop="url">password_test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-21T15:01:43+08:00">
                2021-05-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/21/password-test_cp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/21/password-test_cp/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          密码：123456
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/05/21/password-test_cp/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/2021/05/21/password-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/21/password-test/" itemprop="url">password_test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-21T15:01:43+08:00">
                2021-05-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/21/password-test/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/21/password-test/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          密码：123456
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/05/21/password-test/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/2021/05/19/vlan-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/19/vlan-structure/" itemprop="url">路由器中的VLAN</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-19T15:22:31+08:00">
                2021-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/openwrt/" itemprop="url" rel="index">
                    <span itemprop="name">openwrt</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/19/vlan-structure/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/19/vlan-structure/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div align="center"><font size="70">VLAN STRUCTURE</font></div>
<div align="center"><font size="5">Yuanshuai.Gong</font></div>
<div style="page-break-after:always;"></div>

<p>[TOC]</p>
<h1 id="路由器中的连接结构"><a href="#路由器中的连接结构" class="headerlink" title="路由器中的连接结构"></a>路由器中的连接结构</h1><p>对于像XR500中的只有一个switch, CPU与switch的连接示意图如下所示：</p>
<p><img src="/2021/05/19/vlan-structure/switch_to_cpu_structure_xr500.png" alt="switch2cpu"></p>
<p>在console中输入“swconfig dev switch0 dev show”, 可以看到</p>
<blockquote>
<p>VLAN 1:<br>     vid: 1<br>     ports: 1 2 3 4 6<br>VLAN 2:<br>     vid: 2<br>     ports: 0 5</p>
</blockquote>
<p>拿到一个路由器，可以看到它有5个端口，这5个端口从WAN口开始在switch中分别由‘5’，‘4’，‘3’，‘2’，‘1’代表。其实它还有两个端口，这两个端口连接Linux系统的eth0和eth1.</p>
<p>switch除开VLAN功能外，只是一个具有记忆功能的HUB。也就是说在XR500等路由器启动后，不对switch进行配置，它是不分WAN和LAN的，它都是在同一个局域网内。</p>
<p>上面的VLAN1和VLAN2是对WAN和LAN的划分。vlan 1, 顾名思义，是将1 2 3 4 6划分在同一个局域网，而vlan 2 是将端口 0 和 5划分到一个局域网。需要注意的是，这里的数字后没有带t, 也就是不带tag。对于没有带tag的端口它只能划分到一个局域网中，而不是像带tag时的端口可以根据tag的vid来处于不同的局域网。例如：</p>
<blockquote>
<p>VLAN 1:<br>     vid: 1<br>     ports: 1 2 3 4 6<br>VLAN 2:<br>     vid: 2<br>     ports: 0 1 5</p>
</blockquote>
<p>上面将端口1（实际上是路由器上标识的端口4）同时设置带VLAN 1和VLAN 2。测试会发现端口1只能拿到VLAN 2中dhcp分配的IP 地址，即使WAN没有任何dhcp server, 端口1也不会从LAN端获取IP地址。因为swconfig是一个个VLAN进行配置的，也就是之前有把1划分到VLAN 1，但接着又把2划分到VLAN 2。</p>
<h1 id="WAN和LAN的划分"><a href="#WAN和LAN的划分" class="headerlink" title="WAN和LAN的划分"></a>WAN和LAN的划分</h1><p>在第1章说的是switch中WAN和LAN的划分，但其实Linux系统还不知道。默认情况下进行的是如下的设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth1 hw ether lanmac</span><br><span class="line">ifconfig eth0 hw ether wanmac</span><br><span class="line">ip link set dev eth1 name ethlan</span><br><span class="line">ip link set dev eth0 name ethwan</span><br><span class="line">brctl addif br0 ethlan</span><br><span class="line">ifconfig br0 hw ether lanmac</span><br><span class="line">brctrl addif brwan ethwan</span><br><span class="line">sw_configvlan &quot;normal&quot;</span><br></pre></td></tr></table></figure>

<p>第3,4行相当于一个改名操作，直接把eth1改名为ethlan,把eth0改名为ethwan。可以发现在这两条指令运行后找不到eth0和eth1了，因为它们已经被ethwan和ethlan替代了。</p>
<p>也就是说当没有vlan的时候ethwan就相当于eth0,  ethlan就相当于eth1。后续的net-wan和net-lan对只是对ethwan, ethlan或br0, brwan进行操作。</p>
<h1 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h1><p>将XR500的VLAN设置成下所示：</p>
<p><img src="/2021/05/19/vlan-structure/vlan_gui_setting" alt="image-20210520140648459"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>VLAN ID</th>
<th>Ports</th>
</tr>
</thead>
<tbody><tr>
<td>Internet</td>
<td>10</td>
<td>1 3 4,  2.4g</td>
</tr>
<tr>
<td>test</td>
<td>20</td>
<td>2, 5g</td>
</tr>
</tbody></table>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>     vid: 20<br>     ports: 0t 2 5t 6t<br>VLAN 2:<br>     vid: 10<br>     ports: 0t 5t<br>VLAN 3:<br>     vid: 1<br>     ports: 1 3 4 6</p>
</blockquote>
<p>cat /tmp/sw.conf</p>
<blockquote>
<p>root@XR500:/# cat /tmp/sw.conf<br>config switch<br>     option name ‘switch0’<br>     option reset ‘1’<br>     option enable_vlan ‘1’</p>
<p>config switch_vlan<br>     option device ‘switch0’<br>     option vlan ‘1’<br>     option vid ‘20’<br>     option ports ‘0t 5t 6t 2’</p>
<p>config switch_vlan<br>     option device ‘switch0’<br>     option vlan ‘2’<br>     option vid ‘10’<br>     option ports ‘0t 5t’</p>
<p>config switch_vlan<br>     option device ‘switch0’<br>     option vlan ‘3’<br>     option vid ‘1’<br>     option ports ‘6 1 3 4’</p>
</blockquote>
<p>brctl show</p>
<blockquote>
<p>bridge name     bridge id               STP enabled     interfaces<br>br0             8000.8c3bad10a33a       no              ath1<br>                                                        ethlan<br>                                                        tap0<br>br20            8000.8c3bad10a33b       yes             ath0<br>                                                        eth0.20<br>                                                        ethlan.20<br>brwan           8000.8c3bad10a33b       no              ethwan</p>
</blockquote>
<ol>
<li><p>VLAN 1 vid : 20, ports: 0t, 2 5t, 6t。</p>
<p>‘t’指网络包进来的时候，该包必须带20的tag，但进来后会被剥离，但出去的时候又会重新打上该tag。也就是 0，5，6进来前或出去后的包都必须带tag。这也就是brctl show中显示的eth0.20(5), ethlan.20(6)。这里的ethlan其实就是eth1, 但ethwan并不等于eth0。switch内部已经将0.20， 2， 5.20， 6.20配置成一个局域网了。5.20 即为 eth0.20, 而6.20等于ethlan.20(但在此之前需要执行“ip link set dev eth1 name ethlan”).</p>
</li>
<li><p>VLAN 2 vid: 10, ports: 0t, 5t</p>
<p>switch将0.10和5.10配置成同一个局域网，但可以看到在brctl show中没有eth0.10之类的。是因为Internet VLAN执行的是“ip link set dev eth0.10 name ethwan”, 也就是将eth0.10作为ethwan。目前switch的0端口作为WAN口的物理接口，只有带tag 10的包进来它才能显示为“有网”。</p>
</li>
<li><p>VLAN 3 vid: 1 ports: 1 3 4 6</p>
<p>LAN端的设置，和默认一样。</p>
</li>
</ol>
<h1 id="改变WAN口"><a href="#改变WAN口" class="headerlink" title="改变WAN口"></a>改变WAN口</h1><p>路由器为了方便用户操作将WAN口设置为固定的，其实对于WAN口和LAN口在同一个switch中，WAN口是可以改变。甚至可以有多个WAN口，当然这样可能会带来其它的问题（可能会有多个dhcp server）。</p>
<p>先看默认情况下的switch：</p>
<blockquote>
<p>VLAN 1:<br>     vid: 1<br>     ports: 1 2 3 4 6<br>VLAN 2:<br>     vid: 2<br>     ports: 0 5</p>
</blockquote>
<p>物理WAN网线直接连接的是端口5，它其实是与端口0在同一个网桥或局域网，也就是可以把0口作为WAN口。但端口0我们并看不到，但它是与Linux系统端的eth0相连的, 因此又可以把eth0作为WAN口。而默认情况下又通过“ip link set dev eth0 name ethwan”, 将eth0改名为ethwan，然后再用brctl addif brwan ethwan将ethwan添加到brwan网桥中，那么最终可以将brwan视作WAN口。</p>
<p>目标：将端口2（路由器壳上标记的端口3）作为WAN口，其它的作为LAN</p>
<p>那switch的显示应该是这样的</p>
<blockquote>
<p>VLAN 1:<br>     vid: 1<br>     ports: 1 3 4 5 6<br>VLAN 2:<br>     vid: 2<br>     ports: 0 2</p>
</blockquote>
<p>只需将/tmp/sw.conf中的port 2和 port 5对换即可</p>
<blockquote>
<p>config switch<br>        option name ‘switch0’<br>        option reset ‘1’<br>        option enable_vlan ‘1’</p>
<p>config switch_vlan<br>        option device ‘switch0’<br>        option vlan ‘1’<br>        option vid ‘1’<br>        option ports ‘6 1 3 4 5’</p>
<p>config switch_vlan<br>        option device ‘switch0’<br>        option vlan ‘2’<br>        option vid ‘2’<br>        option ports ‘0 2’</p>
</blockquote>
<p>然后运行swconfig dev switch0 load /tmp/sw.conf就可以了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽然VLAN的脚本好像有很多，但其实知道怎么配置switch和brctl就可以了。因为脚本中最终也是来配置/tmp/sw.conf和bridge。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/1970/01/01/vlan-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/1970/01/01/vlan-structure/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="1970-01-01T08:00:00+08:00">
                1970-01-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/1970/01/01/vlan-structure/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/1970/01/01/vlan-structure/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!DOCTYPE html><html><head>
      <title>&#x8DEF;&#x7531;&#x5668;&#x4E2D;&#x7684;VLAN</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div align="center"><font size="70">VLAN STRUCTURE</font></div>
<div align="center"><font size="5">Yuanshuai.Gong</font></div>
<div style="page-break-after:always;"></div>
<ul>
<li><a href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E7%BB%93%E6%9E%84">&#x8DEF;&#x7531;&#x5668;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;</a></li>
<li><a href="#wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</a></li>
<li><a href="#vlan">VLAN</a></li>
<li><a href="#%E6%94%B9%E5%8F%98wan%E5%8F%A3">&#x6539;&#x53D8;WAN&#x53E3;</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">&#x603B;&#x7ED3;</a></li>
</ul>
<h1 class="mume-header" id="%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E7%BB%93%E6%9E%84">&#x8DEF;&#x7531;&#x5668;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;</h1>

<p>&#x5BF9;&#x4E8E;&#x50CF;XR500&#x4E2D;&#x7684;&#x53EA;&#x6709;&#x4E00;&#x4E2A;switch, CPU&#x4E0E;switch&#x7684;&#x8FDE;&#x63A5;&#x793A;&#x610F;&#x56FE;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="/1970/01/01/vlan-structure/switch_to_cpu_structure_xr500.png" alt="switch2cpu"></p>
<p>&#x5728;console&#x4E2D;&#x8F93;&#x5165;&#x201C;swconfig dev switch0 dev show&#x201D;, &#x53EF;&#x4EE5;&#x770B;&#x5230;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 5</p>
</blockquote>
<p>&#x62FF;&#x5230;&#x4E00;&#x4E2A;&#x8DEF;&#x7531;&#x5668;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B83;&#x6709;5&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x8FD9;5&#x4E2A;&#x7AEF;&#x53E3;&#x4ECE;WAN&#x53E3;&#x5F00;&#x59CB;&#x5728;switch&#x4E2D;&#x5206;&#x522B;&#x7531;&#x2018;5&#x2019;&#xFF0C;&#x2018;4&#x2019;&#xFF0C;&#x2018;3&#x2019;&#xFF0C;&#x2018;2&#x2019;&#xFF0C;&#x2018;1&#x2019;&#x4EE3;&#x8868;&#x3002;&#x5176;&#x5B9E;&#x5B83;&#x8FD8;&#x6709;&#x4E24;&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x7AEF;&#x53E3;&#x8FDE;&#x63A5;Linux&#x7CFB;&#x7EDF;&#x7684;eth0&#x548C;eth1.</p>
<p>switch&#x9664;&#x5F00;VLAN&#x529F;&#x80FD;&#x5916;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5177;&#x6709;&#x8BB0;&#x5FC6;&#x529F;&#x80FD;&#x7684;HUB&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5728;XR500&#x7B49;&#x8DEF;&#x7531;&#x5668;&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x4E0D;&#x5BF9;switch&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x5B83;&#x662F;&#x4E0D;&#x5206;WAN&#x548C;LAN&#x7684;&#xFF0C;&#x5B83;&#x90FD;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x5185;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x7684;VLAN1&#x548C;VLAN2&#x662F;&#x5BF9;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;&#x3002;vlan 1, &#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;&#x662F;&#x5C06;1 2 3 4 6&#x5212;&#x5206;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x800C;vlan 2 &#x662F;&#x5C06;&#x7AEF;&#x53E3; 0 &#x548C; 5&#x5212;&#x5206;&#x5230;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x6570;&#x5B57;&#x540E;&#x6CA1;&#x6709;&#x5E26;t, &#x4E5F;&#x5C31;&#x662F;&#x4E0D;&#x5E26;tag&#x3002;&#x5BF9;&#x4E8E;&#x6CA1;&#x6709;&#x5E26;tag&#x7684;&#x7AEF;&#x53E3;&#x5B83;&#x53EA;&#x80FD;&#x5212;&#x5206;&#x5230;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x4E2D;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x50CF;&#x5E26;tag&#x65F6;&#x7684;&#x7AEF;&#x53E3;&#x53EF;&#x4EE5;&#x6839;&#x636E;tag&#x7684;vid&#x6765;&#x5904;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x5C40;&#x57DF;&#x7F51;&#x3002;&#x4F8B;&#x5982;&#xFF1A;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 1 5</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x5C06;&#x7AEF;&#x53E3;1&#xFF08;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8DEF;&#x7531;&#x5668;&#x4E0A;&#x6807;&#x8BC6;&#x7684;&#x7AEF;&#x53E3;4&#xFF09;&#x540C;&#x65F6;&#x8BBE;&#x7F6E;&#x5E26;VLAN 1&#x548C;VLAN 2&#x3002;&#x6D4B;&#x8BD5;&#x4F1A;&#x53D1;&#x73B0;&#x7AEF;&#x53E3;1&#x53EA;&#x80FD;&#x62FF;&#x5230;VLAN 2&#x4E2D;dhcp&#x5206;&#x914D;&#x7684;IP &#x5730;&#x5740;&#xFF0C;&#x5373;&#x4F7F;WAN&#x6CA1;&#x6709;&#x4EFB;&#x4F55;dhcp server, &#x7AEF;&#x53E3;1&#x4E5F;&#x4E0D;&#x4F1A;&#x4ECE;LAN&#x7AEF;&#x83B7;&#x53D6;IP&#x5730;&#x5740;&#x3002;&#x56E0;&#x4E3A;swconfig&#x662F;&#x4E00;&#x4E2A;&#x4E2A;VLAN&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E4B;&#x524D;&#x6709;&#x628A;1&#x5212;&#x5206;&#x5230;VLAN 1&#xFF0C;&#x4F46;&#x63A5;&#x7740;&#x53C8;&#x628A;2&#x5212;&#x5206;&#x5230;VLAN 2&#x3002;</p>
<h1 class="mume-header" id="wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</h1>

<p>&#x5728;&#x7B2C;1&#x7AE0;&#x8BF4;&#x7684;&#x662F;switch&#x4E2D;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;&#xFF0C;&#x4F46;&#x5176;&#x5B9E;Linux&#x7CFB;&#x7EDF;&#x8FD8;&#x4E0D;&#x77E5;&#x9053;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x8FDB;&#x884C;&#x7684;&#x662F;&#x5982;&#x4E0B;&#x7684;&#x8BBE;&#x7F6E;</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">ifconfig</span> eth1 hw ether lanmac
<span class="token function">ifconfig</span> eth0 hw ether wanmac
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev eth1 name ethlan
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev eth0 name ethwan
brctl addif br0 ethlan
<span class="token function">ifconfig</span> br0 hw ether lanmac
brctrl addif brwan ethwan
sw_configvlan <span class="token string">&quot;normal&quot;</span>
</pre><p>&#x7B2C;3,4&#x884C;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x6539;&#x540D;&#x64CD;&#x4F5C;&#xFF0C;&#x76F4;&#x63A5;&#x628A;eth1&#x6539;&#x540D;&#x4E3A;ethlan,&#x628A;eth0&#x6539;&#x540D;&#x4E3A;ethwan&#x3002;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5728;&#x8FD9;&#x4E24;&#x6761;&#x6307;&#x4EE4;&#x8FD0;&#x884C;&#x540E;&#x627E;&#x4E0D;&#x5230;eth0&#x548C;eth1&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x5DF2;&#x7ECF;&#x88AB;ethwan&#x548C;ethlan&#x66FF;&#x4EE3;&#x4E86;&#x3002;</p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5F53;&#x6CA1;&#x6709;vlan&#x7684;&#x65F6;&#x5019;ethwan&#x5C31;&#x76F8;&#x5F53;&#x4E8E;eth0,  ethlan&#x5C31;&#x76F8;&#x5F53;&#x4E8E;eth1&#x3002;&#x540E;&#x7EED;&#x7684;net-wan&#x548C;net-lan&#x5BF9;&#x53EA;&#x662F;&#x5BF9;ethwan, ethlan&#x6216;br0, brwan&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;</p>
<h1 class="mume-header" id="vlan">VLAN</h1>

<p>&#x5C06;XR500&#x7684;VLAN&#x8BBE;&#x7F6E;&#x6210;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="/1970/01/01/vlan-structure/vlan_gui_setting" alt="image-20210520140648459"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>VLAN ID</th>
<th>Ports</th>
</tr>
</thead>
<tbody>
<tr>
<td>Internet</td>
<td>10</td>
<td>1 3 4,  2.4g</td>
</tr>
<tr>
<td>test</td>
<td>20</td>
<td>2, 5g</td>
</tr>
</tbody>
</table>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>
vid: 20<br>
ports: 0t 2 5t 6t<br>
VLAN 2:<br>
vid: 10<br>
ports: 0t 5t<br>
VLAN 3:<br>
vid: 1<br>
ports: 1 3 4 6</p>
</blockquote>
<p>cat /tmp/sw.conf</p>
<blockquote>
<p>root@XR500:/# cat /tmp/sw.conf<br>
config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;20&apos;<br>
option ports &apos;0t 5t 6t 2&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;10&apos;<br>
option ports &apos;0t 5t&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;3&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;6 1 3 4&apos;</p>
</blockquote>
<p>brctl show</p>
<blockquote>
<p>bridge name     bridge id               STP enabled     interfaces<br>
br0             8000.8c3bad10a33a       no              ath1<br>
ethlan<br>
tap0<br>
br20            8000.8c3bad10a33b       yes             ath0<br>
eth0.20<br>
ethlan.20<br>
brwan           8000.8c3bad10a33b       no              ethwan</p>
</blockquote>
<ol>
<li>
<p>VLAN 1 vid : 20, ports: 0t, 2 5t, 6t&#x3002;</p>
<p>&#x2018;t&#x2019;&#x6307;&#x7F51;&#x7EDC;&#x5305;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8BE5;&#x5305;&#x5FC5;&#x987B;&#x5E26;20&#x7684;tag&#xFF0C;&#x4F46;&#x8FDB;&#x6765;&#x540E;&#x4F1A;&#x88AB;&#x5265;&#x79BB;&#xFF0C;&#x4F46;&#x51FA;&#x53BB;&#x7684;&#x65F6;&#x5019;&#x53C8;&#x4F1A;&#x91CD;&#x65B0;&#x6253;&#x4E0A;&#x8BE5;tag&#x3002;&#x4E5F;&#x5C31;&#x662F; 0&#xFF0C;5&#xFF0C;6&#x8FDB;&#x6765;&#x524D;&#x6216;&#x51FA;&#x53BB;&#x540E;&#x7684;&#x5305;&#x90FD;&#x5FC5;&#x987B;&#x5E26;tag&#x3002;&#x8FD9;&#x4E5F;&#x5C31;&#x662F;brctl show&#x4E2D;&#x663E;&#x793A;&#x7684;eth0.20(5), ethlan.20(6)&#x3002;&#x8FD9;&#x91CC;&#x7684;ethlan&#x5176;&#x5B9E;&#x5C31;&#x662F;eth1, &#x4F46;ethwan&#x5E76;&#x4E0D;&#x7B49;&#x4E8E;eth0&#x3002;switch&#x5185;&#x90E8;&#x5DF2;&#x7ECF;&#x5C06;0.20&#xFF0C; 2&#xFF0C; 5.20&#xFF0C; 6.20&#x914D;&#x7F6E;&#x6210;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x4E86;&#x3002;5.20 &#x5373;&#x4E3A; eth0.20, &#x800C;6.20&#x7B49;&#x4E8E;ethlan.20(&#x4F46;&#x5728;&#x6B64;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x6267;&#x884C;&#x201C;ip link set dev eth1 name ethlan&#x201D;).</p>
</li>
<li>
<p>VLAN 2 vid: 10, ports: 0t, 5t</p>
<p>switch&#x5C06;0.10&#x548C;5.10&#x914D;&#x7F6E;&#x6210;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5728;brctl show&#x4E2D;&#x6CA1;&#x6709;eth0.10&#x4E4B;&#x7C7B;&#x7684;&#x3002;&#x662F;&#x56E0;&#x4E3A;Internet VLAN&#x6267;&#x884C;&#x7684;&#x662F;&#x201C;ip link set dev eth0.10 name ethwan&#x201D;, &#x4E5F;&#x5C31;&#x662F;&#x5C06;eth0.10&#x4F5C;&#x4E3A;ethwan&#x3002;&#x76EE;&#x524D;switch&#x7684;0&#x7AEF;&#x53E3;&#x4F5C;&#x4E3A;WAN&#x53E3;&#x7684;&#x7269;&#x7406;&#x63A5;&#x53E3;&#xFF0C;&#x53EA;&#x6709;&#x5E26;tag 10&#x7684;&#x5305;&#x8FDB;&#x6765;&#x5B83;&#x624D;&#x80FD;&#x663E;&#x793A;&#x4E3A;&#x201C;&#x6709;&#x7F51;&#x201D;&#x3002;</p>
</li>
<li>
<p>VLAN 3 vid: 1 ports: 1 3 4 6</p>
<p>LAN&#x7AEF;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x548C;&#x9ED8;&#x8BA4;&#x4E00;&#x6837;&#x3002;</p>
</li>
</ol>
<h1 class="mume-header" id="%E6%94%B9%E5%8F%98wan%E5%8F%A3">&#x6539;&#x53D8;WAN&#x53E3;</h1>

<p>&#x8DEF;&#x7531;&#x5668;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5C06;WAN&#x53E3;&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x5BF9;&#x4E8E;WAN&#x53E3;&#x548C;LAN&#x53E3;&#x5728;&#x540C;&#x4E00;&#x4E2A;switch&#x4E2D;&#xFF0C;WAN&#x53E3;&#x662F;&#x53EF;&#x4EE5;&#x6539;&#x53D8;&#x3002;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;WAN&#x53E3;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x6837;&#x53EF;&#x80FD;&#x4F1A;&#x5E26;&#x6765;&#x5176;&#x5B83;&#x7684;&#x95EE;&#x9898;&#xFF08;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x591A;&#x4E2A;dhcp server&#xFF09;&#x3002;</p>
<p>&#x5148;&#x770B;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7684;switch&#xFF1A;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 5</p>
</blockquote>
<p>&#x7269;&#x7406;WAN&#x7F51;&#x7EBF;&#x76F4;&#x63A5;&#x8FDE;&#x63A5;&#x7684;&#x662F;&#x7AEF;&#x53E3;5&#xFF0C;&#x5B83;&#x5176;&#x5B9E;&#x662F;&#x4E0E;&#x7AEF;&#x53E3;0&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7F51;&#x6865;&#x6216;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x53EF;&#x4EE5;&#x628A;0&#x53E3;&#x4F5C;&#x4E3A;WAN&#x53E3;&#x3002;&#x4F46;&#x7AEF;&#x53E3;0&#x6211;&#x4EEC;&#x5E76;&#x770B;&#x4E0D;&#x5230;&#xFF0C;&#x4F46;&#x5B83;&#x662F;&#x4E0E;Linux&#x7CFB;&#x7EDF;&#x7AEF;&#x7684;eth0&#x76F8;&#x8FDE;&#x7684;, &#x56E0;&#x6B64;&#x53C8;&#x53EF;&#x4EE5;&#x628A;eth0&#x4F5C;&#x4E3A;WAN&#x53E3;&#x3002;&#x800C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x53C8;&#x901A;&#x8FC7;&#x201C;ip link set dev eth0 name ethwan&#x201D;, &#x5C06;eth0&#x6539;&#x540D;&#x4E3A;ethwan&#xFF0C;&#x7136;&#x540E;&#x518D;&#x7528;brctl addif brwan ethwan&#x5C06;ethwan&#x6DFB;&#x52A0;&#x5230;brwan&#x7F51;&#x6865;&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x6700;&#x7EC8;&#x53EF;&#x4EE5;&#x5C06;brwan&#x89C6;&#x4F5C;WAN&#x53E3;&#x3002;</p>
<p>&#x76EE;&#x6807;&#xFF1A;&#x5C06;&#x7AEF;&#x53E3;2&#xFF08;&#x8DEF;&#x7531;&#x5668;&#x58F3;&#x4E0A;&#x6807;&#x8BB0;&#x7684;&#x7AEF;&#x53E3;3&#xFF09;&#x4F5C;&#x4E3A;WAN&#x53E3;&#xFF0C;&#x5176;&#x5B83;&#x7684;&#x4F5C;&#x4E3A;LAN</p>
<p>&#x90A3;switch&#x7684;&#x663E;&#x793A;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 3 4 5 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 2</p>
</blockquote>
<p>&#x53EA;&#x9700;&#x5C06;/tmp/sw.conf&#x4E2D;&#x7684;port 2&#x548C; port 5&#x5BF9;&#x6362;&#x5373;&#x53EF;</p>
<blockquote>
<p>config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;6 1 3 4 5&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;2&apos;<br>
option ports &apos;0 2&apos;</p>
</blockquote>
<p>&#x7136;&#x540E;&#x8FD0;&#x884C;swconfig dev switch0 load /tmp/sw.conf&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</p>
<h1 class="mume-header" id="%E6%80%BB%E7%BB%93">&#x603B;&#x7ED3;</h1>

<p>&#x867D;&#x7136;VLAN&#x7684;&#x811A;&#x672C;&#x597D;&#x50CF;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x4F46;&#x5176;&#x5B9E;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x914D;&#x7F6E;switch&#x548C;brctl&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;&#x56E0;&#x4E3A;&#x811A;&#x672C;&#x4E2D;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x6765;&#x914D;&#x7F6E;/tmp/sw.conf&#x548C;bridge&#x3002;</p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://marshallgong.top/1970/01/01/rt-dev/vlan_structure%20_v0.2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marshall's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/1970/01/01/rt-dev/vlan_structure%20_v0.2/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="1970-01-01T08:00:00+08:00">
                1970-01-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/1970/01/01/rt-dev/vlan_structure%20_v0.2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/1970/01/01/rt-dev/vlan_structure%20_v0.2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!DOCTYPE html><html><head>
      <title>vlan_structure _v0.2</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\yuanshuai.gong\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.21\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div align="center"><font size="70">VLAN STRUCTURE</font></div>
<div align="center"><font size="5">Yuanshuai.Gong</font></div>
<div style="page-break-after:always;"></div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<ul>
<li><a href="#1-%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E7%BB%93%E6%9E%84">1 &#x8DEF;&#x7531;&#x5668;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;</a>
<ul>
<li><a href="#11-xr500%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84">1.1 XR500&#x4E2D;&#x7684;&#x7ED3;&#x6784;</a></li>
<li><a href="#12-orbi%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84">1.2 Orbi&#x4E2D;&#x7684;&#x7ED3;&#x6784;</a></li>
</ul>
</li>
<li><a href="#2-wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2 WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</a>
<ul>
<li><a href="#21-xr500%E7%9A%84wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2.1 XR500&#x7684;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</a></li>
<li><a href="#22-orbi%E4%B8%ADwan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2.2 Orbi&#x4E2D;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</a></li>
</ul>
</li>
<li><a href="#3-vlan">3 VLAN</a>
<ul>
<li><a href="#31-xr500-vlan">3.1 XR500 VLAN</a></li>
<li><a href="#32-orbi-vlan">3.2 ORBI VLAN</a></li>
</ul>
</li>
<li><a href="#4-%E6%94%B9%E5%8F%98wan%E5%8F%A3">4 &#x6539;&#x53D8;WAN&#x53E3;</a>
<ul>
<li><a href="#41-xr500%E6%94%B9%E5%8F%98wan%E5%8F%A3">4.1 XR500&#x6539;&#x53D8;WAN&#x53E3;</a></li>
<li><a href="#42-orbi%E6%94%B9%E5%8F%98wan%E5%8F%A3">4.2 Orbi&#x6539;&#x53D8;WAN&#x53E3;</a></li>
</ul>
</li>
<li><a href="#5-%E7%94%A8%E6%88%B7%E4%B8%8Eswitch%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B">5 &#x7528;&#x6237;&#x4E0E;switch&#x4EA4;&#x4E92;&#x8FC7;&#x7A0B;</a>
<ul>
<li><a href="#51-swconfig">5.1 swconfig</a></li>
<li><a href="#52-ssdk_sh">5.2 ssdk_sh</a></li>
</ul>
</li>
<li><a href="#6-%E6%80%BB%E7%BB%93">6 &#x603B;&#x7ED3;</a><br>
- <a href="#"></a></li>
</ul>
<h1 class="mume-header" id="1-%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E7%BB%93%E6%9E%84">1 &#x8DEF;&#x7531;&#x5668;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;</h1>

<h2 class="mume-header" id="11-xr500%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84">1.1 XR500&#x4E2D;&#x7684;&#x7ED3;&#x6784;</h2>

<p>&#x5BF9;&#x4E8E;&#x50CF;XR500&#x4E2D;&#x7684;&#x53EA;&#x6709;&#x4E00;&#x4E2A;switch, CPU&#x4E0E;switch&#x7684;&#x8FDE;&#x63A5;&#x793A;&#x610F;&#x56FE;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/switch_to_cpu_structure_xr500.png" alt="switch2cpu"></p>
<p>&#x672C;&#x6587;&#x6863;&#x4E2D;&#x6240;&#x6709;XR500&#x7684;&#x4E3E;&#x4F8B;&#x90FD;&#x662F;&#x57FA;&#x4E8E;V2.3.2.122</p>
<p>&#x5728;console&#x4E2D;&#x8F93;&#x5165;&#x201C;swconfig dev switch0 show&#x201D;, &#x53EF;&#x4EE5;&#x770B;&#x5230;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 5</p>
</blockquote>
<p>&#x62FF;&#x5230;&#x4E00;&#x4E2A;&#x8DEF;&#x7531;&#x5668;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B83;&#x6709;5&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x8FD9;5&#x4E2A;&#x7AEF;&#x53E3;&#x4ECE;WAN&#x53E3;&#x5F00;&#x59CB;&#x5728;switch&#x4E2D;&#x5206;&#x522B;&#x7531;&#x2018;5&#x2019;&#xFF0C;&#x2018;4&#x2019;&#xFF0C;&#x2018;3&#x2019;&#xFF0C;&#x2018;2&#x2019;&#xFF0C;&#x2018;1&#x2019;&#x4EE3;&#x8868;&#x3002;&#x5176;&#x5B9E;&#x5B83;&#x8FD8;&#x6709;&#x4E24;&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x7AEF;&#x53E3;&#x8FDE;&#x63A5;Linux&#x7CFB;&#x7EDF;&#x7684;eth0&#x548C;eth1.</p>
<p>switch&#x9664;&#x5F00;VLAN&#x529F;&#x80FD;&#x5916;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5177;&#x6709;&#x8BB0;&#x5FC6;&#x529F;&#x80FD;&#x7684;HUB&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5728;XR500&#x7B49;&#x8DEF;&#x7531;&#x5668;&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x4E0D;&#x5BF9;switch&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x5B83;&#x662F;&#x4E0D;&#x5206;WAN&#x548C;LAN&#x7684;&#xFF0C;&#x5B83;&#x90FD;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x5185;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x7684;VLAN1&#x548C;VLAN2&#x662F;&#x5BF9;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;&#x3002;vlan 1, &#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;&#x662F;&#x5C06;1 2 3 4 6&#x5212;&#x5206;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x800C;vlan 2 &#x662F;&#x5C06;&#x7AEF;&#x53E3; 0 &#x548C; 5&#x5212;&#x5206;&#x5230;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x6570;&#x5B57;&#x540E;&#x6CA1;&#x6709;&#x5E26;t, &#x4E5F;&#x5C31;&#x662F;&#x4E0D;&#x5E26;tag&#x3002;&#x5BF9;&#x4E8E;&#x6CA1;&#x6709;&#x5E26;tag&#x7684;&#x7AEF;&#x53E3;&#x5B83;&#x53EA;&#x80FD;&#x5212;&#x5206;&#x5230;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x4E2D;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x50CF;&#x5E26;tag&#x65F6;&#x7684;&#x7AEF;&#x53E3;&#x53EF;&#x4EE5;&#x6839;&#x636E;tag&#x7684;vid&#x6765;&#x5904;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x5C40;&#x57DF;&#x7F51;&#x3002;&#x4F8B;&#x5982;&#xFF1A;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 1 5</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x5C06;&#x7AEF;&#x53E3;1&#xFF08;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8DEF;&#x7531;&#x5668;&#x4E0A;&#x6807;&#x8BC6;&#x7684;&#x7AEF;&#x53E3;4&#xFF09;&#x540C;&#x65F6;&#x8BBE;&#x7F6E;&#x5E26;VLAN 1&#x548C;VLAN 2&#x3002;&#x6D4B;&#x8BD5;&#x4F1A;&#x53D1;&#x73B0;&#x7AEF;&#x53E3;1&#x53EA;&#x80FD;&#x62FF;&#x5230;VLAN 2&#x4E2D;dhcp&#x5206;&#x914D;&#x7684;IP &#x5730;&#x5740;&#xFF0C;&#x5373;&#x4F7F;WAN&#x6CA1;&#x6709;&#x4EFB;&#x4F55;dhcp server, &#x7AEF;&#x53E3;1&#x4E5F;&#x4E0D;&#x4F1A;&#x4ECE;LAN&#x7AEF;&#x83B7;&#x53D6;IP&#x5730;&#x5740;&#x3002;&#x56E0;&#x4E3A;swconfig&#x662F;&#x5148;&#x628A;&#x7AEF;&#x53E3;1&#x5212;&#x5206;&#x5230;VLAN 1&#xFF0C;&#x63A5;&#x7740;&#x53C8;&#x628A;&#x7AEF;&#x53E3;1&#x5212;&#x5206;&#x5230;VLAN 2&#xFF0C;&#x6700;&#x7EC8;&#x7AEF;&#x53E3;1&#x53EA;&#x5728;&#x6700;&#x540E;&#x8BBE;&#x7F6E;&#x7684;VLAN2&#x4E2D;&#x6709;&#x6548;&#x3002;</p>
<h2 class="mume-header" id="12-orbi%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84">1.2 Orbi&#x4E2D;&#x7684;&#x7ED3;&#x6784;</h2>

<p>&#x4EE5;MINI&#x4E3E;&#x4F8B;&#xFF08;&#x4EE5;&#x4E0B;&#x90FD;&#x662F;&#x57FA;&#x4E8E;V2.3.7.22&#xFF09;</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/switch_to_cpu_structure_orbi.png" alt="switch_to_cpu_structure_orbi"></p>
<p>&#x5982;&#x4E0A;&#x56FE;&#x6240;&#x793A;&#xFF0C;mini&#x4E2D;&#x7684;switch&#x4E0E;CPU&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x76F8;&#x8FDE;&#xFF0C;switch&#x53D1;&#x9001;&#x7ED9;CPU&#x7684;&#x5305;&#x4F1A;&#x5E26;&#x6709;port_id,CPU&#x4F1A;&#x6839;&#x636E;port_id&#x6765;&#x533A;&#x5206;&#x8BE5;&#x5305;&#x662F;&#x8D70;eth0&#x8FD8;&#x662F;&#x8D70;eth1&#x3002;</p>
<p>&#x5728;essedma/edma_axi.c&#x4E2D;&#x7684;edma_axi_probe&#x51FD;&#x6570;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5C06;&#x7AEF;&#x53E3;ID&#x586B;&#x5145;&#x5230;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x67E5;&#x627E;&#x8868;&#xFF08;portid_netdev_lookup_tbl&#xFF09;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x5173;&#x4E8E;edma&#x7684;&#x8BBE;&#x5907;&#x6811;(linux-version/arch/boot/dts/qcom-ipq40xx.dtsi)&#x7684;&#x4E2D;&#x5173;&#x4E8E;eth0&#x548C;eth1&#x7684;vlan_tag&#x5206;&#x522B;&#x4E3A;0x02&#x548C;0x3c&#x3002;&#x90A3;&#x4E48;0x02 -&gt; 00000010 -&gt; port1&#x4F1A;&#x5728;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x67E5;&#x627E;&#x8868;&#x4E2D;&#x5BF9;&#x5E94;eth0,&#x800C;0x3c -&gt; 00111100 -&gt; port2, port3, port4, port5&#x4F1A;&#x5728;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x67E5;&#x627E;&#x8868;&#x5BF9;&#x5E94;eth1&#x3002;&#x8FD9;&#x91CC;switch&#x7684;port5&#x5E76;&#x6CA1;&#x6709;&#x63A5;&#x51FA;&#x6765;&#x3002;</p>
<p>&#x5728;essdma/edma.c&#x4E2D;&#x7684;edma_rx_complete&#x4F1A;&#x6839;&#x636E;switch&#x4E2D;&#x4F20;&#x5165;&#x7684;port_id&#x6765;&#x67E5;&#x8BE2;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x67E5;&#x627E;&#x8868;&#x6765;&#x627E;&#x5230;&#x8BE5;port_id&#x5BF9;&#x5E94;&#x7684;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x5373;eth0&#x6216;eth1&#x3002;</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/mini_dts" alt="qcom-ipq40xx.dtsi"></p>
<p>ssdk_sh vlan entry show</p>
<blockquote>
<p>root@RBR40:/# ssdk_sh vlan entry show</p>
<p>SSDK Init OK!<br>
[vid]:1     [fid]:1      [member]:0x1d<br>
[tagged_member]:0x0     [untagged_member]:0x1d    [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:2     [fid]:2      [member]:0x3<br>
[tagged_member]:0x0     [untagged_member]:0x3     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>total 2 entries</p>
<p>operate done.</p>
</blockquote>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 0 2 3 4<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 1</p>
</blockquote>
<p>&#x5BF9;&#x6BD4;&#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x6765;&#x770B;&#xFF1A;</p>
<p>VLAN1: member:0x1d ports:0 2 3 4</p>
<p>VLAN2: meber:0x3 ports: 0 1</p>
<p>0xld-&gt; 00011101   0x3-&gt;00000011</p>
<p>&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#xFF1A;</p>
<p>bit 0 -&gt; port0; bit 1 -&gt; port1; bit 2 -&gt; port2; bit 3 -&gt; port3; bit 4 -&gt; port4;</p>
<p>&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;0x1d&#x5176;&#x5B9E;&#x662F;&#x8BBE;&#x7F6E;&#x7684;port0, port2, port3, port4&#x4E3A;&#x4E00;&#x4E2A;VLAN&#x3002;&#x800C; port0&#x548C;port1&#x4E3A;&#x4E00;&#x4E2A;VLAN&#x3002;</p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;WAN&#x548C;LAN&#x4E24;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x90FD;&#x5305;&#x62EC;&#x7AEF;&#x53E3;0&#xFF0C;&#x8FD9;&#x4E2A;switch&#x53EA;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x8FDE;&#x63A5;CPU&#x3002;&#x5728;&#x786C;&#x4EF6;&#x4E0A;&#x5C11;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x8F6F;&#x4EF6;&#x4E0A;&#x6765;&#x5BF9;&#x4E0D;&#x540C;&#x7684;&#x5C40;&#x57DF;&#x7F51;&#x8FDB;&#x884C;&#x533A;&#x5206;&#x3002;</p>
<h1 class="mume-header" id="2-wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2 WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</h1>

<h2 class="mume-header" id="21-xr500%E7%9A%84wan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2.1 XR500&#x7684;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</h2>

<p>&#x5728;&#x7B2C;1&#x7AE0;&#x8BF4;&#x7684;&#x662F;switch&#x4E2D;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;&#xFF0C;&#x4F46;&#x5176;&#x5B9E;Linux&#x7CFB;&#x7EDF;&#x8FD8;&#x4E0D;&#x77E5;&#x9053;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x8FDB;&#x884C;&#x7684;&#x662F;&#x5982;&#x4E0B;&#x7684;&#x8BBE;&#x7F6E;</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">ifconfig</span> eth1 hw ether lanmac
<span class="token function">ifconfig</span> eth0 hw ether wanmac
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev eth1 name ethlan
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev eth0 name ethwan
brctl addif br0 ethlan
<span class="token function">ifconfig</span> br0 hw ether lanmac
brctrl addif brwan ethwan
sw_configvlan <span class="token string">&quot;normal&quot;</span>
</pre><p>&#x7B2C;3,4&#x884C;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x6539;&#x540D;&#x64CD;&#x4F5C;&#xFF0C;&#x76F4;&#x63A5;&#x628A;eth1&#x6539;&#x540D;&#x4E3A;ethlan,&#x628A;eth0&#x6539;&#x540D;&#x4E3A;ethwan&#x3002;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5728;&#x8FD9;&#x4E24;&#x6761;&#x6307;&#x4EE4;&#x8FD0;&#x884C;&#x540E;&#x627E;&#x4E0D;&#x5230;eth0&#x548C;eth1&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x5DF2;&#x7ECF;&#x88AB;ethwan&#x548C;ethlan&#x66FF;&#x4EE3;&#x4E86;&#x3002;</p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5F53;&#x6CA1;&#x6709;vlan&#x7684;&#x65F6;&#x5019;ethwan&#x5C31;&#x76F8;&#x5F53;&#x4E8E;eth0,  ethlan&#x5C31;&#x76F8;&#x5F53;&#x4E8E;eth1&#x3002;&#x540E;&#x7EED;&#x7684;net-wan&#x548C;net-lan&#x5BF9;&#x53EA;&#x662F;&#x5BF9;ethwan, ethlan&#x6216;br0, brwan&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;</p>
<h2 class="mume-header" id="22-orbi%E4%B8%ADwan%E5%92%8Clan%E7%9A%84%E5%88%92%E5%88%86">2.2 Orbi&#x4E2D;WAN&#x548C;LAN&#x7684;&#x5212;&#x5206;</h2>

<p>&#x5BF9;&#x4E8E;Orbi&#x4E2D;WAN&#x53E3;&#x548C;LAN&#x53E3;&#x7684;&#x5212;&#x5206;&#x5176;&#x5B9E;&#x662F;&#x5206;&#x4E3A;&#x4E24;&#x6B65;&#xFF0C;&#x2460;edma&#x5728;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x6839;&#x636E;&#x8BBE;&#x5907;&#x6811;&#x4E2D;&#x7684;&#x4FE1;&#x606F;&#x6765;&#x8BBE;&#x7F6E;&#xFF0C;&#x54EA;&#x4E9B;&#x7AEF;&#x53E3;&#x8D70;eth0,&#x54EA;&#x4E9B;&#x7AEF;&#x53E3;&#x8D70;eth1&#x3002;&#x2461;swconfig &#x914D;&#x7F6E;WAN&#x5C40;&#x57DF;&#x7F51;&#x548C;LAN&#x5C40;&#x57DF;&#x7F51;&#x3002;</p>
<ol>
<li>&#x6839;&#x636E;1.2&#x4E2D;qcom-ipq40xx.dtsi&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;switch&#x7684;&#x7AEF;&#x53E3;1&#x8D70;eth0&#xFF0C;&#x7AEF;&#x53E3;2&#xFF0C;3&#xFF0C;4&#xFF0C;5&#xFF08;Mini&#x4E2D;&#x6CA1;&#x6709;&#x7AEF;&#x53E3;5&#xFF09;&#x8D70;eth1.</li>
<li>&#x6839;&#x636E;1.2&#x5C0F;&#x8282;&#x4E2D;swconfig dev switch0 show&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;switch&#x4E2D;&#x662F;&#x5C06;&#x7AEF;&#x53E3;1&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x7AEF;&#x53E3;2&#xFF0C;3,4&#x4F5C;&#x4E3A;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x3002;&#x518D;&#x7ED3;&#x5408;1&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x7AEF;&#x53E3;1&#x4E3A;WAN&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x7AEF;&#x53E3;2,3,4&#x4E3A;LAN&#x5C40;&#x57DF;&#x7F51;&#x3002;</li>
</ol>
<h1 class="mume-header" id="3-vlan">3 VLAN</h1>

<h2 class="mume-header" id="31-xr500-vlan">3.1 XR500 VLAN</h2>

<p>&#x5C06;XR500&#x7684;VLAN&#x8BBE;&#x7F6E;&#x6210;&#x4E0B;&#x6240;&#x793A;(5Gwifi&#x6DFB;&#x52A0;&#x5230;VLAN 20)&#xFF1A;</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/vlan_gui_setting" alt="XR500_VLAN"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>VLAN ID</th>
<th>Ports</th>
</tr>
</thead>
<tbody>
<tr>
<td>Internet</td>
<td>10</td>
<td>1 3 4,  2.4g</td>
</tr>
<tr>
<td>test</td>
<td>20</td>
<td>2, 5g</td>
</tr>
</tbody>
</table>
<p>swconfig dev switch0 show</p>
<blockquote>
<p>VLAN 1:<br>
vid: 20<br>
ports: 0t 2 5t 6t<br>
VLAN 2:<br>
vid: 10<br>
ports: 0t 5t<br>
VLAN 3:<br>
vid: 1<br>
ports: 1 3 4 6</p>
</blockquote>
<p>cat /tmp/sw.conf</p>
<blockquote>
<p>root@XR500:/# cat /tmp/sw.conf<br>
config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;20&apos;<br>
option ports &apos;0t 5t 6t 2&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;10&apos;<br>
option ports &apos;0t 5t&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;3&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;6 1 3 4&apos;</p>
</blockquote>
<p>brctl show</p>
<blockquote>
<p>bridge name     bridge id               STP enabled     interfaces<br>
br0             8000.8c3bad10a33a       no              ath1<br>
ethlan<br>
tap0<br>
br20            8000.8c3bad10a33b       yes             ath0<br>
eth0.20<br>
ethlan.20<br>
brwan           8000.8c3bad10a33b       no              ethwan</p>
</blockquote>
<ol>
<li>
<p>VLAN 1 vid : 20, ports: 0t, 2, 5t, 6t&#x3002;</p>
<p>&#x2018;t&#x2019;&#x6307;&#x7F51;&#x7EDC;&#x5305;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8BE5;&#x5305;&#x5FC5;&#x987B;&#x5E26;20&#x7684;tag&#xFF0C;&#x4F46;&#x8FDB;&#x6765;&#x540E;&#x4F1A;&#x88AB;&#x5265;&#x79BB;&#xFF0C;&#x4F46;&#x51FA;&#x53BB;&#x7684;&#x65F6;&#x5019;&#x53C8;&#x4F1A;&#x91CD;&#x65B0;&#x6253;&#x4E0A;&#x8BE5;tag&#x3002;&#x4E5F;&#x5C31;&#x662F; 0&#xFF0C;5&#xFF0C;6&#x8FDB;&#x6765;&#x524D;&#x6216;&#x51FA;&#x53BB;&#x540E;&#x7684;&#x5305;&#x90FD;&#x5FC5;&#x987B;&#x5E26;tag&#x3002;&#x8FD9;&#x4E5F;&#x5C31;&#x662F;brctl show&#x4E2D;&#x663E;&#x793A;&#x7684;eth0.20(5), ethlan.20(6)&#x3002;&#x8FD9;&#x91CC;&#x7684;ethlan&#x5176;&#x5B9E;&#x5C31;&#x662F;eth1, &#x4F46;ethwan&#x5E76;&#x4E0D;&#x7B49;&#x4E8E;eth0&#x3002;switch&#x5185;&#x90E8;&#x5DF2;&#x7ECF;&#x5C06;0.20&#xFF0C; 2&#xFF0C; 5.20&#xFF0C; 6.20&#x914D;&#x7F6E;&#x6210;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x4E86;&#x3002;5.20 &#x5373;&#x4E3A; eth0.20, &#x800C;6.20&#x7B49;&#x4E8E;ethlan.20(&#x4F46;&#x5728;&#x6B64;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x6267;&#x884C;&#x201C;ip link set dev eth1 name ethlan&#x201D;).</p>
<p>&#x8FD9;&#x91CC;WAN&#x53E3;&#x8FDE;&#x63A5;&#x7684;&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x8981;&#x643A;&#x5E26;VID 20&#x7684;tag&#xFF0C;&#x67D0;&#x4E2A;&#x8BBE;&#x5907;&#x8FDE;&#x63A5;&#x5230;&#x8DEF;&#x7531;&#x5668;LAN&#x53E3;&#x7684;Port3(&#x5BF9;&#x5E94;&#x7684;&#x5E94;&#x8BE5;&#x662F;switch port2),&#x6570;&#x636E;&#x53EF;&#x4EE5;&#x4E0D;&#x9700;&#x8981;&#x643A;&#x5E26;&#x4EFB;&#x4F55;tag&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;LAN&#x7AEF;&#x8BBE;&#x5907;&#x548C;WAN&#x8FDE;&#x63A5;&#x7684;&#x7F51;&#x7EDC;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x901A;&#x4FE1;&#x3002;&#x5728;switch&#x4E2D;&#xFF0C;&#x6570;&#x636E;&#x53EF;&#x80FD;&#x662F;&#x76F4;&#x63A5;&#x4ECE;&#x7AEF;&#x53E3;5&#xFF08;&#x8FDB;&#x5165;&#x524D;&#x548C;&#x8FDB;&#x5165;&#x540E;&#x5E26;tag20&#xFF09;&#x5230;&#x7AEF;&#x53E3;2&#xFF08;&#x8FDB;&#x5165;&#x524D;&#x548C;&#x51FA;&#x53BB;&#x540E;&#x4E0D;&#x5E26;tag&#xFF09;,&#x4E0D;&#x4F1A;&#x7ECF;&#x8FC7;switch&#x7AEF;&#x53E3;0&#x548C;&#x7AEF;&#x53E3;6.</p>
<p>&#x800C;&#x5BF9;&#x4E8E;WIFI 5G&#xFF08;ath0&#xFF09;&#x65E0;&#x8BBA;&#x662F;&#x4E0E;WAN&#x53E3;&#x8FD8;&#x662F;&#x4E0E;Port3(&#x5BF9;&#x5E94;&#x7684;&#x5E94;&#x8BE5;&#x662F;switch port2)&#x901A;&#x4FE1;&#x5219;&#x4E0D;&#x4F1A;&#x5728;switch&#x4E2D;&#x8FDB;&#x884C;&#x4EA4;&#x6362;&#x6570;&#x636E;&#x3002;&#x4ECE;brctrl show&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;ath0&#x662F;&#x4E0E;ethlan.20&#x548C;eth0.20&#x914D;&#x7F6E;&#x5728;&#x540C;&#x4E00;&#x7F51;&#x6865;&#xFF0C;&#x90A3;&#x4E48;WAN&#x53E3;&#x6216;Port3(&#x5BF9;&#x5E94;&#x7684;&#x5E94;&#x8BE5;&#x662F;switch port2)&#x8981;&#x4E0E;ath0&#x901A;&#x4FE1;&#x5219;&#x8981;&#x7ECF;&#x8FC7;switch&#x7AEF;&#x53E3;0&#x548C;&#x7AEF;&#x53E3;6&#x3002;</p>
</li>
<li>
<p>VLAN 2 vid: 10, ports: 0t, 5t</p>
<p>switch&#x5C06;0.10&#x548C;5.10&#x914D;&#x7F6E;&#x6210;&#x540C;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5728;brctl show&#x4E2D;&#x6CA1;&#x6709;eth0.10&#x4E4B;&#x7C7B;&#x7684;&#x3002;&#x662F;&#x56E0;&#x4E3A;Internet VLAN&#x6267;&#x884C;&#x7684;&#x662F;&#x201C;ip link set dev eth0.10 name ethwan&#x201D;, &#x4E5F;&#x5C31;&#x662F;&#x5C06;eth0.10&#x4F5C;&#x4E3A;ethwan&#x3002;&#x76EE;&#x524D;switch&#x7684;0&#x7AEF;&#x53E3;&#x4F5C;&#x4E3A;WAN&#x53E3;&#x7684;&#x7269;&#x7406;&#x63A5;&#x53E3;&#xFF0C;&#x53EA;&#x6709;&#x5E26;tag 10&#x7684;&#x5305;&#x8FDB;&#x6765;&#x5B83;&#x624D;&#x80FD;&#x663E;&#x793A;&#x4E3A;&#x201C;&#x6709;&#x7F51;&#x201D;&#x3002;</p>
</li>
<li>
<p>VLAN 3 vid: 1 ports: 1 3 4 6</p>
<p>LAN&#x7AEF;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x548C;&#x9ED8;&#x8BA4;&#x4E00;&#x6837;&#x3002;</p>
</li>
</ol>
<h2 class="mume-header" id="32-orbi-vlan">3.2 ORBI VLAN</h2>

<p>Orbi&#x4E2D;&#x9664;&#x4E86;VLAN mode&#x90FD;&#x662F;&#x4F7F;&#x7528;swconfig&#x914D;&#x7F6E;&#x7684;&#x3002;&#x5BF9;&#x4E8E;vlan mode&#xFF0C;<a target="_blank" rel="noopener" href="http://xn--ssdk-9s6fs51jw5v.sh">&#x662F;&#x4F7F;&#x7528;ssdk.sh</a>&#x3002;</p>
<ol>
<li>VLAN&#x7684;&#x914D;&#x7F6E;&#x5982;&#x4E0B;</li>
</ol>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/mini_vlan_config" alt="mini_vlan_config"></p>
<ol start="2">
<li>vlan&#x5B9E;&#x9645;&#x7684;&#x8BBE;&#x7F6E;</li>
</ol>
<blockquote>
<p>root@RBR40:/# cat /tmp/ssdk.sh<br>
/usr/sbin/ssdk_sh vlan entry flush<br>
/usr/sbin/ssdk_sh vlan entry create 20<br>
/usr/sbin/ssdk_sh vlan entry append 20 20 0,1 0,1 null null no no<br>
/usr/sbin/ssdk_sh vlan entry create 4075<br>
/usr/sbin/ssdk_sh vlan member add 4075 0 tagged<br>
/usr/sbin/ssdk_sh vlan member add 4075 2 untagged<br>
/usr/sbin/ssdk_sh portvlan defaultcvid set 2 4075<br>
/usr/sbin/ssdk_sh qos ptDefaultCpri set 2 0<br>
/usr/sbin/ssdk_sh vlan entry create 1<br>
/usr/sbin/ssdk_sh vlan member add 1 0 tagged<br>
/usr/sbin/ssdk_sh vlan member add 1 3 untagged<br>
/usr/sbin/ssdk_sh vlan member add 1 4 untagged<br>
/usr/sbin/ssdk_sh portvlan defaultcvid set 3 1<br>
/usr/sbin/ssdk_sh portvlan defaultcvid set 4 1<br>
/usr/sbin/ssdk_sh qos ptDefaultCpri set 3 0<br>
/usr/sbin/ssdk_sh qos ptDefaultCpri set 4 0<br>
/usr/sbin/ssdk_sh vlan entry create 10<br>
/usr/sbin/ssdk_sh vlan entry append 10 10 0,1 0,1 null null no no<br>
/usr/sbin/ssdk_sh misc cpuvid set enable</p>
</blockquote>
<blockquote>
<p>root@RBR40:/# brctl show<br>
bridge name     bridge id               STP enabled     interfaces<br>
br0             8000.201407112a30       no              ath0<br>
ath01<br>
ath02<br>
ath1<br>
ath2<br>
ath21<br>
eth1<br>
br20            8000.201407112a31       yes             eth0.20<br>
eth1.4075<br>
brwan           8000.8c3bad193029       no              eth0.10</p>
</blockquote>
<blockquote>
<p>#flush all VLAN entries</p>
<p>/usr/sbin/ssdk_sh vlan entry flush</p>
<p>#create a VLAN entry 20</p>
<p>/usr/sbin/ssdk_sh vlan entry create 20</p>
<p>#append a VLAN entry</p>
<p>/usr/sbin/ssdk_sh vlan entry append 20 20 0,1 0,1 null null no no</p>
<p>#create a VLAN entry 4075</p>
<p>/usr/sbin/ssdk_sh vlan entry create 4075</p>
<p>#add member 0 to entry 4075 with tag</p>
<p>/usr/sbin/ssdk_sh vlan member add 4075 0 tagged</p>
<p>#add member 2 to entry 4075 to entry 4075 without tag</p>
<p>/usr/sbin/ssdk_sh vlan member add 4075 2 untagged</p>
<p>#set default VLAN id 4075 of port 2</p>
<p>/usr/sbin/ssdk_sh portvlan defaultcvid set 2 4075</p>
<p>#set default ctag priority for received frames of a port &quot;&lt;port_id&gt; <a href="cpri:0-7">cpri:0-7</a>&quot;</p>
<p>/usr/sbin/ssdk_sh qos ptDefaultCpri set 2 0</p>
<p>#create vlan entry 1</p>
<p>/usr/sbin/ssdk_sh vlan entry create 1</p>
<p>#add vlan member 0, 3, 4 to vlan entry 1</p>
<p>/usr/sbin/ssdk_sh vlan member add 1 0 tagged<br>
/usr/sbin/ssdk_sh vlan member add 1 3 untagged<br>
/usr/sbin/ssdk_sh vlan member add 1 4 untagged</p>
<p>#set default VLAN id 1 of port 3 and port 4</p>
<p>/usr/sbin/ssdk_sh portvlan defaultcvid set 3 1<br>
/usr/sbin/ssdk_sh portvlan defaultcvid set 4 1</p>
<p>#set default 0 priority for received frames of port 3 and port 4</p>
<p>/usr/sbin/ssdk_sh qos ptDefaultCpri set 3 0<br>
/usr/sbin/ssdk_sh qos ptDefaultCpri set 4 0</p>
<p>#create vlan entry 10</p>
<p>/usr/sbin/ssdk_sh vlan entry create 10</p>
<p>#append a vlan entry</p>
<p>/usr/sbin/ssdk_sh vlan entry append 10 10 0,1 0,1 null null no no</p>
<p>#set to cpu vid status &lt;enable|disable&gt;</p>
<p>/usr/sbin/ssdk_sh misc cpuvid set enable</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;&#x7528;ssdk_sh&#x914D;&#x7F6E;switch&#x7684;&#x547D;&#x4EE4;&#x7684;&#x6D41;&#x7A0B;&#xFF1A;</p>
<ol>
<li>&#x6E05;&#x7A7A;vlan entry&#x3002;</li>
<li>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;vlan entry&#x5373;vlan ID&#x3002;</li>
<li>&#x9644;&#x52A0;vlan entry,&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x6DFB;&#x52A0;&#x5E26;tag&#x7684;&#x7AEF;&#x53E3;&#x548C;&#x8BBE;&#x7F6E;&#x8BE5;entry&#x7684;&#x4E00;&#x4E9B;&#x529F;&#x80FD;&#x3002;&#x4E00;&#x822C;&#x6267;&#x884C;&#x4E86;&#x8FD9;&#x4E00;&#x6B65;&#x5C31;&#x4E0D;&#x7528;&#x6267;&#x884C;&#x7B2C;4&#x6B65;&#x3002;</li>
<li>&#x4E3A;vlan entry&#x6DFB;&#x52A0;&#x5B83;&#x7684;&#x6210;&#x5458;&#x7AEF;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x5E26;tag&#x4E5F;&#x53EF;&#x4EE5;&#x4E0D;&#x5E26;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x4E0D;&#x5E26;tag&#x7684;&#x7AEF;&#x53E3;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x8FDB;&#x6765;&#x7684;&#x5305;&#x6253;&#x4E0A;&#x9ED8;&#x8BA4;&#x7684;tag&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x4E0D;&#x5E26;tag&#x7684;&#x7AEF;&#x53E3;&#x8FD8;&#x9700;&#x8981;&#x8BBE;&#x7F6E;qos&#x4F18;&#x5148;&#x7EA7;&#x3002;</li>
<li>&#x6700;&#x540E;&#x8BBE;&#x7F6E;cpu vid&#x72B6;&#x6001;&#x4F7F;&#x80FD;&#x3002;</li>
</ol>
<p>&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x6307;&#x4EE4;&#x624B;&#x518C;&#xFF0C;&#x5173;&#x4E8E;&#x4E00;&#x4E9B;&#x6307;&#x4EE4;&#x7684;&#x529F;&#x80FD;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x6765;&#x4E86;&#x89E3;&#x3002;&#x6BD4;&#x5982;vlan 10&#x5728;vlan append&#x6307;&#x4EE4;&#x6267;&#x884C;&#x540E;&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x6267;&#x884C;</p>
<p>/usr/sbin/ssdk_sh vlan member add 10 0 tagged</p>
<p>/usr/sbin/ssdk_sh vlan member add 10 1 tagged</p>
<p>&#x53EF;&#x4EE5;&#x4E00;&#x6761;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x6267;&#x884C;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;ssdk_sh vlan entry show,&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x7AEF;&#x53E3;0&#x548C;&#x7AEF;&#x53E3;1&#x7684;&#x5DF2;&#x88AB;&#x6DFB;&#x52A0;&#x5230;vlan 10&#x7684;tagged member&#x4E2D;&#x4E86;&#x3002;</p>
<blockquote>
<p>10    [fid]:10     [member]:0x3<br>
[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
</blockquote>
<p>&#x56E0;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x4E0E;CPU&#x901A;&#x4FE1;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5728;&#x8BBE;&#x7F6E;vlan 20&#x7684;&#x65F6;&#x5019;&#x5E76;&#x4E0D;&#x662F;&#x5C06;switch&#x4E2D;&#x7684;LAN&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x7AEF;&#x53E3;&#x6253;&#x4E0A;tag20,&#x800C;&#x662F;&#x6253;&#x4E0A;&#xFF08;4095-20&#xFF09;&#x3002;&#x8FD9;&#x6837;&#x505A;&#x53EF;&#x4EE5;&#x4F7F;eth0&#x5BF9;&#x5E94;&#x7684;vlan&#x7AEF;&#x53E3;&#x548C;eth1&#x4E2D;&#x5BF9;&#x5E94;&#x7684;vlan&#x7AEF;&#x53E3;&#x5FC5;&#x987B;&#x901A;&#x8FC7;CPU&#x6765;&#x901A;&#x4FE1;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x90FD;&#x914D;&#x7F6E;&#x6210;tag20&#x7684;&#x65F6;&#x5019;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7;switch&#x6765;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002;&#x901A;&#x8FC7;CPU&#x6765;&#x4EA4;&#x6362;vlan&#x53EF;&#x80FD;&#x4F1A;&#x964D;&#x4F4E;&#x901F;&#x5EA6;&#xFF0C;&#x5F53;&#x521D;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;&#x53EF;&#x80FD;&#x662F;&#x53EF;&#x4EE5;&#x7528;&#x901A;&#x8FC7;&#x9632;&#x706B;&#x5899;&#x6765;&#x7EDF;&#x4E00;&#x63A7;&#x5236;&#x7AEF;&#x53E3;&#x3002;</p>
<p>&#x4ECE;vlan&#x914D;&#x7F6E;&#x7684;&#x811A;&#x672C;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E4B;&#x524D;&#x662F;&#x901A;&#x8FC7;swconfig&#x547D;&#x4EE4;&#x6765;&#x8BBE;&#x7F6E;&#xFF0C;&#x4ECE;/tmp/sw.conf&#x4E2D;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6362;&#x6210;ssdk_sh&#x6765;&#x8BBE;&#x7F6E;&#xFF0C;&#x73B0;&#x5728;&#x4E5F;&#x4E0D;&#x5F97;&#x800C;&#x77E5;&#x3002;</p>
<blockquote>
<p>root@RBR40:/# cat /tmp/sw.conf<br>
config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;20&apos;<br>
option ports &apos;0t 1t&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;4075&apos;<br>
option ports &apos;0t 2&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;3&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;0t 3 4&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;4&apos;<br>
option vid &apos;10&apos;<br>
option ports &apos;0t 1t&apos;</p>
</blockquote>
<ol start="3">
<li>vlan&#x7AEF;&#x53E3;&#x72B6;&#x6001;&#x663E;&#x793A;</li>
</ol>
<blockquote>
<p>root@RBR40:/# ssdk_sh vlan entry show</p>
<p>SSDK Init OK!<br>
[vid]:1     [fid]:1      [member]:0x19<br>
[tagged_member]:0x1     [untagged_member]:0x18    [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:10    [fid]:10     [member]:0x3<br>
[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:20    [fid]:20     [member]:0x3<br>
[tagged_member]:0x3     [untagged_member]:0x0     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>[vid]:4075  [fid]:4075   [member]:0x5<br>
[tagged_member]:0x1     [untagged_member]:0x4     [unmodify_member]:0x0     [learn_dis]:disable  [pri_en]:disable [pri]:0x0</p>
<p>total 4 entries</p>
<p>operate done.</p>
</blockquote>
<p>swconfig dev switch0 show</p>
<blockquote>
<pre class="language-text">    vid: 1
    ports: 0 2 3 4
</pre>
<p>VLAN 2:<br>
vid: 2</p>
<p>&#x200B;        ports: 0 1</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x7684;swconfig dev switch0 show&#x5E76;&#x4E0D;&#x51C6;&#x786E;&#xFF0C;&#x5B83;&#x6240;&#x663E;&#x793A;&#x7684;&#x662F;&#x4E0A;&#x4E00;&#x6B21;&#x4E5F;&#x5C31;&#x662F;normal&#x60C5;&#x51B5;&#x4E0B;&#x4F7F;&#x7528;swconfig dev switch0 /tmp/sw.conf&#x7684;&#x4FE1;&#x606F;&#x3002;&#x4F46;ssdk_sh&#x663E;&#x793A;&#x7684;&#x4FE1;&#x606F;&#x662F;&#x6B63;&#x786E;&#x7684;&#xFF0C;&#x5173;&#x4E8E;swconfig&#x548C;ssdk_sh&#x7684;&#x533A;&#x522B;&#x53EF;&#x4EE5;&#x770B;&#x7B2C;5&#x7AE0;&#x3002;</p>
<h1 class="mume-header" id="4-%E6%94%B9%E5%8F%98wan%E5%8F%A3">4 &#x6539;&#x53D8;WAN&#x53E3;</h1>

<h2 class="mume-header" id="41-xr500%E6%94%B9%E5%8F%98wan%E5%8F%A3">4.1 XR500&#x6539;&#x53D8;WAN&#x53E3;</h2>

<p>&#x8DEF;&#x7531;&#x5668;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7528;&#x6237;&#x64CD;&#x4F5C;&#x5C06;WAN&#x53E3;&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x5BF9;&#x4E8E;WAN&#x53E3;&#x548C;LAN&#x53E3;&#x5728;&#x540C;&#x4E00;&#x4E2A;switch&#x4E2D;&#xFF0C;WAN&#x53E3;&#x662F;&#x53EF;&#x4EE5;&#x6539;&#x53D8;&#x3002;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;WAN&#x53E3;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x6837;&#x53EF;&#x80FD;&#x4F1A;&#x5E26;&#x6765;&#x5176;&#x5B83;&#x7684;&#x95EE;&#x9898;&#xFF08;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x591A;&#x4E2A;dhcp server&#xFF09;&#x3002;</p>
<p>&#x5148;&#x770B;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7684;switch&#xFF1A;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 2 3 4 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 5</p>
</blockquote>
<p>&#x7269;&#x7406;WAN&#x7F51;&#x7EBF;&#x76F4;&#x63A5;&#x8FDE;&#x63A5;&#x7684;&#x662F;&#x7AEF;&#x53E3;5&#xFF0C;&#x5B83;&#x5176;&#x5B9E;&#x662F;&#x4E0E;&#x7AEF;&#x53E3;0&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7F51;&#x6865;&#x6216;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x53EF;&#x4EE5;&#x628A;0&#x53E3;&#x4F5C;&#x4E3A;WAN&#x53E3;&#x3002;&#x4F46;&#x7AEF;&#x53E3;0&#x6211;&#x4EEC;&#x5E76;&#x770B;&#x4E0D;&#x5230;&#xFF0C;&#x4F46;&#x5B83;&#x662F;&#x4E0E;Linux&#x7CFB;&#x7EDF;&#x7AEF;&#x7684;eth0&#x76F8;&#x8FDE;&#x7684;, &#x56E0;&#x6B64;&#x53C8;&#x53EF;&#x4EE5;&#x628A;eth0&#x4F5C;&#x4E3A;WAN&#x53E3;&#x3002;&#x800C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x53C8;&#x901A;&#x8FC7;&#x201C;ip link set dev eth0 name ethwan&#x201D;, &#x5C06;eth0&#x6539;&#x540D;&#x4E3A;ethwan&#xFF0C;&#x7136;&#x540E;&#x518D;&#x7528;brctl addif brwan ethwan&#x5C06;ethwan&#x6DFB;&#x52A0;&#x5230;brwan&#x7F51;&#x6865;&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x6700;&#x7EC8;&#x53EF;&#x4EE5;&#x5C06;brwan&#x89C6;&#x4F5C;WAN&#x53E3;&#x3002;</p>
<p>&#x76EE;&#x6807;&#xFF1A;&#x5C06;&#x7AEF;&#x53E3;2&#xFF08;&#x8DEF;&#x7531;&#x5668;&#x58F3;&#x4E0A;&#x6807;&#x8BB0;&#x7684;&#x7AEF;&#x53E3;3&#xFF09;&#x4F5C;&#x4E3A;WAN&#x53E3;&#xFF0C;&#x5176;&#x5B83;&#x7684;&#x4F5C;&#x4E3A;LAN</p>
<p>&#x90A3;switch&#x7684;&#x663E;&#x793A;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<blockquote>
<p>VLAN 1:<br>
vid: 1<br>
ports: 1 3 4 5 6<br>
VLAN 2:<br>
vid: 2<br>
ports: 0 2</p>
</blockquote>
<p>&#x53EA;&#x9700;&#x5C06;/tmp/sw.conf&#x4E2D;&#x7684;port 2&#x548C; port 5&#x5BF9;&#x6362;&#x5373;&#x53EF;</p>
<blockquote>
<p>config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;6 1 3 4 5&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;2&apos;<br>
option ports &apos;0 2&apos;</p>
</blockquote>
<p>&#x7136;&#x540E;&#x8FD0;&#x884C;swconfig dev switch0 load /tmp/sw.conf&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</p>
<blockquote>
<p>dess vlan member update</p>
</blockquote>
<p>&#x4E5F;&#x4F1A;&#x8C03;&#x7528;&#x5230;dess vlan member update</p>
<blockquote>
<p>ssdk_sh vlan entry show</p>
<p>SSDK Init OK!switch_ioctl<br>
sw_uk_exec shell<br>
sw_uk_if shell<br>
switch_ioctl<br>
sw_uk_exec shell<br>
sw_uk_if shell<br>
switch_ioctl</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;mini&#x6539;&#x53D8;WAN&#x53E3;&#x5E76;&#x4E0D;&#x65B9;&#x4FBF;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6539;&#x53D8;&#x8BBE;&#x5907;&#x6811;&#x4E2D;eth0(gmac0)&#x548C;eth1(gmac1)&#x7684;vlan_tag&#x6765;&#x6362;WAN&#x53E3;&#x3002;</p>
<h2 class="mume-header" id="42-orbi%E6%94%B9%E5%8F%98wan%E5%8F%A3">4.2 Orbi&#x6539;&#x53D8;WAN&#x53E3;</h2>

<p>&#x6839;&#x636E;2.2&#x8282;Orbi&#x4E2D;WAN/LAN&#x7684;&#x5212;&#x5206;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>&#x76EE;&#x6807;&#x5C06;&#x7AEF;&#x53E3;4&#x8BBE;&#x7F6E;&#x4E3A;WAN&#x53E3;&#xFF0C;&#x7AEF;&#x53E3;1&#xFF0C;2&#xFF0C;3 &#x4E3A;LAN&#x53E3;</p>
<ol>
<li>
<p>eth0&#x548C;eth1&#x521D;&#x59CB;&#x5316;&#x7AEF;&#x53E3;</p>
<p>&#x7AEF;&#x53E3;4-&gt;00010000-&gt;0x10</p>
<p>&#x7AEF;&#x53E3;1,2,3(,5)-&gt;00101110-&gt;0x2e</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/change_wan_dts" alt="mini_change_wan_dts"></p>
<p>&#x8FD9;&#x6837;&#x7AEF;&#x53E3;4&#x4F1A;&#x8D70;eth0,&#x7AEF;&#x53E3;1,2,3&#x4F1A;&#x8D70;eth1</p>
</li>
<li>
<p>swconfig dev load /tmp/sw.conf</p>
<p>swconfig&#x9700;&#x8981;&#x5C06;&#x7AEF;&#x53E3;1,2,3&#x914D;&#x7F6E;&#x6210;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#xFF0C;&#x7AEF;&#x53E3;4&#x914D;&#x7F6E;&#x6210;&#x4E00;&#x4E2A;&#x5C40;&#x57DF;&#x7F51;&#x3002;</p>
<blockquote>
<p>root@RBR40:/# cat /tmp/sw.conf<br>
config switch<br>
option name &apos;switch0&apos;<br>
option reset &apos;1&apos;<br>
option enable_vlan &apos;1&apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;1&apos;<br>
option vid &apos;1&apos;<br>
option ports &apos;0 1 2 3 &apos;</p>
<p>config switch_vlan<br>
option device &apos;switch0&apos;<br>
option vlan &apos;2&apos;<br>
option vid &apos;2&apos;<br>
option ports &apos;0 4&apos;</p>
</blockquote>
</li>
</ol>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x4E24;&#x6B65;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x7AEF;&#x53E3;4&#x548C;&#x7AEF;&#x53E3;1&#x7684;&#x529F;&#x80FD;&#x4E92;&#x6362;&#xFF0C;&#x7AEF;&#x53E3;4&#x4F5C;&#x4E3A;WAN&#x53E3;&#x3002;</p>
<h1 class="mume-header" id="5-%E7%94%A8%E6%88%B7%E4%B8%8Eswitch%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B">5 &#x7528;&#x6237;&#x4E0E;switch&#x4EA4;&#x4E92;&#x8FC7;&#x7A0B;</h1>

<p>XR500&#x548C;mini&#x4E0E;switch&#x4EA4;&#x6362;&#x7684;&#x8FC7;&#x7A0B;&#x6709;&#x4E24;&#x79CD;&#xFF1A;swconfig&#x548C;ssdk_sh&#x3002;swconfig&#x901A;&#x8FC7;netlink&#x76F4;&#x63A5;&#x4E0E;&#x5185;&#x6838;&#x901A;&#x4FE1;&#x6765;&#x64CD;&#x4F5C;switch&#xFF0C;&#x800C;ssdk_sh&#x901A;&#x8FC7;&#x6253;&#x5F00;/dev/switch_ssdk&#x6765;&#x5BF9;switch&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x7684;&#x6700;&#x5E95;&#x5C42;&#x51FD;&#x6570;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x5373;dess_xxx.c(dess_vlan.c, dess_portvlan.c ...)&#x3002;</p>
<h2 class="mume-header" id="51-swconfig">5.1 swconfig</h2>

<p>&#x4EE5;&#x4E0B;&#x662F;swconfig&#x7684;&#x4E3B;&#x8981;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#xFF1A;</p>
<p>&#x200B;	swconfig module: package/network/config/swconfig</p>
<p>&#x200B;	swconfig.c: linux&#x5185;&#x6838;code/drivers/net/phy/</p>
<p>&#x200B;	qca-nss-ssdk: fal, rel, dess</p>
<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/swconfig_flow.png" alt="ssdk_flow"></p>
<p>&#x65E0;&#x8BBA;&#x662F;XR500&#x4E2D;&#x5173;&#x4E8E;swconfig&#x547D;&#x4EE4;&#x90FD;&#x662F;swconfig&#x6A21;&#x5757;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x7528;&#x5230;&#x7684;&#x662F;&#x201C;swconfig dev switch0 show&#x201D;&#x548C;&#x201C;swconfig dev switch0 load /tmp/sw.conf&#x201D;.</p>
<ol>
<li>
<p>swconfig dev switch0 load /tmp/sw.conf</p>
<ol>
<li>swconfig &#x901A;&#x8FC7;uci&#x6765;&#x89E3;&#x6790;/tmp/sw.conf,&#x7136;&#x540E;&#x4F9D;&#x6B21;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;config&#x901A;&#x8FC7;netlink&#x4E0E;&#x5185;&#x6838;&#x901A;&#x4FE1;&#x6765;&#x8BBE;&#x7F6E;switch&#x3002;&#x901A;&#x8FC7;&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x77E5;&#x9053;netlink&#x4E2D;&#x8C03;&#x7528;&#x5230;&#x7684;&#x662F;swconfig_set_vlan_ports,&#x800C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4F1A;&#x8C03;&#x7528;&#x5230;qca_ar8327_sw_hw_set_ports&#x3002;qca_ar8327_sw_hw_set_ports&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x53EA;&#x4F1A;&#x5BF9;qca_phy_priv&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x7684;&#x51E0;&#x4E2A;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x5E76;&#x4E0D;&#x4F1A;&#x4FEE;&#x6539;switch&#x3002;</li>
<li>&#x5728;&#x6240;&#x6709;&#x7684;config&#x90FD;&#x8BBE;&#x7F6E;&#x5B8C;&#x6210;&#x540E;&#xFF0C;swconfig&#x6A21;&#x5757;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x4E2A;apply&#x52A8;&#x4F5C;&#x5E76;&#x4F20;&#x9012;&#x7ED9;&#x5185;&#x6838;&#x6765;&#x628A;qca_phy_priv&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x4F20;&#x9012;&#x7ED9;switch&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x4E0A;&#x56FE;&#x8C03;&#x7528;&#x5230;fal_vlan,&#x4E0A;&#x56FE;&#x4E2D;&#x7684;fal&#x53EA;&#x662F;&#x4E00;&#x7EC4;&#x63A5;&#x53E3;&#x51FD;&#x6570;&#xFF0C;&#x771F;&#x6B63;&#x5BF9;&#x5BC4;&#x5B58;&#x5668;&#x64CD;&#x4F5C;&#x7684;&#x51FD;&#x6570;&#x662F;&#x5728;dess&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;</li>
</ol>
</li>
<li>
<p>swconfig dev switch0 show</p>
<p>show&#x547D;&#x4EE4;&#x7684;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x5982;&#x4E0A;&#x56FE;&#xFF0C;&#x5B83;&#x6700;&#x7EC8;&#x83B7;&#x53D6;&#x7684;&#x53EA;&#x662F;qca_phy_priv&#x4E2D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5B83;&#x5E76;&#x4E0D;&#x662F;&#x83B7;&#x53D6;&#x7684;switch&#x7AEF;&#x53E3;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5B83;&#x83B7;&#x53D6;&#x7684;&#x53EA;&#x662F;&#x4E0A;&#x6B21;swconfig&#x547D;&#x4EE4;&#x5BF9;switch&#x8BBE;&#x7F6E;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x5982;&#x679C;&#x8C03;&#x7528;&#x5176;&#x5B83;&#x7684;&#x547D;&#x4EE4;&#x5BF9;switch&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF0C;&#x90A3;&#x4E48;swconfig show&#x547D;&#x4EE4;&#x5C31;&#x4E0D;&#x51C6;&#x786E;&#x4E86;&#x3002;</p>
</li>
</ol>
<h2 class="mume-header" id="52-ssdk_sh">5.2 ssdk_sh</h2>

<p><img src="/1970/01/01/rt-dev/vlan_structure%20_v0.2/ssdk_flow.png" alt="ssdk_flow"></p>
<p>ssdk_sh&#x662F;&#x5728;qca-ssdk-shell_dni&#xFF0C;&#x4E0D;&#x5E26;&#x53C2;&#x6570;&#x76F4;&#x63A5;&#x8FD0;&#x884C;ssdk_sh&#x4F1A;&#x8FDB;&#x5165;&#x7528;&#x6237;&#x4EA4;&#x4E92;&#x72B6;&#x6001;&#x3002;&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;&#x7684;&#x662F;&quot;ssdk_sh vlan&quot;&#x3002;</p>
<p>&#x5728;ssdk_sh&#x7684;&#x4E3B;&#x7A0B;&#x5E8F;shell.c&#x4E2D;&#x9996;&#x5148;&#x8C03;&#x7528;&#x7684;&#x662F;cmd_init&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;&#x6253;&#x5F00;&#x201C;/dev/switch_ssdk&#x201D;&#x6A21;&#x5757;&#x5E76;&#x8FD4;&#x56DE;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x3002;&#x63A5;&#x7740;cmd_args&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#xFF0C;cmd_args&#x9996;&#x5148;&#x8C03;&#x7528;cmd_parse&#x901A;&#x8FC7;&#x4F20;&#x5165;&#x7684;&#x547D;&#x4EE4;&#x53C2;&#x6570;&#x5728;CONFIG VLAN TABLE&#x4E2D;&#x67E5;&#x627E;&#x6539;&#x547D;&#x4EE4;&#x6240;&#x5BF9;&#x5E94;&#x7684;API id&#x5E76;&#x8FD4;&#x56DE;&#x3002;cmd_exec&#x901A;&#x8FC7;&#x83B7;&#x53D6;&#x5230;&#x7684;api id&#x6765;&#x6267;&#x884C;fal_vlan&#x4E2D;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8FD9;&#x91CC;&#x7684;fal_vlan&#x548C;swconfig&#x547D;&#x4EE4;&#x6240;&#x8C03;&#x7528;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;fal_vlan&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x5927;&#x591A;&#x90FD;&#x662F;&#x5305;&#x88F9;&#x51FD;&#x6570;&#x90FD;&#x8981;&#x6267;&#x884C;sw_uk_exec&#x3002; sw_uk_exec&#x901A;&#x8FC7;ioctl&#x51FD;&#x6570;&#x4E0E;&#x4E4B;&#x524D;&#x5728;cmd_init&#x4E2D;&#x6253;&#x5F00;&#x7684;switch_ssdk&#x6A21;&#x5757;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002;ioctl&#x5BF9;&#x5E94;&#x7684;&#x4E8E;switch_ssdk&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x5176;&#x5B9E;&#x662F;switch_ioctl. switch_ioctl&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528;&#x5230;dess_vlan&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x91CC;&#x8C03;&#x7528;&#x7684;dess_vlan&#x548C;&#x4E4B;&#x524D;swconfig&#x547D;&#x4EE4;&#x6240;&#x8C03;&#x7528;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x6837;&#x7684;&#x4E86;&#x3002;</p>
<h1 class="mume-header" id="6-%E6%80%BB%E7%BB%93">6 &#x603B;&#x7ED3;</h1>

<p>&#x867D;&#x7136;VLAN&#x7684;&#x811A;&#x672C;&#x597D;&#x50CF;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x4F46;&#x5176;&#x5B9E;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x914D;&#x7F6E;switch&#x548C;brctl&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;&#x56E0;&#x4E3A;&#x811A;&#x672C;&#x4E2D;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x6765;&#x914D;&#x7F6E;/tmp/sw.conf&#x548C;bridge&#x3002;</p>
<p>swconfig&#x548C;ssdk_sh&#x867D;&#x7136;&#x64CD;&#x4F5C;&#x6307;&#x4EE4;&#x4E0D;&#x540C;&#xFF0C;&#x6700;&#x7EC8;&#x64CD;&#x4F5C;switch&#x7684;&#x51FD;&#x6570;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h6 class="mume-header" id></h6>


      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=584155&auto=1&height=66"></iframe>
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Marshall Gong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'SR9mgYzPMsyrXs9qiUEy911k-MdYXbMMI',
        appKey: 'uO19Jt473Js5a1dIaSsMvDzj',
        placeholder: '有什么问题，欢迎留言指正与交流',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小桃心-->
<script type="text/javascript" src="/js/src/click-love.js"></script>